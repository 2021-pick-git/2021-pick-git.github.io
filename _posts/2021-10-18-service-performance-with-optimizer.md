---
layout: post
title: ì„œë¹„ìŠ¤ ì„±ëŠ¥ ê°œì„  - MySQL Optimizer ì‹¤í–‰ ê³„íš ë¶„ì„ì„ ê¸°ë°˜ìœ¼ë¡œ
date: 2021-10-18 13:00::38 +0900
description: ì‹¤í–‰ ê³„íš ë¶„ì„ì„ í†µí•´ ì„œë¹„ìŠ¤ì˜ ì„±ëŠ¥ì„ ê°œì„ í•´ë³´ì.
img: performance.jpg
tags: [ë°±ì—”ë“œ, MySQL, ElasticSearch]
---

## 1. ë“¤ì–´ê°€ë©°

ì•ˆë…•í•˜ì„¸ìš”, ì¼€ë¹ˆì…ë‹ˆë‹¤. í˜„ì¬ ìš´ì˜ ì¤‘ì¸ Pick-Git ì„œë¹„ìŠ¤ëŠ” Spring Data JPAë¥¼ í™œìš© ì¤‘ì…ë‹ˆë‹¤. ê°œë°œ ì´ˆê¸°ì—ëŠ” ì„œë¹„ìŠ¤ë¥¼ ë¹ ë¥´ê²Œ ê°œë°œí•˜ëŠ” ê²ƒì´ ê¸‰ì„ ë¬´ë‹¤ ë³´ë‹ˆ, ì¿¼ë¦¬ì˜ ì„±ëŠ¥ì„ í¬ê²Œ ê³ ë ¤í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê¸°ê»í•´ì•¼ íŠ¸ëœì­ì…˜ ë‚´ë¶€ì—ì„œ ì‹¤í–‰ë˜ëŠ” ì¿¼ë¦¬ ë¡œê·¸ë¥¼ ë³´ê³  N + 1 ë¬¸ì œê°€ ìˆëŠ”ì§€ ë“±ì„ ì²´í¬í•˜ëŠ” ì •ë„ì— ë¶ˆê³¼í–ˆìŠµë‹ˆë‹¤. N + 1 ë¬¸ì œëŠ” Fetch Join ë° Batch Fetch Size ì˜µì…˜ ì„¤ì •ì„ í†µí•´ ì–´ëŠì •ë„ í•´ì†Œí•  ìˆ˜ ìˆì—ˆëŠ”ë°ìš”.

ì–´ëŠ ì •ë„ í•„ìˆ˜ì ì¸ ì„œë¹„ìŠ¤ ê¸°ëŠ¥ë“¤ì´ ì™„ì„±ë˜ê³ ë¶€í„°ëŠ” ì„œë¹„ìŠ¤ì˜ ì•ˆì •ì ì¸ ìš´ì˜ì— ê´€ì‹¬ì´ ë§ì•„ì¡ŒìŠµë‹ˆë‹¤. nGrinder ë° K6 ë“±ì„ í†µí•´ ë¶€í•˜ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•˜ë©´ì„œ ì„œë¹„ìŠ¤ì˜ íŠ¸ë˜í”½ ê°€ìš©ì„±ì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆëŠ”ë°ìš”. DB Scale-Upì´ ë¶ˆê°€ëŠ¥í•œ ìƒí™©ì´ë¼ DB Replicationì„ í†µí•œ Scale-Outì„ í†µí•´ ì„±ëŠ¥ì„ ëŒ€í­ ê°œì„ í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì—¬ì „íˆ íŠ¸ë˜í”½ ë¶€í•˜ê°€ ì‹¬í•´ì§€ë©´ ë‹¤ìŒê³¼ ê°™ì€ ë¬¸ì œë“¤ì´ ì—¬ì „íˆ ì¡´ì¬í–ˆìŠµë‹ˆë‹¤.

* DB ì„œë²„ì˜ CPU Utilizationì´ 100%ì— ìœ¡ë°•í•©ë‹ˆë‹¤.
* TPSê°€ ê¸‰ê²©í•˜ê²Œ í•˜ë½í•©ë‹ˆë‹¤.
* HikariCP Deadlockì´ ì¢…ì¢… ë°œìƒí•©ë‹ˆë‹¤.

SNS ì„œë¹„ìŠ¤ íŠ¹ì„±ìƒ ì¡°íšŒ íŠ¸ëœì­ì…˜ì´ ë¹ˆë²ˆí•˜ê²Œ ë°œìƒí•˜ê¸° ë•Œë¬¸ì—, ì¼ë¶€ ì¡°íšŒ ìš”ì²­ì€ Redisë¥¼ ë„ì…í•´ ì„±ëŠ¥ì„ í–¥ìƒì‹œí‚¬ ìˆ˜ ìˆê² ì§€ë§Œ ì´ ë˜í•œ ë¯¸ë´‰ì±…ì— ë¶ˆê³¼í•©ë‹ˆë‹¤. ê·¼ë³¸ì ìœ¼ë¡œ ì¿¼ë¦¬ ì„±ëŠ¥ì„ í–¥ìƒì‹œí‚¤ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤. Optimizer ì‹¤í–‰ ê²Œíš ë¶„ì„ì„ ê¸°ë°˜ìœ¼ë¡œ ì¿¼ë¦¬ íŠœë‹ì„ ì§„í–‰í•¨ìœ¼ë¡œì¨ ì„œë¹„ìŠ¤ ì„±ëŠ¥ì„ ê°œì„ í•œ ì‚¬ë¡€ë¥¼ ê³µìœ í•˜ê³ ì í•©ë‹ˆë‹¤.

<br>

## 2. ì‚¬ì „ ì‘ì—…

ìš´ì˜ í™˜ê²½ê³¼ ìµœëŒ€í•œ ë™ì¼í•˜ê²Œ êµ¬ì„±í•œ í…ŒìŠ¤íŠ¸ í™˜ê²½ì„ êµ¬ì¶•í•˜ê³ , í…ŒìŠ¤íŠ¸ìš© DBì— ëŒ€ëŸ‰ì˜ ë”ë¯¸ ë°ì´í„°ë¥¼ ì‚½ì…í–ˆìŠµë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ ë°ì´í„° ì…‹ì˜ êµ¬ì„±ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

* ê²Œì‹œë¬¼ 100ë§Œê±´
* ëŒ“ê¸€ 100ë§Œê±´
* ìœ ì € 20ë§Œê±´
* íƒœê·¸ 10ë§Œê±´
* WAS ë¡œë“œ ë°¸ëŸ°ì‹± ë° DB Replication ì ìš©

ì´í›„ íŒ€ì› ì½”ë‹¤ê°€ ë‹¤ìŒ í•­ëª©ë“¤ì— ëŒ€í•´ MariaDB ì˜µì…˜ì„ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.

* [Query Cache OFF](https://lynmp.com/en/article/ml811c9dc506)
* [Durationì´ 1ì´ˆ ì´ìƒ ê±¸ë¦¬ëŠ” Slow Query ë¡œê¹…](https://zetawiki.com/wiki/MySQL_%EC%8A%AC%EB%A1%9C%EC%9A%B0_%EC%BF%BC%EB%A6%AC_%EB%A1%9C%EA%B7%B8_%EC%84%A4%EC%A0%95)

MySQL 8.0ë¶€í„°ëŠ” Query Cache ê¸°ëŠ¥ì´ ì‚¬ë¼ì¡ŒìŠµë‹ˆë‹¤. ì‹¤ì œ ìš´ì˜ DBì˜ ê²½ìš° Query Cache ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ê³  ìˆì§€ë§Œ, ë” ìƒì„¸í•œ ì„±ëŠ¥ ì¸¡ì •ì„ ìœ„í•´ í…ŒìŠ¤íŠ¸ DBëŠ” Query Cache ì˜µì…˜ì„ ë„ë„ë¡ í–ˆìŠµë‹ˆë‹¤.

<br>

## 3. í™ˆ í”¼ë“œ ì¡°íšŒ

> PostRepository.java

```java
@Query("select p from Post p left join fetch p.user order by p.createdAt desc")
List<Post> findAllPosts(Pageable pageable);
```

í™ˆ í”¼ë“œ ì¡°íšŒ ë¹„íšŒì› ìœ ì €ì˜ í™ˆ í”¼ë“œ ê²Œì‹œë¬¼ ì¡°íšŒ JPQL ì¿¼ë¦¬ì…ë‹ˆë‹¤. íŒ€ì› ì½”ë‹¤ê°€ [í™ˆí”¼ë“œ ì¡°íšŒ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ê²½í—˜ê¸°_2](https://2021-pick-git.github.io/project-pickgit-homefeed-performance-test-2/) ê¸€ì—ì„œ í™ˆ í”¼ë“œ ì¡°íšŒì— ëŒ€í•œ ì¿¼ë¦¬ íŠœë‹ ê²½í—˜ì„ ì´ë¯¸ ê³µìœ í•œ ìƒíƒœì¸ë°ìš”. ì´ë²ˆ ì ˆì—ì„œëŠ” íŒ€ì› ì½”ë‹¤ê°€ ì •ë¦¬í•œ ìë£Œë¥¼ ì§§ê²Œ ìš”ì•½í•´ë³´ê² ìŠµë‹ˆë‹¤. (ì½”ë‹¤ ê°ì‚¬!)

> SQL

```sql
select
    post0_.id as id1_8_0_,
    user1_.id as id1_14_1_,
    post0_.content as content2_8_0_,
    post0_.created_at as created_3_8_0_,
    post0_.github_repo_url as github_r4_8_0_,
    post0_.updated_at as updated_5_8_0_,
    post0_.user_id as user_id6_8_0_,
    user1_.description as descript2_14_1_,
    user1_.image as image3_14_1_,
    user1_.name as name4_14_1_,
    user1_.company as company5_14_1_,
    user1_.github_url as github_u6_14_1_,
    user1_.location as location7_14_1_,
    user1_.twitter as twitter8_14_1_,
    user1_.website as website9_14_1_
from
    post post0_
left outer join
    user user1_
        on post0_.user_id=user1_.id
order by
    post0_.created_at desc limit 0, 10;
```

![image](https://user-images.githubusercontent.com/63405904/137449059-6b18bcad-3794-41b9-b7e2-6bc42ee7a971.png)

ì˜µí‹°ë§ˆì´ì € ì‹¤í–‰ ê³„íšì„ í™•ì¸í•œ ê²°ê³¼, ê²Œì‹œë¬¼ 100ë§Œê±´ Table Full Scaní•˜ê³  Filesortë¥¼ ì§„í–‰í•˜ê³  ìˆì—ˆìŠµë‹ˆë‹¤. ê²Œì‹œë¬¼ì„ ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬í•˜ê³  ìƒìœ„ 10ê°œë¥¼ ê°€ì ¸ì˜¤ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

![image](https://user-images.githubusercontent.com/63405904/137443674-1307b8ca-3cfa-41c8-ba80-c0e1adf39e12.png)

ìŠ¬ë¡œìš° ì¿¼ë¦¬ ë¡œê·¸ì—ëŠ” ì¿¼ë¦¬ ìˆ˜í–‰ ì‹œê°„ì´ 1.5ì´ˆì—ì„œ 3ì´ˆê¹Œì§€ ì†Œìš”ë˜ì—ˆìŠµë‹ˆë‹¤.

![image](https://user-images.githubusercontent.com/63405904/137443204-86fd6f1b-1f46-4613-bb31-00dc4091bb68.png)

ë¶€í•˜ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•  ë•Œ ``vmstat``ìœ¼ë¡œ WAS ë° DB ì„œë²„ ìƒíƒœë¥¼ ê²€ì‚¬í•œ ê²°ê³¼ì…ë‹ˆë‹¤. ìƒë‹¨ì˜ 2ê°œëŠ” WASì´ë©° í•˜ë‹¨ì˜ 2ê°œê°€ ì¡°íšŒë¥¼ ìœ„í•œ DB Slave ì„œë²„ì…ë‹ˆë‹¤. DB ì„œë²„ì˜ CPU Utilization(us) ë° ì‹¤í–‰ ëŒ€ê¸° í”„ë¡œì„¸ìŠ¤ì˜ ìˆ˜ (r)ì´ ë§¤ìš° ë†’ê²Œ ì¸¡ì •ë˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

DBì— ë³‘ëª©ì´ ì‹¬í•œë° Scale-Upì„ ì§„í–‰í•  ìˆ˜ ì—†ëŠ” ìƒí™©ì¸ë§Œí¼ ì¿¼ë¦¬ ìµœì í™”ê°€ ì‹œê¸‰í•©ë‹ˆë‹¤.

![image](https://user-images.githubusercontent.com/63405904/137449278-a84af99e-42d5-4ada-86aa-cc3c9c05a2fb.png)

íŒ€ì› ì½”ë‹¤ê°€ ``created_at`` ì»¬ëŸ¼ì— ì¸ë±ìŠ¤ë¥¼ ê±¸ê³  ë‹¤ì‹œ ì‹¤í–‰ ê³„íšì„ í™•ì¸í•œ ê²°ê³¼, ì´ë²ˆì—ëŠ” Table Full Scanì—†ì´ Index Full Scanì„ í†µí•´ ê²Œì‹œë¬¼ì„ ì¡°íšŒí•©ë‹ˆë‹¤. Filesortë„ ì‚¬ë¼ì¡Œìœ¼ë©° ì¿¼ë¦¬ì˜ Duration ë˜í•œ 3ì´ˆì—ì„œ 0.0094ì´ˆë¡œ ëŒ€í­ í•˜ë½í–ˆìŠµë‹ˆë‹¤.

![image](https://user-images.githubusercontent.com/56240505/137612612-1243258f-7df5-40c2-9989-f80b74ca1377.png)

ê³¼ê±° ê²Œì‹œë¬¼ì´ 35ë§Œê±´ì¼ ë•Œ VUser 600ëª…ì´ 10ë¶„ê°„ í™ˆ í”¼ë“œë¥¼ ì¡°íšŒí•˜ëŠ” ë¶€í•˜ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•œ ì ì´ ìˆì—ˆëŠ”ë°ìš”. ì´ ë‹¹ì‹œ TPSê°€ í‰ê·  30ì„ ê¸°ë¡í–ˆìŠµë‹ˆë‹¤. í˜„ì¬ëŠ” ê²Œì‹œë¬¼ì´ 100ë§Œê±´ì´ë‹ˆ ì¸ë±ìŠ¤ë¥¼ ê±¸ì§€ ì•ŠëŠ”ë‹¤ë©´ ì´ë³´ë‹¤ ì„±ëŠ¥ì´ ë” ë‚˜ì˜ê²Œ ì¸¡ì •ë  ê²ƒì…ë‹ˆë‹¤.

![image](https://user-images.githubusercontent.com/56240505/137612845-2f566f6f-0503-44f2-9bb4-c7224fbcaf18.png)

ì´ë²ˆì—ëŠ” ê²Œì‹œë¬¼ì´ 100ë§Œê±´ì¼ ë•Œ VUser 500ëª…ì´ 10ë¶„ê°„ í™ˆ í”¼ë“œë¥¼ ì¡°íšŒí•˜ëŠ” ë¶€í•˜ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í–ˆìŠµë‹ˆë‹¤. TPSê°€ í‰ê·  300ëŒ€ë¡œ ë§¤ìš° ë†’ê²Œ ì¸¡ì •ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

![image](https://user-images.githubusercontent.com/63405904/137449561-613620d9-d87a-4433-a626-aca8ea74ebcf.png)

í…ŒìŠ¤íŠ¸ DB ì„œë²„ì˜ ëŒ€ê¸° ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ì˜ ìˆ˜ ë° CPU Utilization ë˜í•œ ë§ì´ ê°œì„ ë˜ì—ˆìŠµë‹ˆë‹¤.

### 3.1. Paginationì˜ ëŠª

ì„±ëŠ¥ì´ ê°œì„ ë˜ì–´ì„œ íŒ€ì› ëª¨ë‘ë“¤ íë­‡(?)í–ˆì—ˆëŠ”ë°, íŒ€ì› ì½”ë‹¤ê°€ ë‹¤ìŒê³¼ ê°™ì€ ì´ìŠˆë¥¼ ì œê¸°í–ˆìŠµë‹ˆë‹¤.

> ì¡°íšŒ ì¿¼ë¦¬ ì‹¤í–‰í•  ë•Œ Page í¬ê¸°ê°€ íŠ¹ì • ë²”ìœ„ë¥¼ ì´ˆê³¼í•˜ë©´ ë‹¤ì‹œ Full Table Scaní•˜ë„¤ìš”?

![image](https://user-images.githubusercontent.com/56240505/137614141-0eeebdc1-be5f-4be2-a406-592a78d7f6d9.png)

ì¼ë‹¨ ë‹¤ì‹œ MySQL Workbenchë¥¼ ì‹¤í–‰í•´ì„œ ì‹¤í–‰ ê³„íšì„ í™•ì¸í•´ë´…ì‹œë‹¤.

> SQL

```sql
select
    post0_.id as id1_8_0_,
    user1_.id as id1_14_1_,
    post0_.content as content2_8_0_,
    post0_.created_at as created_3_8_0_,
    post0_.github_repo_url as github_r4_8_0_,
    post0_.updated_at as updated_5_8_0_,
    post0_.user_id as user_id6_8_0_,
    user1_.description as descript2_14_1_,
    user1_.image as image3_14_1_,
    user1_.name as name4_14_1_,
    user1_.company as company5_14_1_,
    user1_.github_url as github_u6_14_1_,
    user1_.location as location7_14_1_,
    user1_.twitter as twitter8_14_1_,
    user1_.website as website9_14_1_
from
    post post0_
left outer join
    user user1_
        on post0_.user_id=user1_.id
order by
    post0_.created_at desc limit 5000, 10;
```

<img width="1097" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2021-10-17 á„‹á…©á„’á…® 3 20 45" src="https://user-images.githubusercontent.com/56240505/137614295-82803936-59e1-4e7f-8916-5c020db562b2.png">

OFFSETì— í•´ë‹¹í•˜ëŠ” ë¶€ë¶„ì„ 5000ìœ¼ë¡œ ë†’ì´ë‹ˆ ì¸ë±ìŠ¤ë¥¼ íƒ€ì§€ ì•Šê³  Table Full Scan, Filesortë¥¼ ì‚¬ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì•„ìš¸ëŸ¬ ì¿¼ë¦¬ ìˆ˜í–‰ ì‹œê°„ì´ ë‹¤ì‹œ ë‚˜ë¹ ì§€ê¸° ì‹œì‘í–ˆìŠµë‹ˆë‹¤.

![image](https://user-images.githubusercontent.com/56240505/137618326-21720224-c645-451e-9210-8306f41ac079.png)

OFFSETì„ 500000ìœ¼ë¡œ ë†’ì¸ ê²°ê³¼ì…ë‹ˆë‹¤. ì¦‰, OFFSET í¬ê¸°ì™€ ì¡°íšŒ ì¿¼ë¦¬ ì„±ëŠ¥ì´ ë°˜ë¹„ë¡€í•¨ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

> TestRunner.groovy

```groovy
@Test
public void test() {
  long randomId = Math.abs(random.nextInt() % 99999) + 1
  HTTPResponse response = request.GET("https://{test-api-address}/api/posts?page=" + randomId + "&limit=10", params)

  if (response.statusCode == 301 || response.statusCode == 302) {
    grinder.logger.warn("Warning. The response may not be correct. The response code was {}.", response.statusCode)
  } else {
    assertThat(response.statusCode, is(200))
  }
}
```

ê¸°ì¡´ì˜ í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ëŠ” ``page=10`` ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¥¼ ê³ ì •í•´ì„œ ì‚¬ìš©í–ˆì—ˆìŠµë‹ˆë‹¤. ì´ë²ˆì—ëŠ” ë†’ì€ ë²”ìœ„ì˜ ë‚œìˆ˜ë¥¼ ìƒì„±í•´ì„œ API ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.

![image](https://user-images.githubusercontent.com/56240505/137614492-da7e3bc4-4a9c-497c-b0bf-8fcc27cdf0ec.png)

í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•œì§€ 1ë¶„ì¯¤ ë˜ë‹ˆ í…ŒìŠ¤íŠ¸ê°€ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ì—ëŸ¬ìœ¨ì´ 50%ë¥¼ ì´ˆê³¼í–ˆê¸° ë•Œë¬¸ì¸ë°ìš”. TPSê°€ ê·¹ì•…ì— ë‹¬í•  ì •ë„ë¡œ ë‚®ì€ ê²ƒì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤.

![image](https://user-images.githubusercontent.com/56240505/137614376-5a509b7f-e31d-473d-b8c0-a53d66de5210.png)

ì—ëŸ¬ ë¡œê·¸ë¥¼ ë³´ë‹ˆ ì¡°íšŒ ì¿¼ë¦¬ë¥¼ ìˆ˜í–‰í•˜ëŠ”ë° ë„ˆë¬´ ë§ì€ ì‹œê°„ì´ ì†Œìš”ë˜ì–´ ëŒ€ê¸° ì¤‘ì´ë˜ íŠ¸ëœì­ì…˜ ì›Œì»¤ ì“°ë ˆë“œê°€ Connectionì„ ì–»ì§€ ëª»í•´ ì˜ˆì™¸ë¥¼ ë°œìƒì‹œí‚¤ê³  ìˆìŠµë‹ˆë‹¤. HikariCP Deadlock ë¬¸ì œê°€ ë°œìƒí•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤.

![image](https://user-images.githubusercontent.com/56240505/137614475-2086f17d-cf05-4724-811e-2497a0fde5c2.png)

ê¸°ì¡´ì— ``page=10`` ì¼ë•ŒëŠ” ì¸ë±ìŠ¤ë¥¼ ì ìš©í•˜ì§€ ì•Šì•„ë„ ì¿¼ë¦¬ë¥¼ ìˆ˜í–‰í•˜ëŠ”ë° 1ì´ˆ ~ 3ì´ˆ ì •ë„ ì†Œìš”ë˜ì—ˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ``page=600,000`` í˜¹ì€ ``page=900,000``ê³¼ ê°™ì€ ê°™ì´ OFFSETì´ ë†’ì€ ê²½ìš° ìˆ˜í–‰ ì‹œê°„ 10ì´ˆ ì´ìƒì˜ ì¿¼ë¦¬ë“¤ì´ ë¹ˆë²ˆí–ˆìŠµë‹ˆë‹¤. ìµœëŒ€ 18ì´ˆê°€ ì†Œìš”ëœ ì¿¼ë¦¬ë„ ë³´ì´ë„¤ìš”.

### 3.2. ë¬¸ì œ ì›ì¸

> SQL

```sql
select * from post order by id limit 150000, 10;
```

í•´ë‹¹ ì¿¼ë¦¬ëŠ” 150,010ê°œì˜ í–‰ì„ IDë¡œ ì •ë ¬í•œ ë‹¤ìŒ ê·¸ ì¤‘ ì²˜ìŒ 10ê°œ í–‰ì„ ë°˜í™˜í•˜ê² ë‹¤ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤. ì‹¤ì§ˆì ìœ¼ë¡œ 10ê°œì˜ ë ˆì½”ë“œê°€ í•„ìš”í•˜ì§€ë§Œ, ê·¸ ê³¼ì •ì—ì„œ 150,000ê°œì— ë‹¬í•˜ëŠ” ê°œìˆ˜ì˜ ë ˆì½”ë“œë¥¼ ì¹´ìš´íŒ…í•˜ê²Œë©ë‹ˆë‹¤.

ì¼ë°˜ì ìœ¼ë¡œ í…Œì´ë¸”ì€ ë ˆì½”ë“œë¥¼ ì •ë ¬í•´ì£¼ëŠ” ì¸ë±ìŠ¤ê°€ ìˆë‹¤ë©´ Filesortë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê·¸ëŸ°ë° ì •ë ¬ëœ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ëŠ”ë° ì¿¼ë¦¬ê°€ ë§ê²ŒëŠ” 10ì´ˆ ì´ìƒì´ ê±¸ë¦°ë‹¤ëŠ” ê²ƒì€ í™•ì‹¤íˆ ë¬¸ì œê°€ ìˆì–´ ë³´ì…ë‹ˆë‹¤.

![image](https://user-images.githubusercontent.com/56240505/137615067-4ad57c8a-0850-4cc2-98ca-deec02fc7e8c.png)

ì¸ë±ìŠ¤ëŠ” ë…¼ë¦¬ì ì¸ ê°œë…ì—ì„œ í…Œì´ë¸”ì˜ ì¼ë¶€ë¶„ì´ì§€ë§Œ ë¬¼ë¦¬ì ìœ¼ë¡œëŠ” í…Œì´ë¸”ê³¼ ë³„ë„ë¡œ ì¡´ì¬í•˜ëŠ” ê°œì²´ì…ë‹ˆë‹¤. ëŒ€í‘œì ìœ¼ë¡œ ë‘ ê°€ì§€ ì •ë³´ë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.

* Index Key : ì¸ë±ìŠ¤ê°€ ìƒì„±ëœ ì»¬ëŸ¼ë“¤ì…ë‹ˆë‹¤.
* Table Pointer : íŠ¹ì • ë ˆì½”ë“œê°€ ë‚˜íƒ€ë‚´ëŠ” í–‰ì„ ê³ ìœ í•˜ê²Œ ì§€ì¹­í•˜ëŠ” ì–´ë– í•œ ê°’ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
  * InnoDBì˜ ê²½ìš° PK ê°’ì…ë‹ˆë‹¤.

ì¸ë±ìŠ¤ëŠ” B-Tree ìë£Œêµ¬ì¡°ì— ì €ì¥ë˜ë©° ì´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ref ë° range ê²€ìƒ‰ì„ í†µí•´ ë°ì´í„°ë¥¼ ë¹ ë¥´ê²Œ ì¡°íšŒí•©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì¸ë±ìŠ¤ ìì²´ëŠ” í…Œì´ë¸”ì˜ ëª¨ë“  ì •ë³´ë¥¼ ë‹´ê³  ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ìˆœì„œë¥¼ ìœ ì§€í•˜ë©° ì‹¤ì œ í…Œì´ë¸” ê°’ì„ ì°¾ê¸° ìœ„í•´ì„œ, ì¸ë±ìŠ¤ì™€ í…Œì´ë¸”ì´ ì—°ê²°ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. ì¦‰, DB ì—”ì§„ì€ í–‰ í¬ì¸í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê° ì¸ë±ìŠ¤ ë ˆì½”ë“œì— ìƒì‘í•˜ëŠ” í…Œì´ë¸” ë ˆì½”ë“œë¥¼ ì°¾ì•„ ì¸ë±ì‹±ì´ ë˜ì§€ ì•Šì€ ëª¨ë“  ë°ì´í„°ë¥¼ ë°˜í™˜í•´ì•¼í•©ë‹ˆë‹¤.

![image](https://user-images.githubusercontent.com/56240505/137616242-4b25a0ca-b7bb-49a0-b4f2-20170de423d4.png)

í…Œì´ë¸” ë ˆì½”ë“œë¥¼ ìƒì‘í•˜ëŠ” ì¸ë±ìŠ¤ ë ˆì½”ë“œì™€ ì—°ê²°í•˜ëŠ” í–‰ìœ„ë¥¼ **Row Lookup**ì´ë¼ê³  í•©ë‹ˆë‹¤. ìœ„ ì‚¬ì§„ì—ì„œ ì¸ë±ìŠ¤ì™€ í…Œì´ë¸”ì„ ì—°ê²°í•˜ëŠ” êµ¬ë¶ˆêµ¬ë¶ˆí•œ í™”ì‚´í‘œë“¤ì…ë‹ˆë‹¤.

ì¸ë±ìŠ¤ ë ˆì½”ë“œì™€ í…Œì´ë¸” ë ˆì½”ë“œëŠ” ë©”ëª¨ë¦¬ ìƒ ë° ë””ìŠ¤í¬ ìƒ ëª¨ë‘ ì„œë¡œ ë–¨ì–´ì ¸ ê°œë³„ì ìœ¼ë¡œ ì¡´ì¬í•©ë‹ˆë‹¤. Row Lookupì€ Pageë‚˜ Cacheê°€ ì ì  ë” ì ì¤‘í•˜ì§€ ëª»í•˜ê³  Missí•˜ëŠ” ìƒí™©ì„ ìœ ë°œí•©ë‹ˆë‹¤. ë˜í•œ ë””ìŠ¤í¬ëŠ” ìˆœì°¨ ì ‘ê·¼ì„ í†µí•´ íƒìƒ‰ì„ í•  ê²ƒì´ê³  ê·¸ ê²°ê³¼ ë§ì€ ë¹„ìš©ì´ ë°œìƒí•©ë‹ˆë‹¤. ìœ„ ì‚¬ì§„ì—ì„œ ëª¨ë“  ì—°ê²°ë“¤ì„ ìˆœíšŒí•˜ëŠ”ë° ë§ì€ ì‹œê°„ì´ ì†Œìš”ë©ë‹ˆë‹¤.

### 3.3. í•´ê²°

ê·¸ëŸ°ë° LIMIT ë° OFFSET ë“±ì„ ì‚¬ìš©í•  ë•Œ ì´ëŸ¬í•œ Row Lookup ì‘ì—…ì´ ì •ë§ í•„ìš”í• ê¹Œìš”? ë§Œì•½ ``LIMIT 8, 2`` ì¿¼ë¦¬ë¼ë©´ ì¸ë±ìŠ¤ë¥¼ ì‚¬ìš©í•´ ì•ì„  8ê°œì˜ ê°’ì€ ë¬´ì‹œí•˜ê³  ë‚¨ì€ 2ê°œë§Œ ë°˜í™˜í•˜ë©´ ë  ì¼ì…ë‹ˆë‹¤.

![image](https://user-images.githubusercontent.com/56240505/137617871-f9d217e8-9cbf-4c82-862a-751fd98c136c.png)

ì´ëŸ¬í•œ ë°©ë²•ì„ **Late Row Lookup**ì´ë¼ê³  í•©ë‹ˆë‹¤. DB ì—”ì§„ì€ ì •ë§ ë‹¤ë¥¸ ë°©ë²•ì´ ì—†ì„ ë•Œ Row Lookupì„ ì§„í–‰í•©ë‹ˆë‹¤. ë§Œì•½ ì¸ë±ìŠ¤ í•„ë“œë“¤ì„ ê¸°ë°˜ìœ¼ë¡œ í–‰ì„ í•„í„°ë§í•˜ëŠ” ë°©ë²•ì´ ì¡´ì¬í•œë‹¤ë©´, ì‹¤ì œ MySQL Tableì„ Lookupí•˜ê¸° ì „ ìˆ˜í–‰ë©ë‹ˆë‹¤.

> SQL

```sql
select * from post where id > 150000 order by id limit 10;
```

ì´ì²˜ëŸ¼ ì¸ë±ìŠ¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” WHERE êµ¬ë¬¸ì„ í†µí•´ ë¨¼ì € ë°ì´í„°ë¥¼ í•„í„°ë§í•˜ë©´ 150,000ê°œì˜ RowëŠ” ë¬´ì‹œí•˜ê³  LIMITì— ê±¸ë¦° 10ê°œì˜ Rowì— ëŒ€í•´ì„œë§Œ Row Lookupì´ ë°œìƒí•©ë‹ˆë‹¤. ë”°ë¼ì„œ Paginationì„ ì²˜ë¦¬í•  ë•Œ ì ì ˆíˆ WHERE ì¡°ê±´ì„ ì‚¬ìš©í•´ì£¼ë©´, ìƒê¸°ì˜ ë¬¸ì œë¥¼ ê·¹ë³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

í˜„ì¬ ìš´ì˜ ì¤‘ì¸ ì„œë¹„ìŠ¤ ì¤‘ ë¹„íšŒì›ì˜ í™ˆ í”¼ë“œ ì¡°íšŒëŠ” ê²Œì‹œë¬¼ì„ ìµœì‹ ìˆœìœ¼ë¡œ ë³´ì—¬ì¤ë‹ˆë‹¤. ì¦‰, ë‚ ì§œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬í•˜ëŠ”ë°ìš”. ë”°ë¼ì„œ í”„ë¡ íŠ¸ì—”ë“œ ì¸¡ì—ì„œ ë‹¤ìŒ í˜ì´ì§€ë¥¼ ê°±ì‹ í•  ë•Œ, ì´ì „ í˜ì´ì§€ì—ì„œ ê°€ì¥ í•˜ë‹¨ì— ìœ„ì¹˜í•œ ê²Œì‹œë¬¼ì˜ ë‚ ì§œë¥¼ ë°±ì—”ë“œë¡œ ì „ë‹¬í•˜ê³  ì´ë¥¼ WHERE ì¡°ê±´ìœ¼ë¡œ í•¨ê»˜ ì‚¬ìš©í•©ë‹ˆë‹¤.

> SQL

```sql
select
    post0_.id as id1_8_0_,
    user1_.id as id1_14_1_,
    post0_.content as content2_8_0_,
    post0_.created_at as created_3_8_0_,
    post0_.github_repo_url as github_r4_8_0_,
    post0_.updated_at as updated_5_8_0_,
    post0_.user_id as user_id6_8_0_,
    user1_.description as descript2_14_1_,
    user1_.image as image3_14_1_,
    user1_.name as name4_14_1_,
    user1_.company as company5_14_1_,
    user1_.github_url as github_u6_14_1_,
    user1_.location as location7_14_1_,
    user1_.twitter as twitter8_14_1_,
    user1_.website as website9_14_1_
from
    post post0_
left outer join
    user user1_
        on post0_.user_id=user1_.id
where
    post0_.created_at < ${'foo-date'}
order by
    post0_.created_at desc limit 10;
```

![image](https://user-images.githubusercontent.com/56240505/137623039-de8a5e32-0a7f-4080-a309-1d0608f96fc8.png)

ì¡°íšŒ ì¿¼ë¦¬ ì„±ëŠ¥ì´ ë‹¤ì‹œ í–¥ìƒë˜ì—ˆìœ¼ë©°, Full Table Scan ë° Filesortë¥¼ ë”ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

ê·¸ëŸ°ë° ë‚ ì§œë¥¼ WHERE ì¡°ê±´ì— ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ë‹¤ì†Œ ë¶ˆí¸í•˜ë‹¤ê³  ëŠê¼ˆìŠµë‹ˆë‹¤. ëŒ€ë¶€ë¶„ì˜ ê²½ìš° ID PK ë°ì´í„° ìˆœì„œì™€ created_at ë°ì´í„° ìˆœì„œê°€ ë™ì¼í•©ë‹ˆë‹¤. ë”°ë¼ì„œ í”„ë¡ íŠ¸ì—”ë“œ ì¸¡ì—ì„œ ë‹¤ìŒ í˜ì´ì§€ë¥¼ ê°±ì‹ í•  ë•Œ, ì´ì „ í˜ì´ì§€ì—ì„œ ê°€ì¥ í•˜ë‹¨ì— ìœ„ì¹˜í•œ ê²Œì‹œë¬¼ì˜ ë‚ ì§œê°€ ì•„ë‹Œ IDë¥¼ ì „ë‹¬í•´ì„œ ì¿¼ë¦¬ì— ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

> SQL

```sql
select
    post0_.id as id1_8_0_,
    user1_.id as id1_14_1_,
    post0_.content as content2_8_0_,
    post0_.created_at as created_3_8_0_,
    post0_.github_repo_url as github_r4_8_0_,
    post0_.updated_at as updated_5_8_0_,
    post0_.user_id as user_id6_8_0_,
    user1_.description as descript2_14_1_,
    user1_.image as image3_14_1_,
    user1_.name as name4_14_1_,
    user1_.company as company5_14_1_,
    user1_.github_url as github_u6_14_1_,
    user1_.location as location7_14_1_,
    user1_.twitter as twitter8_14_1_,
    user1_.website as website9_14_1_
from
    post post0_
left outer join
    user user1_
        on post0_.user_id=user1_.id
where
    post0_.id < ${'foo-post-id'}
order by
    post0_.created_at desc limit 10;
```

![image](https://user-images.githubusercontent.com/56240505/137623347-a8b76fc7-b1b9-4ef6-ac21-da907bbfea3a.png)

WHERE ì¡°ê±´ì„ ì‚¬ìš©í•˜ì§€ ì•Šë˜ ë•Œë³´ë‹¤ëŠ” ì¿¼ë¦¬ ì„±ëŠ¥ì´ í–¥ìƒ ë˜ì—ˆìœ¼ë‚˜, WHERE ì¡°ê±´ì— ë‚ ì§œë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ë³´ë‹¤ëŠ” í˜„ì €íˆ ëŠë¦½ë‹ˆë‹¤. WHERE ì¡°ê±´ì— ë‚ ì§œë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš° INDEX Range Scanì„ ì‚¬ìš©í•˜ì§€ë§Œ, IDë¥¼ ì‚¬ìš©í•˜ë‹ˆ INDEX Full Scanì„ ì‚¬ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤. í˜„ì¬ WHERE ì¡°ê±´ê³¼ ORDER ì¡°ê±´ì—ì„œ ì‚¬ìš© ì¤‘ì¸ ì¸ë±ìŠ¤ê°€ ë‹¤ë¥´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

SQL ë¬¸ì¥ì´ WHERE ì ˆê³¼ ORDER BY ì ˆì„ ê°€ì§„ë‹¤ë©´, WHERE ì¡°ê±´ì€ A ì¸ë±ìŠ¤ë¥¼ ì‚¬ìš©í•˜ê³  ORDER BYëŠ” B ì¸ë±ìŠ¤ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤. WHERE ì ˆê³¼ ORDER BY ì ˆì´ ê°™ì´ ì‚¬ìš©ëœ ì¿¼ë¦¬ ë¬¸ì¥ì€ ë‹¤ìŒ ì¤‘ í•œ ê°€ì§€ ë°©ë²•ìœ¼ë¡œ ì¸ë±ìŠ¤ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

* WHERE ì ˆê³¼ ORDER ì ˆ ëª¨ë‘ ë™ì‹œì— ê°™ì€ ì¸ë±ìŠ¤ë¥¼ ì‚¬ìš©í•˜ê¸°.
  * WHERE ì ˆì˜ ë¹„êµ ì¡°ê±´ì— ì‚¬ìš©í•˜ëŠ” ì¹¼ëŸ¼ê³¼ ORDER BY ì ˆì˜ ì •ë ¬ ëŒ€ìƒ ì¹¼ëŸ¼ì´ ëª¨ë‘ í•˜ë‚˜ì˜ ì¸ë±ìŠ¤ì— ì—°ì†í•´ì„œ í¬í•¨ë˜ì–´ ìˆì„ ë•Œ ì´ ë°©ì‹ìœ¼ë¡œ ì¸ë±ìŠ¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* WHERE ì ˆì˜ ì¸ë±ìŠ¤ë§Œ ì‚¬ìš©í•˜ê¸°.
* ORDER ì ˆì˜ ì¸ë±ìŠ¤ë§Œ ì‚¬ìš©í•˜ê¸°.

í˜„ì¬ Index Full Scanì„ ì‚¬ìš©í•˜ì§€ ì•Šê¸° ìœ„í•´ì„œëŠ” WHERE + ORDER ì»¬ëŸ¼ì„ ëª¨ë‘ í¬í•¨í•˜ëŠ” ``INDEX (ID, CREATED_AT)``ë¥¼ ìƒˆë¡œ ë§Œë“¤ê±°ë‚˜ ì–´ëŠ í•œ ìª½ì˜ ì¸ë±ìŠ¤ë¥¼ ì‚¬ìš©í•˜ë„ë¡ WHERE ì ˆì´ë‚˜ ORDER ì ˆì˜ ì»¬ëŸ¼ì„ ìˆ˜ì •í•´ì•¼í•©ë‹ˆë‹¤. í¸ì˜ë¥¼ ìœ„í•´ ORDER ì ˆë„ IDë¥¼ ì‚¬ìš©í•˜ë„ë¡ ìˆ˜ì •í•´ë³´ê² ìŠµë‹ˆë‹¤.

> SQL

```sql
select
    post0_.id as id1_8_0_,
    user1_.id as id1_14_1_,
    post0_.content as content2_8_0_,
    post0_.created_at as created_3_8_0_,
    post0_.github_repo_url as github_r4_8_0_,
    post0_.updated_at as updated_5_8_0_,
    post0_.user_id as user_id6_8_0_,
    user1_.description as descript2_14_1_,
    user1_.image as image3_14_1_,
    user1_.name as name4_14_1_,
    user1_.company as company5_14_1_,
    user1_.github_url as github_u6_14_1_,
    user1_.location as location7_14_1_,
    user1_.twitter as twitter8_14_1_,
    user1_.website as website9_14_1_
from
    post post0_
left outer join
    user user1_
        on post0_.user_id=user1_.id
where
    post0_.id < ${'foo-post-id'}
order by
    post0_.created_at desc limit 10;
```

![image](https://user-images.githubusercontent.com/56240505/137623472-d95c3feb-df9e-4d7a-93a1-8cc59c255ebc.png)

WHERE ì ˆê³¼ ORDER ì ˆ ëª¨ë‘ IDë¥¼ ì‚¬ìš©í•˜ë‹ˆ ë‹¤ì‹œê¸ˆ Index Range Scanì„ í•˜ë©° ì„±ëŠ¥ì´ í–¥ìƒë˜ì—ˆìŠµë‹ˆë‹¤.

![image](https://user-images.githubusercontent.com/56240505/137632838-76626ce0-ef49-492b-96b8-c39f2e67d0be.png)

nGrinderë¥¼ í†µí•´ ë¶€í•˜ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í–ˆìŠµë‹ˆë‹¤. ë‚œìˆ˜ ë°œìƒì„ í†µí•´  ``page=600000``ê³¼ ê°™ì€ ê·¹ë‹¨ì ì¸ ìš”ì²­ì„ ì§€ì†ì ìœ¼ë¡œ ë°œìƒì‹œì¼°ì§€ë§Œ, í‰ê·  TPSê°€ 300ëŒ€ë¡œ ìœ ì§€ë˜ëŠ” ë“± Pagination ì¡°íšŒ ì„±ëŠ¥ì´ í¬ê²Œ í•˜ë½í•˜ì§€ ì•ŠëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ğŸ˜ŠğŸ˜Š

<br>

## 4. ìœ ì € ê²€ìƒ‰

> UserRepository.java

```java
@Query("select u from User u where u.basicProfile.name like %:username%")
List<User> searchByUsernameLike(@Param("username") String username, Pageable pageable);
```

> SQL

```sql
select
    user0_.id as id1_14_,
    user0_.description as descript2_14_,
    user0_.image as image3_14_,
    user0_.name as name4_14_,
    user0_.company as company5_14_,
    user0_.github_url as github_u6_14_,
    user0_.location as location7_14_,
    user0_.twitter as twitter8_14_,
    user0_.website as website9_14_
from
    user user0_
where
    user0_.name like ? limit ?
```

í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ ìœ ì € ê²€ìƒ‰ ë°©ë²•ì€ ì—¬ëŸ¬ ë¬¸ì œê°€ ì¡´ì¬í•©ë‹ˆë‹¤.

1. ì•ì„œ ì–¸ê¸‰í•œ Pagination OFFSET ë¬¸ì œê°€ ì¡´ì¬í•˜ê¸° ë•Œë¬¸ì— WHEREì— ì ì ˆí•œ ì¡°ê±´ì´ ì¶”ê°€ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
2. **ìœ ì €ë¥¼ ì´ë¦„ìœ¼ë¡œ ì¡°íšŒí•  ë•Œ LIKE ì—°ì‚°ìë¥¼ ì´ìš©í•˜ëŠ”ë°, % ê¸°í˜¸ë¥¼ ì•ì— ë„£ì–´ ì‚¬ìš©í•˜ë©´ ìœ ì € ì´ë¦„ ì¸ë±ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì§€ ëª»í•©ë‹ˆë‹¤.**

![image](https://user-images.githubusercontent.com/56240505/137668813-bf956dc0-e2a6-4bd9-b891-4d7899c35dbe.png)

ë”°ë¼ì„œ í•´ë‹¹ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ë©´ Table Full Scanì´ ë°œìƒí•©ë‹ˆë‹¤.

![image](https://user-images.githubusercontent.com/56240505/137668936-6fd70a7a-702a-4ec8-8a07-e1b245357824.png)

íšŒì›ì´ 20ë§Œê±´ì¼ ë•Œ VUser 500ëª…ì´ 10ë¶„ê°„ íšŒì› ì´ë¦„ì„ ê²€ìƒ‰í•˜ëŠ” ë¶€í•˜ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í–ˆìŠµë‹ˆë‹¤. í‰ê·  TPSëŠ” 38.9ì…ë‹ˆë‹¤.

![image](https://user-images.githubusercontent.com/56240505/137669129-08e4048f-7977-47ff-854d-10a25887944f.png)

í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•  ë•Œ DB ì„œë²„ì˜ ìƒíƒœë¥¼ ì¸¡ì •í•´ë³´ë‹ˆ ëŒ€ê¸° ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ì˜ ìˆ˜ ë° CPU Utilizationì´ ë§¤ìš° ë†’ìŠµë‹ˆë‹¤. í˜„ì¬ í…ŒìŠ¤íŠ¸ëŠ” ì‹¬ì§€ì–´ ì´ì „ ì ˆì²˜ëŸ¼ Pagination OFFSETì„ ë†’ê²Œ ì¤€ ê²ƒì´ ì•„ë‹ˆë¼ ``page=0``ìœ¼ë¡œ ë§¤ìš° ë‚®ê²Œ ì£¼ì—ˆìŠµë‹ˆë‹¤. ì¦‰, 1ë²ˆ ë¬¸ì œëŠ” ì‰½ê²Œ ì²˜ì¹˜í•  ìˆ˜ ìˆìœ¼ë‚˜ ê¶ê·¹ì ì¸ ì›ì¸ì€ 2ë²ˆ ë¬¸ì œì…ë‹ˆë‹¤. íŒ€ íšŒì˜ë¥¼ í†µí•´ ë„ì¶œí•œ ëŒ€ì•ˆì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

1. ì¸ë±ìŠ¤ë¥¼ íƒ€ê¸° ìœ„í•´ ``LIKE :username%``ê³¼ ê°™ì´ ì•ì—ì„œ ì‚¬ìš©í•˜ëŠ” % ê¸°í˜¸ë¥¼ ì‚­ì œí•˜ê¸°.
2. ì¿¼ë¦¬ íŠœë‹ì„ í¬ê¸°í•˜ê³  ê²€ìƒ‰ ìš”ì²­ì˜ ê²½ìš° Elastic Searchë¥¼ í†µí•´ ì²˜ë¦¬í•˜ê¸°.

1ë²ˆ ë°©ë²•ì€ í´ë¼ì´ì–¸íŠ¸ê°€ ì…ë ¥í•œ ë¬¸ìì—´ë¡œ ì‹œì‘í•˜ëŠ” ìœ ì € ì´ë¦„ë§Œì„ ê²€ìƒ‰í•˜ê¸°ì— ì‚¬ìš©ì ê²½í—˜ ì¸¡ë©´ì—ì„œ ë¶€ì ì ˆí•˜ë‹¤ê³  íŒë‹¨í–ˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ 2ë²ˆ ë°©ë²•ì„ ì±„íƒí•˜ê¸°ë¡œ ê²°ì •í–ˆìŠµë‹ˆë‹¤.

ë¬¼ë¡  Elastic Searchë¼ëŠ” ë³„ë„ì˜ DBë¥¼ ì‚¬ìš©í•¨ìœ¼ë¡œì¨ ê³ ë ¤í•´ì•¼í•  ê´€ë¦¬ í¬ì¸íŠ¸ê°€ ë§ì•„ì§„ë‹¤ëŠ” ë‹¨ì ì´ ì¡´ì¬í•©ë‹ˆë‹¤.

* RDBì™€ì˜ ë°ì´í„° ì •í•©ì„±ì„ ì œëŒ€ë¡œ ìœ ì§€í•´ì•¼í•©ë‹ˆë‹¤.
* ESëŠ” ì½ê¸° ì„±ëŠ¥ì´ ìš°ìˆ˜í•˜ì§€ë§Œ ì“°ê¸° ì„±ëŠ¥ì´ ë‚˜ìœ ë§Œí¼, ì—…ë°ì´íŠ¸ ë°©ì‹ì— ëŒ€í•œ ì¶”ê°€ì ì¸ í•™ìŠµì´ í•„ìš”í•©ë‹ˆë‹¤.
  * ì‹¤ì‹œê°„ìœ¼ë¡œ ì²˜ë¦¬í•  ê²ƒì¸ì§€ ë°°ì¹˜ ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬í•  ê²ƒì¸ì§€ ë“±.
* ê³ ê°€ìš©ì„±ì„ ìœ„í•œ ë‹¨ì¼ ì¥ì• ì  ê·¹ë³µì„ ìœ„í•´ ES í´ëŸ¬ìŠ¤í„°ë§ ë° ìƒ¤ë”© ë“± ì•„í‚¤í…ì³ì— ëŒ€í•œ ê³ ë ¤ë„ í•„ìš”í•©ë‹ˆë‹¤.

ê·¸ëŸ¬ë‚˜ ì§€ê¸ˆìœ¼ë¡œì„œëŠ” ESë¥¼ ë„ì…í•˜ëŠ” ê²ƒì´ ê°€ì¥ ìµœì„ ì´ë¼ ì—¬ê²¨ì¡ŒìŠµë‹ˆë‹¤.

![image](https://user-images.githubusercontent.com/56240505/137674715-51fcf017-29dd-4f60-bf16-3004f37e1079.png)

ESë¥¼ ì ìš©í•œ ë‹¤ìŒ ë¶€í•˜ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í–ˆìŠµë‹ˆë‹¤. RDBë¥¼ ì‚¬ìš©í•  ë•Œì™€ í…ŒìŠ¤íŠ¸ ì „ì œ ì¡°ê±´ì€ ë™ì¼í•©ë‹ˆë‹¤. RDBì˜ ê²½ìš° DB Replicationì„ ì ìš©í•´ 2ëŒ€ì˜ Slave DBê°€ ì¡°íšŒë¥¼ ì²˜ë¦¬í–ˆìŒì—ë„ ë¶ˆêµ¬í•˜ê³  í‰ê·  TPSê°€ 38.9ì˜€ìŠµë‹ˆë‹¤.

ê·¸ëŸ¬ë‚˜ ESì˜ ê²½ìš° ë‹¨ 1ëŒ€ì˜ ì„œë²„ë§Œìœ¼ë¡œë„ í‰ê·  TPSê°€ 82.2ë¥¼ ê¸°ë¡í–ˆìŠµë‹ˆë‹¤! ì´ëŠ” RDBë¥¼ ì‚¬ìš©í•˜ëŠ” ê¸°ì¡´ì˜ ë°©ì‹ë³´ë‹¤ ì„±ëŠ¥ì´ 2ë°° ì´ìƒì„ ìƒíšŒí•©ë‹ˆë‹¤. í–¥í›„ ElasticSearch ë˜í•œ í´ëŸ¬ìŠ¤í„°ë§ ë° ìƒ¤ë”© ë“±ì„ ì ìš©í•˜ë©´ ë” ë†’ì€ ì„±ëŠ¥ ë° ê³ ê°€ìš©ì„±ì„ ì–»ì„ ìˆ˜ ìˆê² ë‹¤ê³  ëŠê¼ˆìŠµë‹ˆë‹¤. ğŸ˜Š

<br>

## 5. ë§ˆì¹˜ë©°

> ì„±ëŠ¥ ê°œì„ ê³¼ í´ë¦°ì½”ë“œëŠ” ëì„ ë°”ë¼ë³´ê³  í•˜ëŠ”ê²Œ ì•„ë‹ˆì—ìš”.

Optimizer ì‹¤í–‰ ê³„íš ë¶„ì„ì„ í†µí•´ íŒ€ì›ë“¤ê³¼ ì˜ì‚¬ê²°ì •ì„ ì§„í–‰í•˜ê³ , ì¿¼ë¦¬ íŠœë‹ ë° ë³„ë„ì˜ DB ë„ì…ì„ í†µí•´ ì„œë¹„ìŠ¤ì˜ ì¼ë¶€ ê¸°ëŠ¥ë“¤ì˜ ì„±ëŠ¥ì„ ê°œì„ í–ˆìŠµë‹ˆë‹¤. ê·¸ëŸ¼ì—ë„ ë¶ˆêµ¬í•˜ê³  ì•„ì§ ê°ˆ ê¸¸ì´ ë©€ë‹¤ê³  ëŠê»´ì§‘ë‹ˆë‹¤. ì—¬ì „íˆ ê°œì„ ì´ í•„ìš”í•œ ì¿¼ë¦¬ë“¤ì´ ë§ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

> SQL

```sql
select
    post0_.id as id1_8_0_,
    user1_.id as id1_14_1_,
    post0_.content as content2_8_0_,
    post0_.created_at as created_3_8_0_,
    post0_.github_repo_url as github_r4_8_0_,
    post0_.updated_at as updated_5_8_0_,
    post0_.user_id as user_id6_8_0_,
    user1_.description as descript2_14_1_,
    user1_.image as image3_14_1_,
    user1_.name as name4_14_1_,
    user1_.company as company5_14_1_,
    user1_.github_url as github_u6_14_1_,
    user1_.location as location7_14_1_,
    user1_.twitter as twitter8_14_1_,
    user1_.website as website9_14_1_
from
    post post0_
inner join
    user user1_
        on post0_.user_id=user1_.id
where
    user1_.id in (
        select
            user3_.id
        from
            follow follow2_
        inner join
            user user3_
                on follow2_.target_id=user3_.id
                and (
                    follow2_.source_id=?
                )
        )
        or user1_.id=?
order by
    post0_.created_at desc limit ?
```

ë¡œê·¸ì¸ íšŒì›ì˜ ê²½ìš°, í™ˆ í”¼ë“œë¥¼ ì¡°íšŒí•  ë•Œ ìê¸° ìì‹ ì˜ ê²Œì‹œë¬¼ ë° íŒ”ë¡œì‰ ì¤‘ì¸ ìœ ì €ì˜ ê²Œì‹œë¬¼ë§Œ ì¡°íšŒí•˜ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. ì´ ë¶€ë¶„ ë˜í•œ í˜ì´ì§€ë„¤ì´ì…˜ì´ ê±¸ë ¤ ìˆìŠµë‹ˆë‹¤.

![image](https://user-images.githubusercontent.com/56240505/137677642-e3102376-af67-4357-9b24-d868e9036e60.png)

OR ì ˆ ë•Œë¬¸ì— ì¸ë±ìŠ¤ë¥¼ íƒ€ì§€ ëª»í•´ Table Full Scanì´ ë°œìƒí•  ë¿ë§Œ ì•„ë‹ˆë¼, ì„ì‹œ í…Œì´ë¸” ìƒì„± ë° Filesortë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ê·¸ ê²°ê³¼ ì¿¼ë¦¬ ìˆ˜í–‰ ì†ë„ê°€ ë°°ìš° ëŠë ¤ì§‘ë‹ˆë‹¤. OR ì ˆë§Œ ì‚­ì œí•´ë„ ì¸ë±ìŠ¤ë¥¼ ì‚¬ìš©í•´ ì„±ëŠ¥ì´ ëŒ€í­ í–¥ìƒë˜ëŠ”ë°, í•´ë‹¹ ë¶€ë¶„ì„ ì–´ë–»ê²Œ ê°œì„ í• ì§€ íŒ€ ì°¨ì›ì—ì„œ ì§€ì†ì ìœ¼ë¡œ ë…¼ì˜ ì¤‘ì…ë‹ˆë‹¤. ğŸ§

> SQL

```sql
select
    distinct post1_.id as id1_8_,
    post1_.content as content2_8_,
    post1_.created_at as created_3_8_,
    post1_.github_repo_url as github_r4_8_,
    post1_.updated_at as updated_5_8_,
    post1_.user_id as user_id6_8_
from
    post_tag posttag0_
inner join
    post post1_
        on posttag0_.post_id=post1_.id cross
join
    tag tag2_
where
    posttag0_.tag_id=tag2_.id
    and (
        tag2_.name in (
            ?
        )
    ) limit ?
```

ê²Œì‹œë¬¼ì„ ë³µìˆ˜ ê°œì˜ íƒœê·¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¡°íšŒí•˜ëŠ” ì¿¼ë¦¬ì…ë‹ˆë‹¤. ê²Œì‹œë¬¼ê³¼ íƒœê·¸ëŠ” N:N ê´€ê³„ë¥¼ ë§ºê³  ìˆìœ¼ë©°, íƒœê·¸ ì´ë¦„ì€ ìœ ë‹ˆí¬ ì¸ë±ìŠ¤ê°€ ê±¸ë ¤ìˆìŠµë‹ˆë‹¤.

![image](https://user-images.githubusercontent.com/56240505/137678232-50dce594-f0c3-42d0-9e6e-3d92e400c9f1.png)

Index Range Scanì„ ì‚¬ìš©í•˜ê³  ì»¤ë²„ë§ ì¸ë±ìŠ¤ê°€ ì ìš©ë˜ê³  ìˆìŠµë‹ˆë‹¤.

![image](https://user-images.githubusercontent.com/56240505/137678144-c62872b1-d0a8-4147-917c-f13a349b58cc.png)

í‰ê·  TPSëŠ” 300 ì´ìƒìœ¼ë¡œ ì„±ëŠ¥ ë˜í•œ í˜„ì¬ë¡œì„œëŠ” ë‚˜ë¦„ ì¤€ìˆ˜í•œ í¸ì…ë‹ˆë‹¤. ê·¸ëŸ°ë° í˜„ì¬ SQL ì¿¼ë¦¬ì—ì„œ Cross Joinì´ ë°œìƒí•˜ê³  ìˆìŠµë‹ˆë‹¤. ì„±ëŠ¥ì— ì‹œê¸‰í•œ ì´ìŠˆëŠ” ì—†ì§€ë§Œ ì¶”í›„ ì´ëŸ¬í•œ ë¶€ë¶„ì„ ì œê±°í•  ìˆ˜ ìˆì„ì§€ ë“± ë˜í•œ í•™ìŠµ ì°¨ì›ì—ì„œ íŒ€ì›ë“¤ê³¼ ë…¼ì˜ ì¤‘ì— ìˆìŠµë‹ˆë‹¤. (ë‹¤ë“¤ ì¿¼ë¦¬ íŠœë‹ì´ ì²˜ìŒì¸ì§€ë¼...) ê¸´ ê¸€ ì½ì–´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.

<br>

---

## References

* [í™ˆí”¼ë“œ ì¡°íšŒ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ê²½í—˜ê¸°_1](https://2021-pick-git.github.io/project-pickgit-homefeed-performance-test-2/)
* [í™ˆí”¼ë“œ ì¡°íšŒ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ê²½í—˜ê¸°_2](https://2021-pick-git.github.io/project-pickgit-homefeed-performance-test-2/)
* [MySQL ORDER BY / LIMIT performance: late row lookups](https://explainextended.com/2009/10/23/mysql-order-by-limit-performance-late-row-lookups/)
* [Real MySQL [7-8] ì¿¼ë¦¬ ì‘ì„± ë° ìµœì í™” - WHERE, ORDER BY ì¸ë±ìŠ¤ ì‚¬ìš©](https://weicomes.tistory.com/191)
