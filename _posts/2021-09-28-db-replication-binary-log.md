---
layout: post
title: DB ë¦¬í”Œë¦¬ì¼€ì´ì…˜ ì ìš©ì‹œ Binary ë¡œê·¸ ì—ëŸ¬ í•´ê²°ë°©ë²•
date: 2021-09-28 13:32:20 +0300
description: DB replicationì—ì„œ Master dbì— ì¿¼ë¦¬ ì˜¤ë¥˜ê°€ ë‚¬ì„ ë–„ replicasì—ì„œ í•´ë‹¹ ë¡œê·¸ë¥¼ ê±´ë„ˆë›°ì§€ ëª»í•˜ëŠ” ì˜¤ë¥˜ë¥¼ í•´ê²°í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.
img: database.png
tags: [ë°±ì—”ë“œ, Database]
---


## INTRO

- í˜„ì¬ ì§„í–‰ì¤‘ì¸ [í”„ë¡œì íŠ¸](https://github.com/woowacourse-teams/2021-pick-git)ì—ì„œ DB Replicationì„ ì ìš©í–ˆì—ˆë‹¤. 
  - [Replication ì•Œì•„ë³´ê¸°](https://yjksw.github.io/db-replication/)
- DB replication ì ìš© ì´í›„ Master DBë¥¼ ì—…ê·¸ë ˆì´ë“œ í•´ì•¼í•˜ëŠ” ìƒí™©ì—ì„œ replicasì™€ì˜ ì—°ë™ì— ë¬¸ì œê°€ ìƒê¸´ì ì´ ìˆì—ˆë‹¤. ì´ë•Œ Masterì™€ replicas ê°„ì˜ ë°ì´í„° ì—°ë™ ë°©ë²•ì„ ì´í•´í•˜ê³  í•´ê²°í•œ (ë§¤ìš° ê°„ë‹¨í•œ) ë°©ë²•ì„ ê¸°ë¡í•œë‹¤. 

## Master DBì™€ replicas ë™ê¸°í™” 

- Master DBì— ë°ì´í„°ë¥¼ ì“°ê¸° ìœ„í•´ì„œëŠ” replicasì—ì„œ master db ì˜ ë°ì´í„°ì™€ ì—°ê²°ë˜ì–´ ìˆì–´ì•¼ í•œë‹¤. ê·¸ëŸ¬ê¸° ìœ„í•´ì„œ replicationì„ ì„¤ì •í•  ë•Œ `show master status` ë¼ëŠ” ëª…ë ¹ì–´ë¥¼ í†µí•´ì„œ ë‚˜ì˜¨ `File`ê°’ê³¼ `Position` ê°’ì„ replica db ì„¤ì •ì‹œ ì ìš©í•´ ì£¼ì—ˆë‹¤. 

```mysql
MariaDB [pickgit]> show master status;
+--------------------+----------+--------------+------------------+
| File               | Position | Binlog_Do_DB | Binlog_Ignore_DB |
+--------------------+----------+--------------+------------------+
| mariadb-bin.000008 | 68143505 |              |                  |
+--------------------+----------+--------------+------------------+
1 row in set (0.000 sec)
```

- ì—¬ê¸°ì„œ Fileì€ master dbì˜ binary ë¡œê·¸ íŒŒì¼ì´ê³  Position ê°’ì€ í•´ë‹¹ íŒŒì¼ì˜ í˜„ì¬ ìœ„ì¹˜ì´ë‹¤. 
- ìœ„ log íŒŒì¼ì—ëŠ” ì–´ë–¤ ë‚´ìš©ì´ ë‹´ê²¨ ìˆì„ê¹Œ?
  > The MariaDB binary log is a series of files that contain events. An event is a description of a modification to the contents of our database. <br>ì¶œì²˜: Big Data and Business Intelligence
- ë¡œê·¸ íŒŒì¼ì—ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì¼ì–´ë‚œ `event`ë“¤ì— ëŒ€í•´ì„œ ì í˜€ ìˆëŠ”ë°, `event`ë¼ê³  í•˜ëŠ” ê²ƒì€ ë°ì´í„°ë² ì´ìŠ¤ì˜ ì»¨í…ì¸ ì— ëŒ€í•´ ì¼ì–´ë‚œ ë³€ê²½ì‚¬í•­ì„ ë§í•œë‹¤. 

```mysql
MariaDB [pickgit]> show master status;
+--------------------+----------+--------------+------------------+
| File               | Position | Binlog_Do_DB | Binlog_Ignore_DB |
+--------------------+----------+--------------+------------------+
| mariadb-bin.000008 | 68143656 |              |                  |
+--------------------+----------+--------------+------------------+
1 row in set (0.000 sec)
```

- ì‹¤ì œë¡œ í…Œì´ë¸”ì„ ì¶”ê°€í•˜ëŠ” ì¿¼ë¦¬ë¥¼ ë‚ ë¦° í›„ ë‹¤ì‹œ í™•ì¸í•´ë³´ë‹ˆ Positionê°’ì´ ì¦ê°€í•œ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. 
- Replicas ì„¤ì •ì‹œ ìœ„ ê°’ì„ ì§€ì •í•œë‹¤ëŠ” ê²ƒì€ replicasì— ë°ì´í„°ë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” fileê³¼ í•´ë‹¹ fileì—ì„œì˜ ìœ„ì¹˜ë¥¼ ì§€ì •í•˜ëŠ” ê²ƒì´ë‹¤. 
- ë²ˆì™¸ë¡œ ë§Œì¼ binary logginì´ ë¹„í™œì„±ë˜ì–´ ìˆëŠ” ìƒíƒœì—ì„œ master ë°ì´í„°ë² ì´ìŠ¤ê°€ ì‹¤í–‰ì¤‘ì´ì—ˆë‹¤ë©´ `show master status;` ëª…ë ¹ì–´ì— ë‚˜ì˜¤ëŠ” ê°’ì´ ë¹„ì–´ìˆì„ ê²ƒì´ë‹¤. ê·¸ ê²½ìš° replicasì— masterì˜ ë¡œê·¸íŒŒì¼ê³¼ positionì„ ì§€ì •í•  ë•Œ ë¹ˆ ìŠ¤íŠ¸ë§ ('')ê³¼ 4ë¥¼ ì§€ì •í•˜ë©´ ëœë‹¤. 


## ë¬¸ì œìƒí™© ë° í•´ê²° 
- ë³¸ë˜ ì‚¬ìš©í•œ MariaDB ë²„ì „ì€ 10.1ì´ì—ˆë‹¤. í•˜ì§€ë§Œ Flywayë¥¼ ì ìš©í•œ ì´í›„ MariaDBë¥¼ 10.4ë¡œ ì—…ê·¸ë ˆì´ë“œ í•˜ì§€ ì•Šìœ¼ë©´ ì ìš©í•  ìˆ˜ ì—†ë‹¤ëŠ” ì˜¤ë¥˜ê°€ ìƒê²¼ë‹¤. MariaDB ë²„ì „ì„ ì—…ê·¸ë ˆì´ë“œ í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì„ ì°¾ì•„ë³´ì•˜ì§€ë§Œ í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ DB ë°ì´í„°ë¥¼ ë°±ì—…í•˜ê³  ì‚­ì œ í›„ 10.4 ë²„ì „ì„ ìƒˆë¡œ ì„¤ì¹˜í•˜ì—¬ ë°ì´í„°ë¥¼ ë³µì›í•˜ë¼ëŠ” ë‚´ìš©ë°–ì— ë‚˜ì˜¤ì§€ ì•Šì•˜ë‹¤. 
- í˜„ì¬ Master 1ê°œ slave 2ê°œë¥¼ ì‚¬ìš©ì¤‘ì´ì—ˆê¸° ë•Œë¬¸ì— DB 3ê°œë¥¼ ëª¨ë‘ ì‚­ì œí•˜ê³  ì¬ì„¤ì¹˜í•˜ëŠ” ê²ƒì€ ì§€ë‚˜ì¹˜ê²Œ ë§ì€ ì‘ì—…ì´ë¼ê³  ìƒê°í–ˆë‹¤. (replication ì„¤ì •, ìœ ì € ìƒì„± ë° ê¶Œí•œ ë¶€ì—¬ ë“±ë“± ìì˜í•œ ì„¤ì •ì´ ë§ìŒ) ë”°ë¼ì„œ Flywayê°€ ì§ì ‘ ì ìš©ë˜ëŠ” Master DBë§Œ ìˆ˜ì •í•˜ê³  Slave DBëŠ” ê¸°ì¡´ì˜ ê²ƒì„ ìœ ì§€í•˜ê¸°ë¡œ í–ˆë‹¤. 
- Master DBë¥¼ ìƒˆë¡œ êµ¬ì„±í•˜ëŠ” ì™€ì¤‘ì— ë‹¤ìŒê³¼ ê°™ì€ ë¬¸ì œ ìƒí™©ì´ ë°œìƒí–ˆë‹¤. 
  - ë¬¸ì œ ìƒí™©
    - Master DBì˜ ì„¤ì •ì„ ë§ˆì¹˜ê³  Slaveì— Masterë¥¼ ì§€ì •í•˜ì—¬ ì—°ê²°ì„ ì™„ë£Œí•¨ 
    - Master DBì˜ `replication` ìœ ì €ì—ê²Œ ì™¸ë¶€ì—ì„œ ì“°ê¸° ê¶Œí•œì„ ë¶€ì—¬í•˜ì§€ ì•Šì€ ê²ƒì„ ê¹¨ë‹¬ìŒ 
    - Master DBì˜ `replication` ìœ ì €ì—ê²Œ ê¶Œí•œì„ ë¶€ì—¬í•¨
    - Slave DBì— Master DBì˜ ë°ì´í„°ê°€ ë°˜ì˜ì´ ë˜ì§€ ì•ŠìŒ  

- Masterì—ì„œ ì—°ê²°ëœ slave hostsë¥¼ í™•ì¸í•´ ë³´ë©´ ì˜ ì—°ê²°ë˜ì–´ ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. 
  
  ```mysql
    MariaDB [pickgit]> show slave hosts;
  +-----------+------+------+-----------+
  | Server_id | Host | Port | Master_id |
  +-----------+------+------+-----------+
  |         3 |      | 9000 |         1 |
  |         2 |      | 9000 |         1 |
  +-----------+------+------+-----------+
  2 rows in set (0.000 sec)
  ```

- Slave ì˜ ìƒíƒœë¥¼ í™•ì¸í•´ë³´ë©´ `Slave_IO_State: Waiting for master to sent event` ë¼ê³  ë‚˜ì™€ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. 

<p align="center"><img width="90%" src="https://user-images.githubusercontent.com/63405904/134805936-9f3469e3-aa3e-496f-91b3-ae5b7f6e881d.png"></p>

- ìœ„ ìƒíƒœì˜ ë” ì•„ë˜ì— `Last_Error` ì™€ `Last_SQL_Error`ë¥¼ í™•ì¸í•´ë³´ë©´ íŠ¹ì • ì¿¼ë¦¬ì— ì—ëŸ¬ê°€ ë°œìƒí–ˆë‹¤ëŠ” ë¡œê·¸ê°€ ì¶œë ¥ë˜ì–´ ìˆë‹¤. ì¦‰, `replication` ì´ë¼ëŠ” ìœ ì €ê°€ Masterì—ì„œëŠ” ì˜ ì ìš©ì´ ë˜ì—ˆì§€ë§Œ Slave DBì—ëŠ” ì¡´ì¬í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ì—ëŸ¬ê°€ ë°œìƒí•œ ê²ƒì´ë‹¤. í•´ë‹¹ ë¡œê·¸ ì´í›„ì— ì¶”ê°€ ë° ë³€ê²½ëœ ë°ì´í„°ì— ëŒ€í•´ì„œëŠ” slave dbì— ë” ì´ìƒ ë°˜ì˜ì´ ë˜ì§€ ì•Šì•˜ë‹¤. 

- ìœ„ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ì„œëŠ” Slave DBê°€ Masterì˜ ë¡œê·¸ íŒŒì¼ì„ ì½ëŠ” Positionì„ ìœ„ ì¿¼ë¦¬ê°€ ì‹¤í–‰ëœ ì´í›„ë¡œ ì˜®ê²¨ì„œ í•´ë‹¹ ì¿¼ë¦¬ë¥¼ ê±´ë„ˆë›°ì–´ì•¼ í•œë‹¤. ë”°ë¼ì„œ `show master status`ë¥¼ ë‹¤ì‹œ ì‹¤í–‰í•˜ì—¬ ë‚˜ì˜¨ ìµœì‹  positionì„ slave DB ì„¤ì •ì— ë„£ì–´ì£¼ì–´ ë¬¸ì œë¥¼ í•´ê²°í–ˆë‹¤. ì—¬ê¸°ì„œ ì£¼ì˜í•  ì ì€ ë§Œì¼ ì´ì „ì— ë³€ê²½ëœ ë°ì´í„°ê°€ ìˆë‹¤ë©´ í•´ë‹¹ ë³€ê²½ ë¡œê·¸ë„ ëª¨ë‘ ê±´ë„ˆë›°ê²Œ ë˜ë‹ˆ ë‹¤ì‹œ ì ìš©í•´ì£¼ì–´ì•¼ í•œë‹¤. 

**[ì°¸ê³ ìë£Œ]**
- [https://dev.mysql.com/doc/refman/8.0/en/replication-setup-replicas.html#replication-howto-newservers](https://dev.mysql.com/doc/refman/8.0/en/replication-setup-replicas.html#replication-howto-newservers)
- [https://dev.mysql.com/doc/refman/8.0/en/replication-howto-masterstatus.html](https://dev.mysql.com/doc/refman/8.0/en/replication-howto-masterstatus.html)

<br>
<br>

> ë°±ì—”ë“œ ì½”ë‹¤ì…ë‹ˆë‹¤ ğŸ™Œ
