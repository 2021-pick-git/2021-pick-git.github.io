<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>JPA Pagination, ê·¸ë¦¬ê³  N + 1 ë¬¸ì œ - BingheCompany ğŸ‡°ğŸ‡·</title>

  <!-- Edit site and author settings in `_config.yml` to make the social details your own -->

    <meta content="BingheCompany ğŸ‡°ğŸ‡·" property="og:site_name">
  
    <meta content="JPA Pagination, ê·¸ë¦¬ê³  N + 1 ë¬¸ì œ" property="og:title">
  
  
    <meta content="article" property="og:type">
  
  
    <meta content="Paginationê³¼ Fetch Joinì„ í•¨ê»˜ ì‚¬ìš©í•  ë•Œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ë¬¸ì œë¥¼ ëŒ€ì²˜í•´ë´…ì‹œë‹¤." property="og:description">
  
  
    <meta content="https://2021-pick-git.github.io//pagination-n-plus-one/" property="og:url">
  
  
    <meta content="2021-09-28T19:32:20+09:00" property="article:published_time">
    <meta content="https://2021-pick-git.github.io//about/" property="article:author">
  
  
    <meta content="https://2021-pick-git.github.io//assets/img/nplusone.jpeg" property="og:image">
  
  
    
  
  
    
    <meta content="ë°±ì—”ë“œ" property="article:tag">
    
    <meta content="JPA" property="article:tag">
    
  

    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@">
    <meta name="twitter:creator" content="@">
  
    <meta name="twitter:title" content="JPA Pagination, ê·¸ë¦¬ê³  N + 1 ë¬¸ì œ">
  
  
    <meta name="twitter:url" content="https://2021-pick-git.github.io//pagination-n-plus-one/">
  
  
    <meta name="twitter:description" content="Paginationê³¼ Fetch Joinì„ í•¨ê»˜ ì‚¬ìš©í•  ë•Œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ë¬¸ì œë¥¼ ëŒ€ì²˜í•´ë´…ì‹œë‹¤.">
  
  
    <meta name="twitter:image:src" content="https://2021-pick-git.github.io//assets/img/nplusone.jpeg">
  

	<meta name="description" content="Paginationê³¼ Fetch Joinì„ í•¨ê»˜ ì‚¬ìš©í•  ë•Œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ë¬¸ì œë¥¼ ëŒ€ì²˜í•´ë´…ì‹œë‹¤.">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta property="og:image" content="">
	<link rel="shortcut icon" href="/assets/img/favicon/favicon.ico" type="image/x-icon">
	<link rel="apple-touch-icon" href="/assets/img/favicon/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicon/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicon/apple-touch-icon-144x144.png">
	<!-- Chrome, Firefox OS and Opera -->
	<meta name="theme-color" content="#263959">
	<!-- Windows Phone -->
	<meta name="msapplication-navbutton-color" content="#263959">
	<!-- iOS Safari -->
	<meta name="apple-mobile-web-app-status-bar-style" content="#263959">
	<!-- Google Fonts -->
	<link href="https://fonts.googleapis.com/css?family=PT+Serif:400,700|Lato:300,400,700&display=swap" rel="stylesheet">
	<!-- Font Awesome -->
	<link rel="stylesheet" href="/assets/fonts/font-awesome/css/font-awesome.min.css">
	<!-- Styles -->
	<link rel="stylesheet" href="/assets/css/main.css">
</head>

<body>

  <div class="wrapper">
    <aside class="sidebar">
  <header>
    <div class="about">
      <div class="cover-author-image">
        <a href="/"><img src="/assets/img/mark.jpg" alt="ê¹ƒ-ë“¤ë‹¤ (pick-git)"></a>
      </div>
      <div class="author-name">ê¹ƒ-ë“¤ë‹¤ (pick-git)</div>
      <p>ê¹ƒ-ë“¤ë‹¤ ê¸°ìˆ  ë¸”ë¡œê·¸ì…ë‹ˆë‹¤.</br>ğŸ˜‡ğŸ’ª</br> This is a tech blog for pick-git.</br> ãƒ”ã‚¯ã‚®ãƒˆã®æŠ€è¡“ã®blogã§ã™ã€‚</br> è¿™æ˜¯ pick-git ç§‘æŠ€åšå®¢.</br></p>
    </div>
  </header> <!-- End Header -->
  <footer>
    <section class="contact">
      <h3 class="contact-title">Contact me</h3>
      <ul>
        
          <li><a href="https://twitter.com/artemsheludko_" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
        
        
          <li><a href="https://facebook.com/" target="_blank"><i class="fa fa-facebook" aria-hidden="true"></i></a></li>
        
        
          <li class="github"><a href="http://github.com/woowacourse-teams/2021-pick-git" target="_blank"><i class="fa fa-github"></i></a></li>
        
        
          <li class="linkedin"><a href="https://in.linkedin.com/" target="_blank"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li>
        
        
          <li class="email"><a href="mailto:example.david@blog.com"><i class="fa fa-envelope-o" aria-hidden="true"></i></a></li>
        
      </ul>
    </section> <!-- End Section Contact -->
    <div class="copyright">
      <p>2021 &copy; ê¹ƒ-ë“¤ë‹¤ (pick-git)</p>
    </div>
  </footer> <!-- End Footer -->
</aside> <!-- End Sidebar -->
<div class="content-box clearfix">
  <article class="article-page">
  <div class="page-content">
    
    <div class="page-cover-image">
      <figure>
        <img class="page-image" src=/assets/img/nplusone.jpeg alt="JPA Pagination, ê·¸ë¦¬ê³  N + 1 ë¬¸ì œ">
        
      </figure>
    </div> <!-- End Page Cover Image -->
    
    <div class="wrap-content">
      <header class="header-page">
        <h1 class="page-title">JPA Pagination, ê·¸ë¦¬ê³  N + 1 ë¬¸ì œ</h1>
        <div class="page-date"><span>2021, Sep 28&nbsp;&nbsp;&nbsp;&nbsp;</span></div>
      </header>
      <h2 id="1-ë“¤ì–´ê°€ë©°">1. ë“¤ì–´ê°€ë©°</h2>

<p>ì•ˆë…•í•˜ì„¸ìš”, ì¼€ë¹ˆì…ë‹ˆë‹¤. ê²Œì‹œíŒ ê¸°ëŠ¥ì„ ì œê³µí•˜ëŠ” ì›¹ ì–´í”Œë¦¬ì¼€ì´ì…˜ì— ì ‘ì†í•˜ì—¬ ê²Œì‹œë¬¼ ëª©ë¡ì„ ìš”ì²­í•˜ëŠ” ê²½ìš°ë¥¼ ìƒìƒí•´ë´…ì‹œë‹¤. DBì— ì €ì¥ë˜ì–´ ìˆëŠ” ê²Œì‹œë¬¼ì€ ìˆ˜ë°± ë§Œê°œì— ìœ¡ë°•í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ëª¨ë“  ê²Œì‹œë¬¼ ëª©ë¡ì„ ì¡°íšŒí•´ í™”ë©´ì— ë Œë”ë§í•˜ëŠ” ê²½ìš°, í´ë¼ì´ì–¸íŠ¸ê°€ ë¸Œë¼ìš°ì € í˜¹ì€ ëª¨ë°”ì¼ ê¸°ê¸°ë¡œ ì´ë¥¼ í•œ ëˆˆì— ë³´ê¸° ì–´ë ¤ì›€ì„ ê²ªì„ ê³µì‚°ì´ í½ë‹ˆë‹¤. ë˜í•œ í´ë¼ì´ì–¸íŠ¸ê°€ ë³´ì§€ë„ ì•Šì„ ë°ì´í„°ê¹Œì§€ DBì—ì„œ ì¡°íšŒí•˜ì—¬ ë„¤íŠ¸ì›Œí¬ë¥¼ í†µí•´ ì „ë‹¬í•˜ê¸° ë•Œë¬¸ì—, ì„œë²„ì˜ ë¦¬ì†ŒìŠ¤ê°€ ë¶ˆí•„ìš”í•˜ê²Œ ë‚­ë¹„ë©ë‹ˆë‹¤.</p>

<p><img src="https://user-images.githubusercontent.com/56240505/126959267-f01b6829-19bf-4662-829b-651049cc55c2.png" alt="image" /></p>

<p>ë°˜ë©´ ìœ„ ì‚¬ì§„ì²˜ëŸ¼ í•œ í˜ì´ì§€ì—ì„œëŠ” Nê°œì˜ ë°ì´í„°ë§Œ ë³´ì—¬ì£¼ê³ , ë‹¤ìŒ í˜ì´ì§€ë¡œ ì´ë™í•˜ë¼ëŠ” í´ë¼ì´ì–¸íŠ¸ì˜ ì¶”ê°€ ìš”ì²­ì´ ìˆì„ ë•Œ ë§ˆë‹¤ ë‹¤ìŒ ìˆœë²ˆì˜ Nê°œì˜ ë°ì´í„°ë¥¼ ë³´ì—¬ì¤€ë‹¤ë©´ UX ë° ë¦¬ì†ŒìŠ¤ ì¸¡ë©´ì˜ ë‹¨ì ì„ ë³´ì™„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ì²˜ëŸ¼ í•œ í™”ë©´ì— ë³´ì—¬ì£¼ëŠ” ë°ì´í„°ì˜ ë²”ìœ„ë¥¼ ê²°ì •í•˜ëŠ” ì¼ë ¨ì˜ ë°©ì‹ì„ í˜ì´ì§€ë„¤ì´ì…˜ í˜¹ì€ í˜ì´ì§•ì´ë¼ê³  í•©ë‹ˆë‹¤. Pick-Gitì€ ìœ„ ì‚¬ì§„ê³¼ ê°™ì´ ê²Œì‹œíŒ í˜•íƒœê°€ ì•„ë‹Œ ì¸í”¼ë‹ˆí‹° ìŠ¤í¬ë¡¤ì„ ê¸°ë°˜ìœ¼ë¡œ í˜ì´ì§€ë„¤ì´ì…˜ì„ ì ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  ì´ë²ˆ ê¸€ì—ì„œëŠ” Pick-Gitì„ ê°œë°œí•˜ë©´ì„œ ë‹¹ë©´í–ˆë˜ JPA Pagination ë° N + 1 ë¬¸ì œ ë° í•´ê²° ë°©ë²•ì„ ê³µìœ í•˜ê³ ì í•©ë‹ˆë‹¤.</p>

<p><br /></p>

<h2 id="2-pagination">2. Pagination</h2>

<p>ì¼ë°˜ì ìœ¼ë¡œ DB ë²¤ë”ì— ë”°ë¼ í˜ì´ì§•ì„ ì²˜ë¦¬í•˜ëŠ” ì¿¼ë¦¬ê°€ ì²œì°¨ë§Œë³„ì…ë‹ˆë‹¤. MySQLì˜ ê²½ìš° LIMIT ë° OFFSET êµ¬ë¬¸ ë“±ì„ ì‚¬ìš©í•¨ìœ¼ë¡œì¨ í˜ì´ì§•ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆì§€ë§Œ, Oracleì€ ê·¸ë³´ë‹¤ ë” ë³µì¡í•œ ì¿¼ë¦¬ê°€ ìˆ˜ë°˜ë©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ JPAë¥¼ ì‚¬ìš©í•œë‹¤ë©´ ë³„ë„ì˜ ì¿¼ë¦¬ ì‘ì„± ì—†ì´ Pagination APIë¥¼ ì‚¬ìš©í•˜ê¸°ë§Œ í•˜ë©´ ë©ë‹ˆë‹¤. JPAê°€ ì„¤ì •ëœ DB ë²¤ë” ë°©ì–¸ì— ë§ê²Œ í˜ì´ì§• ì¿¼ë¦¬ë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</p>

<blockquote>
  <p>PostRepository.java</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Query</span><span class="o">(</span><span class="s">"select p from Post p"</span><span class="o">)</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Post</span><span class="o">&gt;</span> <span class="nf">findWithPagination</span><span class="o">(</span><span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">);</span>
</code></pre></div></div>

<blockquote>
  <p>PostRepositoryTest.java</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@DisplayName</span><span class="o">(</span><span class="s">"Pageableì„ ì‚¬ìš©í•˜ì—¬ í˜ì´ì§• ì²˜ë¦¬í•œë‹¤."</span><span class="o">)</span>
<span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">pagination</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">postRepository</span><span class="o">.</span><span class="na">findWithPagination</span><span class="o">(</span><span class="nc">Pageable</span><span class="o">.</span><span class="na">ofSize</span><span class="o">(</span><span class="mi">10</span><span class="o">));</span>
    <span class="c1">// postRepository.findWithPagination(PageRequest.of(0, 2)); ê°€ëŠ¥</span>
<span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <p>SQL</p>
</blockquote>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Hibernate</span><span class="p">:</span>
    <span class="k">select</span>
        <span class="n">post0_</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">id1_4_</span><span class="p">,</span>
        <span class="n">post0_</span><span class="p">.</span><span class="n">content</span> <span class="k">as</span> <span class="n">content2_4_</span>
    <span class="k">from</span>
        <span class="n">post</span> <span class="n">post0_</span> <span class="k">limit</span> <span class="o">?</span>
</code></pre></div></div>

<p>Spring Data JPAì˜ ê²½ìš° Pageable êµ¬í˜„ì²´ë¥¼ Repository ì¿¼ë¦¬ ë©”ì„œë“œì˜ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬í•¨ìœ¼ë¡œì¨ ì¿¼ë¦¬ì— í˜ì´ì§•ì„ ë™ì ìœ¼ë¡œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê°œë°œìê°€ Pageable ì¸í„°í˜ì´ìŠ¤ë¥¼ ì§ì ‘ êµ¬í˜„í•˜ê±°ë‚˜, ë¯¸ë¦¬ ì¤€ë¹„ë˜ì–´ ìˆëŠ” ì •ì  íŒ©í† ë¦¬ ë©”ì„œë“œë¥¼ í†µí•´ ê°„í¸í•˜ê²Œ í˜ì´ì§€ë„¤ì´ì…˜ ë²”ìœ„ë¥¼ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í˜„ì¬ ì„¤ì •ëœ ë°©ì–¸ì— ë”°ë¼ JPQL ì¿¼ë¦¬ ë° í˜ì´ì§€ë„¤ì´ì…˜ ê¸°ëŠ¥ì´ SQL ì¿¼ë¦¬ë¡œ ë³€í™˜ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p><br /></p>

<h2 id="3-n--1-ë°-fetch-join">3. N + 1 ë° Fetch Join</h2>

<blockquote>
  <p>Post.java</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Post</span> <span class="o">{</span>

    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="nc">GenerationType</span><span class="o">.</span><span class="na">IDENTITY</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@ManyToOne</span><span class="o">(</span><span class="n">fetch</span> <span class="o">=</span> <span class="nc">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"user_id"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">User</span> <span class="n">user</span><span class="o">;</span>

    <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span> <span class="o">=</span> <span class="s">"post"</span><span class="o">,</span> <span class="n">fetch</span> <span class="o">=</span> <span class="nc">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Image</span><span class="o">&gt;</span> <span class="n">images</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

    <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span> <span class="o">=</span> <span class="s">"post"</span><span class="o">,</span> <span class="n">fetch</span> <span class="o">=</span> <span class="nc">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Like</span><span class="o">&gt;</span> <span class="n">likes</span><span class="o">;</span>

    <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span> <span class="o">=</span> <span class="s">"post"</span><span class="o">,</span> <span class="n">fetch</span> <span class="o">=</span> <span class="nc">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Comment</span><span class="o">&gt;</span> <span class="n">comments</span><span class="o">;</span>

    <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span> <span class="o">=</span> <span class="s">"post"</span><span class="o">,</span> <span class="n">fetch</span> <span class="o">=</span> <span class="nc">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">PostTag</span><span class="o">&gt;</span> <span class="n">postTags</span><span class="o">;</span>

    <span class="c1">// ...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Pick-Git í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš©í•˜ëŠ” Post ì—”í‹°í‹°ë¥¼ ê°„ëµí•˜ê²Œ í‘œí˜„í•œ ì˜ˆì œ ì½”ë“œì…ë‹ˆë‹¤.</p>

<blockquote>
  <p>PostService.java</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">PostResponseDto</span><span class="o">&gt;</span> <span class="nf">homeFeed</span><span class="o">(</span><span class="nc">HomeFeedRequestDto</span> <span class="n">homeFeedRequestDto</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Pageable</span> <span class="n">pageable</span> <span class="o">=</span> <span class="n">getPagination</span><span class="o">(</span><span class="n">homeFeedRequestDto</span><span class="o">);</span>
    <span class="nc">User</span> <span class="n">requestUser</span> <span class="o">=</span> <span class="n">findUserByName</span><span class="o">(</span><span class="n">homeFeedRequestDto</span><span class="o">.</span><span class="na">getRequestUserName</span><span class="o">());</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Post</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">postRepository</span><span class="o">.</span><span class="na">findAllAssociatedPostsByUser</span><span class="o">(</span><span class="n">requestUser</span><span class="o">,</span> <span class="n">pageable</span><span class="o">);</span>
    <span class="k">return</span> <span class="nc">PostDtoAssembler</span><span class="o">.</span><span class="na">assembleFrom</span><span class="o">(</span><span class="n">requestUser</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ë³µìˆ˜ê±´ì˜ ê²Œì‹œë¬¼ ì¡°íšŒ ìš”ì²­ì˜ ê²½ìš°, Pagination APIë¥¼ ë°”íƒ•ìœ¼ë¡œ ê²Œì‹œë¬¼ì„ ì¡°íšŒí•©ë‹ˆë‹¤.</p>

<blockquote>
  <p>PostResponseDto.java</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PostResponseDto</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">imageUrls</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">authorName</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Integer</span> <span class="n">likesCount</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">tags</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">CommentResponseDto</span><span class="o">&gt;</span> <span class="n">comments</span><span class="o">;</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ì´í›„ Post ì—”í‹°í‹° ë‚´ë¶€ í•„ë“œ(ì—°ê´€ ì—”í‹°í‹°)ë“¤ì„ <code class="language-plaintext highlighter-rouge">getter</code>ë¡œ í˜¸ì¶œí•´ ê°€ê³µí•˜ì—¬ ì‘ë‹µ DTOë¥¼ ì‘ì„±í•©ë‹ˆë‹¤. ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ê³  ë³´ë‹ˆ JPAê°€ Post í˜ì´ì§• ì¡°íšŒ ì¿¼ë¦¬ 1ê±´ ì´ì™¸ì—ë„ ì¶”ê°€ì ìœ¼ë¡œ 5ê±´(Comment, Like, Image, User, Tag)ì˜ ì¡°íšŒ ì¿¼ë¦¬ë¥¼ ë‚ ë¦¬ê³  ìˆì—ˆìŠµë‹ˆë‹¤. ì¦‰, í•œ ê°œì˜ íŠ¸ëœì­ì…˜ì„ ì²˜ë¦¬í•˜ëŠ”ë° ì´ 6ë²ˆì˜ SQL ì¡°íšŒ ì¿¼ë¦¬ê°€ ë°œìƒí•˜ëŠ” ì‹¬ê°í•œ ë¬¸ì œì˜€ìŠµë‹ˆë‹¤.</p>

<p>ì´ëŸ¬í•œ í˜„ìƒì„ N + 1 ì´ë¼ê³  í•©ë‹ˆë‹¤. ì¿¼ë¦¬ 1ë²ˆìœ¼ë¡œ Nê±´ì˜ ì—”í‹°í‹°ë¥¼ ê°€ì ¸ì™”ëŠ”ë°, ê¸€ë¡œë²Œ ì§€ì—° ë¡œë”© ì „ëµìœ¼ë¡œ ì¸í•´ ê´€ë ¨ ì»¬ëŸ¼ì„ ì–»ê¸° ìœ„í•´ ì¿¼ë¦¬ë¥¼ Në²ˆ ì¶”ê°€ë¡œ ìˆ˜í–‰í•˜ëŠ” í˜„ìƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ í†µí•´ ë” ìì„¸íˆ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.</p>

<blockquote>
  <p>PostRepositoryTest.java</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@DisplayName</span><span class="o">(</span><span class="s">"Pageableì„ ì‚¬ìš©í•˜ì—¬ í˜ì´ì§• ì²˜ë¦¬í•œë‹¤."</span><span class="o">)</span>
<span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">pagination</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Post</span><span class="o">&gt;</span> <span class="n">posts</span> <span class="o">=</span> <span class="n">postRepository</span><span class="o">.</span><span class="na">findWithPagination</span><span class="o">(</span><span class="nc">PageRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">3</span><span class="o">));</span>

    <span class="k">for</span> <span class="o">(</span><span class="nc">Post</span> <span class="n">post</span> <span class="o">:</span> <span class="n">posts</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">post</span><span class="o">.</span><span class="na">getComments</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <p>SQL</p>
</blockquote>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Hibernate</span><span class="p">:</span>
    <span class="k">select</span>
        <span class="n">post0_</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">id1_4_</span><span class="p">,</span>
        <span class="n">post0_</span><span class="p">.</span><span class="n">content</span> <span class="k">as</span> <span class="n">content2_4_</span>
    <span class="k">from</span>
        <span class="n">post</span> <span class="n">post0_</span> <span class="k">limit</span> <span class="o">?</span>
<span class="n">Hibernate</span><span class="p">:</span>
    <span class="k">select</span>
        <span class="n">comments0_</span><span class="p">.</span><span class="n">post_id</span> <span class="k">as</span> <span class="n">post_id4_2_0_</span><span class="p">,</span>
        <span class="n">comments0_</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">id1_2_0_</span><span class="p">,</span>
        <span class="n">comments0_</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">id1_2_1_</span><span class="p">,</span>
        <span class="n">comments0_</span><span class="p">.</span><span class="n">content</span> <span class="k">as</span> <span class="n">content2_2_1_</span><span class="p">,</span>
        <span class="n">comments0_</span><span class="p">.</span><span class="n">like_id</span> <span class="k">as</span> <span class="n">like_id3_2_1_</span><span class="p">,</span>
        <span class="n">comments0_</span><span class="p">.</span><span class="n">post_id</span> <span class="k">as</span> <span class="n">post_id4_2_1_</span>
    <span class="k">from</span>
        <span class="k">comment</span> <span class="n">comments0_</span>
    <span class="k">where</span>
        <span class="n">comments0_</span><span class="p">.</span><span class="n">post_id</span><span class="o">=?</span>
<span class="p">[</span><span class="n">com</span><span class="p">.</span><span class="n">learning</span><span class="p">.</span><span class="n">jpa</span><span class="p">.</span><span class="k">domain</span><span class="p">.</span><span class="k">Comment</span><span class="o">@</span><span class="mi">3</span><span class="n">a1238cc</span><span class="p">]</span>
<span class="n">Hibernate</span><span class="p">:</span>
    <span class="k">select</span>
        <span class="n">comments0_</span><span class="p">.</span><span class="n">post_id</span> <span class="k">as</span> <span class="n">post_id4_2_0_</span><span class="p">,</span>
        <span class="n">comments0_</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">id1_2_0_</span><span class="p">,</span>
        <span class="n">comments0_</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">id1_2_1_</span><span class="p">,</span>
        <span class="n">comments0_</span><span class="p">.</span><span class="n">content</span> <span class="k">as</span> <span class="n">content2_2_1_</span><span class="p">,</span>
        <span class="n">comments0_</span><span class="p">.</span><span class="n">like_id</span> <span class="k">as</span> <span class="n">like_id3_2_1_</span><span class="p">,</span>
        <span class="n">comments0_</span><span class="p">.</span><span class="n">post_id</span> <span class="k">as</span> <span class="n">post_id4_2_1_</span>
    <span class="k">from</span>
        <span class="k">comment</span> <span class="n">comments0_</span>
    <span class="k">where</span>
        <span class="n">comments0_</span><span class="p">.</span><span class="n">post_id</span><span class="o">=?</span>
<span class="p">[</span><span class="n">com</span><span class="p">.</span><span class="n">learning</span><span class="p">.</span><span class="n">jpa</span><span class="p">.</span><span class="k">domain</span><span class="p">.</span><span class="k">Comment</span><span class="o">@</span><span class="n">ce5df3f</span><span class="p">]</span>
<span class="n">Hibernate</span><span class="p">:</span>
    <span class="k">select</span>
        <span class="n">comments0_</span><span class="p">.</span><span class="n">post_id</span> <span class="k">as</span> <span class="n">post_id4_2_0_</span><span class="p">,</span>
        <span class="n">comments0_</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">id1_2_0_</span><span class="p">,</span>
        <span class="n">comments0_</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">id1_2_1_</span><span class="p">,</span>
        <span class="n">comments0_</span><span class="p">.</span><span class="n">content</span> <span class="k">as</span> <span class="n">content2_2_1_</span><span class="p">,</span>
        <span class="n">comments0_</span><span class="p">.</span><span class="n">like_id</span> <span class="k">as</span> <span class="n">like_id3_2_1_</span><span class="p">,</span>
        <span class="n">comments0_</span><span class="p">.</span><span class="n">post_id</span> <span class="k">as</span> <span class="n">post_id4_2_1_</span>
    <span class="k">from</span>
        <span class="k">comment</span> <span class="n">comments0_</span>
    <span class="k">where</span>
        <span class="n">comments0_</span><span class="p">.</span><span class="n">post_id</span><span class="o">=?</span>
<span class="p">[</span><span class="n">com</span><span class="p">.</span><span class="n">learning</span><span class="p">.</span><span class="n">jpa</span><span class="p">.</span><span class="k">domain</span><span class="p">.</span><span class="k">Comment</span><span class="o">@</span><span class="mi">5</span><span class="n">ab690ec</span><span class="p">]</span>
</code></pre></div></div>

<p>í˜ì´ì§•ìœ¼ë¡œ ì¡°íšŒí•œ Nê°œì˜ Post ì—”í‹°í‹°ë¥¼ ìˆœíšŒí•˜ë©° Commentë¥¼ ì¡°íšŒí•´ë´…ì‹œë‹¤. PostëŠ” 1:N ê´€ê³„ë¥¼ ë§ºê³  ìˆëŠ” Commentì— ëŒ€í•´ ê¸€ë¡œë²Œ ì§€ì—° ë¡œë”© ì „ëµì„ ì±„íƒí•˜ê³  ìˆìŠµë‹ˆë‹¤. ê·¸ ê²°ê³¼, í˜ì´ì§•(LIMIT)ì„ í†µí•´ ì¡°íšŒí•œ Post ë¦¬ìŠ¤íŠ¸ë¥¼ ìˆœíšŒí•˜ë©´ì„œ <code class="language-plaintext highlighter-rouge">getComments()</code>ë¥¼ í˜¸ì¶œí•  ë•Œë§ˆë‹¤ ì¶”ê°€ì ìœ¼ë¡œ Comment ì¡°íšŒ ì¿¼ë¦¬ê°€ ë°œìƒí•©ë‹ˆë‹¤. ì¦‰, ì¡°íšŒí•œ Postê°€ 1000ê°œë¼ë©´ 1000ê°œì˜ ì¶”ê°€ ì¿¼ë¦¬ê°€ ë°œìƒí•˜ëŠ” ì „í˜•ì ì¸ <strong>N + 1 ë¬¸ì œ</strong>ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</p>

<p>ì‹¤ì œ Pick-Gitì—ì„œ ì‚¬ìš©í•˜ëŠ” Post ì—”í‹°í‹°ì˜ ê²½ìš°, ì‘ë‹µì„ ì‘ì„±í•  ë•Œ Comment ë¿ë§Œ ì•„ë‹ˆë¼ Image, Tag, Like, User ë“± ì—¬ëŸ¬ ì§€ì—° ë¡œë”©ëœ ì—”í‹°í‹° í…Œì´ë¸”ë“¤ì„ ì¶”ê°€ì ìœ¼ë¡œ ì°¸ì¡°í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ì¡°íšŒí•œ Postê°€ 1000ê±´ì´ë©´ 5000ê±´ì˜ ì¶”ê°€ ì¿¼ë¦¬ê°€ ë°œìƒí•˜ê²Œ ë©ë‹ˆë‹¤.</p>

<p>ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ëŒ€ê²Œ Fetch Joinì„ ì ìš©í•˜ê²Œ ë©ë‹ˆë‹¤.</p>

<h3 id="31-fetch-join">3.1. Fetch Join</h3>

<p>Fetch Joinì´ë€ JPQLë¡œ íŠ¹ì • ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•  ë•Œ ì—°ê´€ëœ ì—”í‹°í‹° í˜¹ì€ ì»¬ë ‰ì…˜ì„ ì¦‰ì‹œ ë¡œë”©ê³¼ ê°™ì´ í•œ ë²ˆì— í•¨ê»˜ ì¡°íšŒí•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.</p>

<blockquote>
  <p>PostRepository.java</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Query</span><span class="o">(</span><span class="s">"select distinct p from Post p join fetch p.comments"</span><span class="o">)</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Post</span><span class="o">&gt;</span> <span class="nf">findWithPagination</span><span class="o">(</span><span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">);</span>
</code></pre></div></div>

<blockquote>
  <p>SQL</p>
</blockquote>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">2021</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">26</span> <span class="mi">22</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">32</span><span class="p">.</span><span class="mi">764</span>  <span class="n">WARN</span> <span class="mi">14832</span> <span class="c1">--- [    Test worker] o.h.h.internal.ast.QueryTranslatorImpl   : HHH000104: firstResult/maxResults specified with collection fetch; applying in memory!</span>
<span class="n">Hibernate</span><span class="p">:</span>
    <span class="k">select</span>
        <span class="k">distinct</span> <span class="n">post0_</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">id1_4_0_</span><span class="p">,</span>
        <span class="n">comments1_</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">id1_2_1_</span><span class="p">,</span>
        <span class="n">post0_</span><span class="p">.</span><span class="n">content</span> <span class="k">as</span> <span class="n">content2_4_0_</span><span class="p">,</span>
        <span class="n">comments1_</span><span class="p">.</span><span class="n">content</span> <span class="k">as</span> <span class="n">content2_2_1_</span><span class="p">,</span>
        <span class="n">comments1_</span><span class="p">.</span><span class="n">like_id</span> <span class="k">as</span> <span class="n">like_id3_2_1_</span><span class="p">,</span>
        <span class="n">comments1_</span><span class="p">.</span><span class="n">post_id</span> <span class="k">as</span> <span class="n">post_id4_2_1_</span><span class="p">,</span>
        <span class="n">comments1_</span><span class="p">.</span><span class="n">post_id</span> <span class="k">as</span> <span class="n">post_id4_2_0__</span><span class="p">,</span>
        <span class="n">comments1_</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">id1_2_0__</span>
    <span class="k">from</span>
        <span class="n">post</span> <span class="n">post0_</span>
    <span class="k">inner</span> <span class="k">join</span>
        <span class="k">comment</span> <span class="n">comments1_</span>
            <span class="k">on</span> <span class="n">post0_</span><span class="p">.</span><span class="n">id</span><span class="o">=</span><span class="n">comments1_</span><span class="p">.</span><span class="n">post_id</span>
<span class="p">[</span><span class="n">com</span><span class="p">.</span><span class="n">learning</span><span class="p">.</span><span class="n">jpa</span><span class="p">.</span><span class="k">domain</span><span class="p">.</span><span class="k">Comment</span><span class="o">@</span><span class="mi">72</span><span class="n">dc246c</span><span class="p">]</span>
<span class="p">[</span><span class="n">com</span><span class="p">.</span><span class="n">learning</span><span class="p">.</span><span class="n">jpa</span><span class="p">.</span><span class="k">domain</span><span class="p">.</span><span class="k">Comment</span><span class="o">@</span><span class="mi">6</span><span class="n">e76be45</span><span class="p">]</span>
<span class="p">[</span><span class="n">com</span><span class="p">.</span><span class="n">learning</span><span class="p">.</span><span class="n">jpa</span><span class="p">.</span><span class="k">domain</span><span class="p">.</span><span class="k">Comment</span><span class="o">@</span><span class="mi">37</span><span class="n">ef8e6b</span><span class="p">]</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Post ì „ì²´ ì¡°íšŒ ì¿¼ë¦¬ 1ê°œ (1) + ê° Postë³„ Comment ì¡°íšŒ ì¿¼ë¦¬ 3ê°œ (N)</code> ì´ ì¿¼ë¦¬ê°€ 4ê°œê°€ ë‚ ì•„ê°€ë˜ ê²ƒì´ Fetch Joinì„ ì ìš©í•¨ìœ¼ë¡œì¨ 1ê°œë¡œ ì¤„ì–´ë“¤ì—ˆìŠµë‹ˆë‹¤. ì„±ëŠ¥ì´ ìµœì í™”ëœ ê²ƒìœ¼ë¡œ ë³´ì´ì§€ë§Œ ë‹¤ì†Œ ì´ìƒí•œ ë¶€ë¶„ì´ ì¡´ì¬í•©ë‹ˆë‹¤.</p>

<p>ë¨¼ì €, í˜ì´ì§•í•  ë•Œ ì‚¬ìš©í•˜ë˜ ê¸°ì¡´ì˜ SQL LIMIT êµ¬ë¬¸ì´ ë“±ì¥í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë˜í•œ ì¿¼ë¦¬ ê²°ê³¼ë¥¼ ì „ë¶€ ë©”ëª¨ë¦¬ì— ì ì¬í•œ ë’¤ ì–´í”Œë¦¬ì¼€ì´ì…˜ ë‹¨ì—ì„œ Pagination ì‘ì—…ì„ ìˆ˜í–‰í•œë‹¤ëŠ” ê²½ê³  ë¡œê·¸ê°€ ë°œìƒí•©ë‹ˆë‹¤. ì™œ ì´ëŸ¬í•œ í˜„ìƒì´ ë°œìƒí•˜ëŠ” ê²ƒì¼ê¹Œìš”?</p>

<p>Post ì—”í‹°í‹°ê°€ 3ê°œ ìˆê³ , ê°ê°ì˜ Post ì—”í‹°í‹°ëŠ” ì—°ê´€ëœ Commentê°€ 7ê°œ ì¡´ì¬í•œë‹¤ê³  ê°€ì •í•´ë´…ì‹œë‹¤. 1:N ê´€ê³„ë¥¼ Joiní•˜ë©´ ì´ 21(3 * 7)ê°œì˜ DB Rowê°€ ì¡°íšŒë©ë‹ˆë‹¤. ë°ì´í„°ì˜ ìˆ˜ê°€ ë³€ê²½ë˜ê¸° ë•Œë¬¸ì— ë‹¨ìˆœí•˜ê²Œ LIMIT êµ¬ë¬¸ì„ ì‚¬ìš©í•˜ëŠ” ì¿¼ë¦¬ë¡œ í˜ì´ì§€ë„¤ì´ì…˜ì„ ì ìš©í•˜ê¸° ì–´ë µìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ì¡°íšŒí•œ ê²°ê³¼ë¥¼ ëª¨ë‘ ë©”ëª¨ë¦¬ë¡œ ê°€ì ¸ì™€ì„œ JPAê°€ í˜ì´ì§€ë„¤ì´ì…˜ ê³„ì‚°ì„ ì§„í–‰í•©ë‹ˆë‹¤.</p>

<p><strong>1:N ê´€ê³„ì˜ ì»¬ë ‰ì…˜ì„ Fetch Joiní•˜ë©´ì„œ ë™ì‹œì— Pagination APIë¥¼ ì‚¬ìš©í•˜ë©´ OutOfMemoryErrorê°€ ë°œìƒí•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì—, ì´ ë‘˜ì„ ë™ì‹œì— ì‚¬ìš©í•´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤.</strong></p>

<blockquote>
  <p>CommentTest.java</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Comment</span><span class="o">&gt;</span> <span class="n">comments</span> <span class="o">=</span> <span class="n">entityManager</span>
    <span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"select c from Comment c join fetch c.post"</span><span class="o">,</span> <span class="nc">Comment</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="o">.</span><span class="na">setFirstResult</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
    <span class="o">.</span><span class="na">setMaxResults</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span>
    <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
</code></pre></div></div>

<blockquote>
  <p>SQL</p>
</blockquote>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Hibernate</span><span class="p">:</span>
    <span class="k">select</span>
        <span class="n">comment0_</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">id1_2_0_</span><span class="p">,</span>
        <span class="n">post1_</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">id1_4_1_</span><span class="p">,</span>
        <span class="n">comment0_</span><span class="p">.</span><span class="n">content</span> <span class="k">as</span> <span class="n">content2_2_0_</span><span class="p">,</span>
        <span class="n">comment0_</span><span class="p">.</span><span class="n">post_id</span> <span class="k">as</span> <span class="n">post_id4_2_0_</span><span class="p">,</span>
        <span class="n">post1_</span><span class="p">.</span><span class="n">content</span> <span class="k">as</span> <span class="n">content2_4_1_</span>
    <span class="k">from</span>
        <span class="k">comment</span> <span class="n">comment0_</span>
    <span class="k">inner</span> <span class="k">join</span>
        <span class="n">post</span> <span class="n">post1_</span>
            <span class="k">on</span> <span class="n">comment0_</span><span class="p">.</span><span class="n">post_id</span><span class="o">=</span><span class="n">post1_</span><span class="p">.</span><span class="n">id</span> <span class="k">limit</span> <span class="o">?</span>
</code></pre></div></div>

<p>ë°˜ëŒ€ë¡œ N:1 ê´€ê³„ì˜ ì—”í‹°í‹°ë¥¼ Fetch Joiní•  ë•ŒëŠ” ë¬¸ì œì—†ì´ Pagination APIë¥¼ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. Commentì™€ PostëŠ” N:1 ê´€ê³„ì´ê¸° ë•Œë¬¸ì— Joiní•´ë„ ì¡°íšŒë˜ëŠ” DB ROWì˜ ìˆ˜ê°€ ë³€ê²½ë˜ì§€ ì•Šê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. SQL ë¡œê·¸ì—ë„ LIMIT êµ¬ë¬¸ì´ ì˜ ì°í˜€ìˆê³ , ë³„ë„ì˜ ê²½ê³  ë¡œê·¸ê°€ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>

<p><br /></p>

<h2 id="4-í•´ê²°-ë°©ì•ˆ">4. í•´ê²° ë°©ì•ˆ</h2>

<p>Pagination APIë¥¼ ì‚¬ìš©í•  ë•Œ <code class="language-plaintext highlighter-rouge">~ToOne</code> ê´€ê³„ì˜ ì—”í‹°í‹°ëŠ” Fetch Joiní•´ë„ ê´œì°®ì§€ë§Œ, <code class="language-plaintext highlighter-rouge">~ToMany</code> ê´€ê³„ì˜ ì—”í‹°í‹°ì— ëŒ€í•´ì„œëŠ” ë‹¤ë¥¸ ì ‘ê·¼ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>

<blockquote>
  <p>application.properties</p>
</blockquote>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">spring.jpa.properties.hibernate.default_batch_fetch_size</span><span class="p">=</span><span class="s">1000</span>
</code></pre></div></div>

<p>ê·¸ ì¤‘ ê°€ì¥ ì‰¬ìš´ í•´ê²° ë°©ì•ˆìœ¼ë¡œëŠ” Batch Sizeë¥¼ ì§€ì •í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. @BatchSize ì• ë„ˆí…Œì´ì…˜ì„ ë¶€ì°©í•  ìˆ˜ë„ ìˆì§€ë§Œ, ì–´í”Œë¦¬ì¼€ì´ì…˜ ì „ì—­ ì„¤ì •ì„ ìœ„í•´ propertiesì— ê°’ì„ ì •ì˜í–ˆìŠµë‹ˆë‹¤. í•´ë‹¹ ì˜µì…˜ì— ëŒ€í•œ ì„¤ëª…ì€ í›„ìˆ í•˜ê² ìŠµë‹ˆë‹¤.</p>

<blockquote>
  <p>PostRepositoryTest.java</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Post</span><span class="o">&gt;</span> <span class="n">posts</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"select p from Post p"</span><span class="o">,</span> <span class="nc">Post</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="o">.</span><span class="na">setFirstResult</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
    <span class="o">.</span><span class="na">setMaxResults</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span>
    <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
</code></pre></div></div>

<blockquote>
  <p>SQL</p>
</blockquote>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Hibernate</span><span class="p">:</span>
    <span class="k">select</span>
        <span class="n">post0_</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">id1_4_</span><span class="p">,</span>
        <span class="n">post0_</span><span class="p">.</span><span class="n">content</span> <span class="k">as</span> <span class="n">content2_4_</span>
    <span class="k">from</span>
        <span class="n">post</span> <span class="n">post0_</span> <span class="k">limit</span> <span class="o">?</span>
<span class="n">Hibernate</span><span class="p">:</span>
    <span class="k">select</span>
        <span class="n">comments0_</span><span class="p">.</span><span class="n">post_id</span> <span class="k">as</span> <span class="n">post_id4_2_1_</span><span class="p">,</span>
        <span class="n">comments0_</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">id1_2_1_</span><span class="p">,</span>
        <span class="n">comments0_</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">id1_2_0_</span><span class="p">,</span>
        <span class="n">comments0_</span><span class="p">.</span><span class="n">content</span> <span class="k">as</span> <span class="n">content2_2_0_</span><span class="p">,</span>
        <span class="n">comments0_</span><span class="p">.</span><span class="n">like_id</span> <span class="k">as</span> <span class="n">like_id3_2_0_</span><span class="p">,</span>
        <span class="n">comments0_</span><span class="p">.</span><span class="n">post_id</span> <span class="k">as</span> <span class="n">post_id4_2_0_</span>
    <span class="k">from</span>
        <span class="k">comment</span> <span class="n">comments0_</span>
    <span class="k">where</span>
        <span class="n">comments0_</span><span class="p">.</span><span class="n">post_id</span> <span class="k">in</span> <span class="p">(</span>
            <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span>
        <span class="p">)</span>
<span class="p">[</span><span class="n">com</span><span class="p">.</span><span class="n">learning</span><span class="p">.</span><span class="n">jpa</span><span class="p">.</span><span class="k">domain</span><span class="p">.</span><span class="k">Comment</span><span class="o">@</span><span class="mi">6090</span><span class="n">a8fc</span><span class="p">]</span>
<span class="p">[</span><span class="n">com</span><span class="p">.</span><span class="n">learning</span><span class="p">.</span><span class="n">jpa</span><span class="p">.</span><span class="k">domain</span><span class="p">.</span><span class="k">Comment</span><span class="o">@</span><span class="mi">77</span><span class="n">d45b37</span><span class="p">]</span>
<span class="p">[</span><span class="n">com</span><span class="p">.</span><span class="n">learning</span><span class="p">.</span><span class="n">jpa</span><span class="p">.</span><span class="k">domain</span><span class="p">.</span><span class="k">Comment</span><span class="o">@</span><span class="mi">23447</span><span class="n">af</span><span class="p">]</span>
</code></pre></div></div>

<p>Fetch Join ì—†ì´ Pagination APIë¥¼ ì‚¬ìš©í•´ë³´ì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§•(LIMIT)ì„ í†µí•´ POST ë¦¬ìŠ¤íŠ¸ë¥¼ ì¡°íšŒí•˜ì§€ë§Œ, Comment ê´€ë ¨ ì¡°íšŒ ì¿¼ë¦¬ê°€ ê¸°ì¡´ê³¼ ë‹¤ë¥´ê²Œ ë‚˜ê°‘ë‹ˆë‹¤. ê¸°ì¡´ì—ëŠ” ë°˜ë³µë¬¸ì„ ìˆœíšŒí•˜ë©´ì„œ Nê°œì˜ Post ì—”í‹°í‹°ì— ëŒ€í•´ <code class="language-plaintext highlighter-rouge">where comments0_.post_id=?</code>ë¥¼ í¬í•¨í•˜ëŠ” Comment ì¡°íšŒ ì¿¼ë¦¬ê°€ Në²ˆ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ Batch Sizeë¥¼ ì ìš©í•œ ê²°ê³¼ <code class="language-plaintext highlighter-rouge">where comments0_.post_id in (?, ?, ?)</code>ë¥¼ í¬í•¨í•˜ëŠ” Comment ì¡°íšŒ ì¿¼ë¦¬ 1ê°œë¡œ ì¤„ì–´ë“¤ì—ˆìŠµë‹ˆë‹¤.</p>

<p>@BatchSize í˜¹ì€ <code class="language-plaintext highlighter-rouge">spring.jpa.properties.hibernate.default_batch_fetch_size</code> ì˜µì…˜ì„ ì ìš©í•˜ë©´</p>

<ol>
  <li>X íƒ€ì… ì—”í‹°í‹°ê°€ ì§€ì—° ë¡œë”©ëœ <code class="language-plaintext highlighter-rouge">~ToMany</code> ê´€ê³„ì˜ Y íƒ€ì… ì»¬ë ‰ì…˜ì„ ìµœì´ˆ ì¡°íšŒí•  ë•Œ</li>
  <li>ì´ë¯¸ ì¡°íšŒí•œ X íƒ€ì… ì—”í‹°í‹°(ì¦‰, ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ê´€ë¦¬ë˜ê³  ìˆëŠ” ì—”í‹°í‹°)ë“¤ì˜ IDë“¤ì„ ëª¨ì•„ì„œ</li>
  <li><code class="language-plaintext highlighter-rouge">WHERE Y.X_ID IN (?, ?, ?...)</code> ì™€ ê°™ì€ SQL IN êµ¬ë¬¸ì— ë‹´ì•„ Y íƒ€ì… ë°ì´í„° ì¡°íšŒ ì¿¼ë¦¬ë¥¼ ë‚ ë¦½ë‹ˆë‹¤.</li>
  <li>X íƒ€ì… ì—”í‹°í‹°ë“¤ì´ í•„ìš”ë¡œ í•˜ëŠ” ëª¨ë“  Y íƒ€ì… ë°ì´í„°ë¥¼ í•œ ë²ˆì— ì¡°íšŒí•©ë‹ˆë‹¤.</li>
</ol>

<p>ì—¬ê¸°ì„œ Batch Size ì˜µì…˜ì— í• ë‹¹ë˜ëŠ” ìˆ«ìëŠ” <strong>IN êµ¬ë¬¸ì— ë„£ì„ ë¶€ëª¨ ì—”í‹°í‹° Key(ID)ì˜ ìµœëŒ€ ê°œìˆ˜</strong>ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.</p>

<p>ì˜ˆë¥¼ ë“¤ì–´ ë´…ì‹œë‹¤. ë³„ë‹¤ë¥¸ ì¡°ì¹˜ë¥¼ ì·¨í•˜ì§€ ì•Šì€ ìƒí™©ì—ì„œ, Post 1000ê°œê°€ ë‹´ê¸´ ë¦¬ìŠ¤íŠ¸ë¥¼ ìˆœíšŒí•˜ë©´ì„œ Commentë¥¼ í˜¸ì¶œí•˜ëŠ” ì½”ë“œëŠ” ì§€ì—° ë¡œë”©ìœ¼ë¡œ ì¸í•´ 1000ê°œì˜ ì¶”ê°€ ì¿¼ë¦¬ê°€ ë°œìƒí•©ë‹ˆë‹¤.</p>

<p>ë°˜ë©´ Batch Size ì˜µì…˜ì„ 1000ìœ¼ë¡œ ì§€ì •í•´ë‘ë©´, ë°˜ë³µë¬¸ì„ ìˆœíšŒí•˜ë©° Commentsë¥¼ ìµœì´ˆë¡œ ì¡°íšŒí•˜ëŠ” ì‹œì ì—</p>

<ol>
  <li>ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ê´€ë¦¬ë˜ê³  ìˆëŠ” 1000ê°œì˜ Post ì—”í‹°í‹° IDê°€</li>
  <li>Comments ì¡°íšŒ ì¿¼ë¦¬ì˜ IN êµ¬ë¬¸ <code class="language-plaintext highlighter-rouge">where comment.post_id in (?, ?, ?, ...)</code>ì— í¬í•¨ë˜ì–´ ë‚ ì•„ê°‘ë‹ˆë‹¤.</li>
  <li>ë‹¨ í•˜ë‚˜ì˜ Comment ì¡°íšŒ ì¿¼ë¦¬ë¡œ 1000ê°œì˜ Post ì—”í‹°í‹°ê°€ í•„ìš”ë¡œ í•˜ëŠ” ëª¨ë“  Comment ê´€ë ¨ ë°ì´í„°ë¥¼ ì¡°íšŒí•´ì˜µë‹ˆë‹¤.</li>
</ol>

<p>ë³´í†µ ì˜µì…˜ê°’ì„ 1,000 ì´ìƒ ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>

<h3 id="41-ê²°ë¡ ">4.1. ê²°ë¡ </h3>

<blockquote>
  <p>PostRepository.java</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Query</span><span class="o">(</span><span class="s">"select p from Post p left join fetch p.user order by p.createdAt desc"</span><span class="o">)</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Post</span><span class="o">&gt;</span> <span class="nf">findAllPosts</span><span class="o">(</span><span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">);</span>
</code></pre></div></div>

<p>ë”°ë¼ì„œ Pick-Gitì€ Postë¥¼ Pagination APIë¥¼ í†µí•´ ì¡°íšŒí•  ë•Œ ë‹¤ìŒê³¼ ê°™ì€ ë°©ë²•ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>

<ul>
  <li>@ManyToOne ë“± N:1 ê´€ê³„ì˜ ìì‹ ì—”í‹°í‹°ì— ëŒ€í•´ì„œëŠ” ëª¨ë‘ Fetch Joinì„ ì ìš©í•¨ìœ¼ë¡œì¨ í•œë°© ì¿¼ë¦¬ë¥¼ ìˆ˜í–‰í•œë‹¤.</li>
  <li>@OneToMany ë“± 1:N ê´€ê³„ì˜ ìì‹ ì—”í‹°í‹°ëŠ” Fetch Joinì„ í•˜ì§€ ì•ŠëŠ”ë‹¤.
    <ul>
      <li>ëŒ€ì‹  ìƒê¸° ì„ ì–¸í•œ <code class="language-plaintext highlighter-rouge">hibernate.default_batch_fetch_size</code> ì ìš©ì„ í†µí•œ in ì¿¼ë¦¬ë¡œ ì„±ëŠ¥ì„ ë³´ì¥í•œë‹¤.</li>
    </ul>
  </li>
</ul>

<p><br /></p>

<h2 id="5-ë§ˆì¹˜ë©°">5. ë§ˆì¹˜ë©°</h2>

<p>Batch Size ì˜µì…˜ì€ ìƒìˆ í•œ <code class="language-plaintext highlighter-rouge">Pagination + Fetch Join ë¬¸ì œ</code>ë¿ë§Œ ì•„ë‹ˆë¼, ë‹¤ë¥¸ JPAì˜ í•œê³„ë¥¼ ê·¹ë³µí•˜ëŠ”ë° ë„ì›€ì´ ë©ë‹ˆë‹¤.</p>

<p>ê°€ë ¹, JPAëŠ” ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•  ë•Œ 2ê°œ ì´ìƒì˜ 1:N ê´€ê³„ì˜ ì»¬ë ‰ì…˜ì„ Fetch Joiní•˜ì§€ ëª»í•˜ë„ë¡ ë˜ì–´ìˆìŠµë‹ˆë‹¤. ì¡°íšŒë˜ëŠ” ë°ì´í„°ê°€ ë„ˆë¬´ ë§ì•„ì§€ëŠ” ì¹´í…Œì‹œì•ˆ ê³±(Cartesian Product) ë•Œë¬¸ì—, 2ê°œ ì´ìƒì˜ ì»¬ë ‰ì…˜ì„ Fetch Joiní•˜ë©´ MultipleBagFetchExceptionì´ ë°œìƒí•©ë‹ˆë‹¤. ì˜¤ì§ 1ê°œì˜ ì»¬ë ‰ì…˜ë§Œ Fetch Joinì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>

<p>íŠ¹ì • ì—”í‹°í‹°ê°€ ë³´ìœ í•˜ëŠ” 1:N ê´€ê³„ì˜ ì»¬ë ‰ì…˜ ëª¨ë‘ë¥¼ ì¦‰ì‹œ ë¡œë”©ì²˜ëŸ¼ ì¡°íšŒí•  ìˆ˜ ì—†ë‹¤ëŠ” ê²ƒì€, ì´ë²ˆ ê¸€ì˜ Post ì—”í‹°í‹° ì˜ˆì œì²˜ëŸ¼ N + 1 ë¬¸ì œê°€ ë°œìƒí•œë‹¤ëŠ” ê²ƒì„ ì‹œì‚¬í•©ë‹ˆë‹¤. í•˜ì§€ë§Œ Batch Size ì˜µì…˜ì„ í†µí•´ ì´ëŸ¬í•œ JPA Fetch Join í•œê³„ë¡œ ì¸í•´ ë°œìƒí•˜ëŠ” N + 1 ë¬¸ì œë¥¼ ì–´ëŠ ì •ë„ í•´ì†Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p><br /></p>

<hr />

<h2 id="reference">Reference</h2>

<ul>
  <li><a href="https://velog.io/@rainmaker007/jpa-fetch-join">jpa fetch join</a></li>
  <li><a href="https://jojoldu.tistory.com/457">MultipleBagFetchException ë°œìƒì‹œ í•´ê²° ë°©ë²•</a></li>
  <li><a href="https://www.inflearn.com/questions/14663">fetch join ì‹œ paging ë¬¸ì œ</a></li>
  <li><a href="https://javabom.tistory.com/104">fetch join ê³¼ pagination ì„ ê°™ì´ ì“¸ ë•Œ [HHH000104: firstResult/maxResults specified with collection fetch; applying in memory]</a></li>
  <li><a href="https://zetawiki.com/wiki/N%2B1_%EC%BF%BC%EB%A6%AC_%EB%AC%B8%EC%A0%9C">N+1 ì¿¼ë¦¬ ë¬¸ì œ</a></li>
  <li><a href="https://www.infragistics.com/help/aspnet/webdatagrid-paging">ì´ë¯¸ì§€ ì¶œì²˜</a></li>
  <li><a href="https://medium.com/the-marcy-lab-school/what-is-the-n-1-problem-in-graphql-dd4921cb3c1a">í‹°ì € ì¶œì²˜</a></li>
</ul>

      <div class="page-footer">
        <div class="page-share">
          <a href="https://twitter.com/intent/tweet?text=JPA Pagination, ê·¸ë¦¬ê³  N + 1 ë¬¸ì œ&url=https://2021-pick-git.github.io//pagination-n-plus-one/" title="Share on Twitter" rel="nofollow" target="_blank">Twitter</a>
          <a href="https://facebook.com/sharer.php?u=https://2021-pick-git.github.io//pagination-n-plus-one/" title="Share on Facebook" rel="nofollow" target="_blank">Facebook</a>
          <a href="https://plus.google.com/share?url=https://2021-pick-git.github.io//pagination-n-plus-one/" title="Share on Google+" rel="nofollow" target="_blank">Google+</a>
        </div>
        <div class="page-tag">
          
            <a href="/tags#ë°±ì—”ë“œ" class="tag">&#35; ë°±ì—”ë“œ</a>
          
            <a href="/tags#JPA" class="tag">&#35; JPA</a>
          
        </div>
      </div>
      <section class="comment-area">
  <div class="comment-wrapper">
    
  </div>
</section> <!-- End Comment Area -->

    </div> <!-- End Wrap Content -->
  </div> <!-- End Page Content -->
</article> <!-- End Article Page -->

</div>

  </div>
  
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', '', 'auto');
  ga('send', 'pageview');
</script> <!-- End Analytics -->

</body>
</html>
