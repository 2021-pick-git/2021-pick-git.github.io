<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>ë‹¤ì´ë‚´ë¯¹ í”„ë¡ì‹œë¥¼ ì´ìš©í•œ ì¿¼ë¦¬ ì¹´ìš´íŒ… ì ìš©ê¸° (feat. ìºì‹± í…ŒìŠ¤íŠ¸) - BingheCompany ğŸ‡°ğŸ‡·</title>

  <!-- Edit site and author settings in `_config.yml` to make the social details your own -->

    <meta content="BingheCompany ğŸ‡°ğŸ‡·" property="og:site_name">
  
    <meta content="ë‹¤ì´ë‚´ë¯¹ í”„ë¡ì‹œë¥¼ ì´ìš©í•œ ì¿¼ë¦¬ ì¹´ìš´íŒ… ì ìš©ê¸° (feat. ìºì‹± í…ŒìŠ¤íŠ¸)" property="og:title">
  
  
    <meta content="article" property="og:type">
  
  
    <meta content="ë‹¤ì´ë‚´ë¯¹ í”„ë¡ì‹œë¥¼ ì´ìš©í•œ ì¿¼ë¦¬ ì¹´ìš´íŒ… ì ìš©ê¸°" property="og:description">
  
  
    <meta content="https://2021-pick-git.github.io//query-counter/" property="og:url">
  
  
    <meta content="2021-10-08T13:00:00+09:00" property="article:published_time">
    <meta content="https://2021-pick-git.github.io//about/" property="article:author">
  
  
    <meta content="https://2021-pick-git.github.io//assets/img/how-to-start.jpg" property="og:image">
  
  
    
  
  
    
    <meta content="ë°±ì—”ë“œ" property="article:tag">
    
    <meta content="ë‹¤ì´ë‚´ë¯¹í”„ë¡ì‹œ" property="article:tag">
    
    <meta content="ì¿¼ë¦¬ì¹´ìš´íŒ…" property="article:tag">
    
    <meta content="ìºì‹±í…ŒìŠ¤íŠ¸" property="article:tag">
    
  

    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@">
    <meta name="twitter:creator" content="@">
  
    <meta name="twitter:title" content="ë‹¤ì´ë‚´ë¯¹ í”„ë¡ì‹œë¥¼ ì´ìš©í•œ ì¿¼ë¦¬ ì¹´ìš´íŒ… ì ìš©ê¸° (feat. ìºì‹± í…ŒìŠ¤íŠ¸)">
  
  
    <meta name="twitter:url" content="https://2021-pick-git.github.io//query-counter/">
  
  
    <meta name="twitter:description" content="ë‹¤ì´ë‚´ë¯¹ í”„ë¡ì‹œë¥¼ ì´ìš©í•œ ì¿¼ë¦¬ ì¹´ìš´íŒ… ì ìš©ê¸°">
  
  
    <meta name="twitter:image:src" content="https://2021-pick-git.github.io//assets/img/how-to-start.jpg">
  

	<meta name="description" content="ë‹¤ì´ë‚´ë¯¹ í”„ë¡ì‹œë¥¼ ì´ìš©í•œ ì¿¼ë¦¬ ì¹´ìš´íŒ… ì ìš©ê¸°">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta property="og:image" content="">
	<link rel="shortcut icon" href="/assets/img/favicon/favicon.ico" type="image/x-icon">
	<link rel="apple-touch-icon" href="/assets/img/favicon/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicon/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicon/apple-touch-icon-144x144.png">
	<!-- Chrome, Firefox OS and Opera -->
	<meta name="theme-color" content="#263959">
	<!-- Windows Phone -->
	<meta name="msapplication-navbutton-color" content="#263959">
	<!-- iOS Safari -->
	<meta name="apple-mobile-web-app-status-bar-style" content="#263959">
	<!-- Google Fonts -->
	<link href="https://fonts.googleapis.com/css?family=PT+Serif:400,700|Lato:300,400,700&display=swap" rel="stylesheet">
	<!-- Font Awesome -->
	<link rel="stylesheet" href="/assets/fonts/font-awesome/css/font-awesome.min.css">
	<!-- Styles -->
	<link rel="stylesheet" href="/assets/css/main.css">
</head>

<body>

  <div class="wrapper">
    <aside class="sidebar">
  <header>
    <div class="about">
      <div class="cover-author-image">
        <a href="/"><img src="/assets/img/mark.jpg" alt="ê¹ƒ-ë“¤ë‹¤ (pick-git)"></a>
      </div>
      <div class="author-name">ê¹ƒ-ë“¤ë‹¤ (pick-git)</div>
      <p>ê¹ƒ-ë“¤ë‹¤ ê¸°ìˆ  ë¸”ë¡œê·¸ì…ë‹ˆë‹¤.</br>ğŸ˜‡ğŸ’ª</br> This is a tech blog for pick-git.</br> ãƒ”ã‚¯ã‚®ãƒˆã®æŠ€è¡“ã®blogã§ã™ã€‚</br> è¿™æ˜¯ pick-git ç§‘æŠ€åšå®¢.</br></p>
    </div>
  </header> <!-- End Header -->
  <footer>
    <section class="contact">
      <h3 class="contact-title">Contact me</h3>
      <ul>
        <!-- 
          <li><a href="https://twitter.com/artemsheludko_" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
        
        
          <li><a href="https://facebook.com/" target="_blank"><i class="fa fa-facebook" aria-hidden="true"></i></a></li>
         -->
        
          <li class="github"><a href="http://github.com/woowacourse-teams/2021-pick-git" target="_blank"><i class="fa fa-github"></i></a></li>
        
        <!-- 
          <li class="linkedin"><a href="https://in.linkedin.com/" target="_blank"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li>
        
        
          <li class="email"><a href="mailto:example.david@blog.com"><i class="fa fa-envelope-o" aria-hidden="true"></i></a></li>
         -->
      </ul>
    </section> <!-- End Section Contact -->
    <div class="copyright">
      <p>2021 &copy; ê¹ƒ-ë“¤ë‹¤ (pick-git)</p>
    </div>
  </footer> <!-- End Footer -->
</aside> <!-- End Sidebar -->
<div class="content-box clearfix">
  <article class="article-page">
  <div class="page-content">
    
    <div class="page-cover-image">
      <figure>
        <img class="page-image" src=/assets/img/how-to-start.jpg alt="ë‹¤ì´ë‚´ë¯¹ í”„ë¡ì‹œë¥¼ ì´ìš©í•œ ì¿¼ë¦¬ ì¹´ìš´íŒ… ì ìš©ê¸° (feat. ìºì‹± í…ŒìŠ¤íŠ¸)">
        
      </figure>
    </div> <!-- End Page Cover Image -->
    
    <div class="wrap-content">
      <header class="header-page">
        <h1 class="page-title">ë‹¤ì´ë‚´ë¯¹ í”„ë¡ì‹œë¥¼ ì´ìš©í•œ ì¿¼ë¦¬ ì¹´ìš´íŒ… ì ìš©ê¸° (feat. ìºì‹± í…ŒìŠ¤íŠ¸)</h1>
        <div class="page-date"><span>2021, Oct 08&nbsp;&nbsp;&nbsp;&nbsp;</span></div>
      </header>
      <h1 id="ëª©ì°¨">ëª©ì°¨</h1>

<p><br /></p>

<ul>
  <li><a href="#ëª©ì°¨">ëª©ì°¨</a></li>
  <li><a href="#ë“¤ì–´ê°€ë©°">ë“¤ì–´ê°€ë©°</a></li>
  <li><a href="#ì‚¬ì „-ì§€ì‹">ì‚¬ì „ ì§€ì‹</a>
    <ul>
      <li><a href="#jdbcì™€-datasource-ë™ì‘-ê³¼ì •">JDBCì™€ DataSource ë™ì‘ ê³¼ì •</a></li>
      <li><a href="#ë‹¤ì´ë‚´ë¯¹-í”„ë¡ì‹œ">ë‹¤ì´ë‚´ë¯¹ í”„ë¡ì‹œ</a></li>
    </ul>
  </li>
  <li><a href="#ì¿¼ë¦¬-ì¹´ìš´íŒ…-êµ¬í˜„">ì¿¼ë¦¬ ì¹´ìš´íŒ… êµ¬í˜„</a></li>
  <li><a href="#ì‚¬ìš©-ì˜ˆì‹œ">ì‚¬ìš© ì˜ˆì‹œ</a>
    <ul>
      <li><a href="#ìºì‹±-í…ŒìŠ¤íŠ¸">ìºì‹± í…ŒìŠ¤íŠ¸</a></li>
      <li><a href="#n--1-ë¬¸ì œ-ë¶„ì„">N + 1 ë¬¸ì œ ë¶„ì„</a></li>
    </ul>
  </li>
  <li><a href="#ë§ˆì¹˜ë©°">ë§ˆì¹˜ë©°</a></li>
</ul>

<p><br /></p>

<p>ì•ˆë…•í•˜ì„¸ìš”! ë§ˆí¬ì…ë‹ˆë‹¤ :)</p>

<h1 id="ë“¤ì–´ê°€ë©°">ë“¤ì–´ê°€ë©°</h1>

<p>ì£¼ë³€ì—ì„œ íŠ¹ì • ë¹„ì¦ˆë‹ˆìŠ¤ë¥¼ ìˆ˜í–‰í•˜ë©´ì„œ ëª‡ ê°œì˜ ì¿¼ë¦¬ê°€ ë‚ ë¼ê°€ëŠ”ì§€ ì§ì ‘ í™•ì¸í•˜ëŠ” ì¥ë©´ì„ ë§ì´ ë´¤ë‹¤.</p>

<p>ì ì–´ë„ í•„ìëŠ” ê·¸ë¬ë‹¤.</p>

<p align="center"><img src="../assets/img/binghe/21-10-08-query-counter/problem_example.png" width="200" /> </p>

<p>ë¬¸ì œëŠ” í…ŒìŠ¤íŠ¸í•  ë•Œ ìœ„ì™€ê°™ì´ ì¿¼ë¦¬ê°€ êµ‰ì¥íˆ ë§ì´ ë‚ ë¼ê°€ë©°, ì–´ë–¤ ì½”ë“œê°€ ëª‡ ê°œì˜ ì¿¼ë¦¬ë¥¼ ë‚ ë ¸ëŠ”ì§€ íŒŒì•…í•˜ê¸° í˜ë“¤ë‹¤.</p>

<p>ë˜í•œ, N + 1 ë¬¸ì œì™€ ìºì‹± í…ŒìŠ¤íŠ¸ëŠ” ì¿¼ë¦¬ê°€ ì–¼ë§ˆë‚˜ ë‚ ë¼ê°”ëŠ”ì§€ê°€ êµ‰ì¥íˆ ì¤‘ìš”í•œ ì§€í‘œê°€ ëœë‹¤.</p>

<p>í•„ìëŠ” ìºì‹± í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ì¿¼ë¦¬ ì¹´ìš´í„°ë¥¼ êµ¬í˜„í•˜ê²Œ ë˜ì—ˆë‹¤.</p>

<p><strong>ì´ë²ˆ ê¸€ì€ ì´ë ‡ê²Œ íŠ¹ì • ì‹œì ë¶€í„° íŠ¹ì • ì‹œì ê¹Œì§€ ëª‡ ê°œì˜ ì¿¼ë¦¬ê°€ ë‚ ë¼ê°€ê³ , ì–´ë–¤ ì¿¼ë¦¬ê°€ ë‚ ë¼ê°”ëŠ”ì§€ ì‰½ê²Œ í™•ì¸í•  ìˆ˜ ìˆëŠ” ì»¤ìŠ¤í…€ ë°©ë²•ì„ ì†Œê°œí•˜ê³ ì í•œë‹¤.</strong></p>

<p><strong>í•µì‹¬ì„ ë§í•˜ìë©´, ë‹¤ì´ë‚´ë¯¹ í”„ë¡ì‹œë¥¼ ì´ìš©í•˜ì—¬ DataSourceì˜ <code class="language-plaintext highlighter-rouge">getConnection</code>ë¶€ë¶„ì„ í”„ë¡ì‹œë¡œ ê°ì‹¸ëŠ” ë°©ë²•ì´ë‹¤.</strong></p>

<p><br /></p>

<h1 id="ì‚¬ì „-ì§€ì‹">ì‚¬ì „ ì§€ì‹</h1>
<p>ë³¸ê²©ì ìœ¼ë¡œ ì‹œì‘í•˜ê¸°ì „ì— ìš°ì„  ì‚¬ì „ ì§€ì‹ ë‘ ê°€ì§€ê°€ ìˆë‹¤.</p>

<ol>
  <li>JDBC ë™ì‘ ê³¼ì •</li>
  <li>ë‹¤ì´ë‚´ë¯¹ í”„ë¡ì‹œ</li>
</ol>

<p><br /></p>

<h2 id="jdbcì™€-datasource-ë™ì‘-ê³¼ì •">JDBCì™€ DataSource ë™ì‘ ê³¼ì •</h2>

<p><br /></p>

<p>ğŸ¤” <strong>JDBCì™€ DataSource ë™ì‘ ê³¼ì •ì€ ì™œ ì•Œì•„ì•¼í•˜ëŠ”ê°€?</strong></p>

<p align="center"><img src="../assets/img/binghe/21-10-08-query-counter/hibernate_jdbc.png" width="600" /><br />ì¶œì²˜: https://terasolunaorg.github.io/guideline/5.1.0.RELEASE/en/ArchitectureInDetail/DataAccessJpa.html</p>

<ul>
  <li>JDBCTemplate, Hibernateë“± ì—¬ëŸ¬ ê°€ì§€ ë¼ì´ë¸ŒëŸ¬ë¦¬ í˜¹ì€ í”„ë ˆì„ì›Œí¬ <strong>ëª¨ë‘ JDBCë¥¼ ì‚¬ìš©í•˜ì—¬ DBì™€ í†µì‹ ì„ í•œë‹¤.</strong></li>
  <li>ê·¸ë¦¬ê³  <strong>DataSourceë¥¼ í†µí•´ DB ì»¤ë„¥ì…˜ì„ ìœ„í•œ ì •ë³´ì™€ ì»¤ë„¥ì…˜ì„ ì œê³µë°›ëŠ”ë‹¤.</strong></li>
</ul>

<p><strong>ê²°ë¡ ì ìœ¼ë¡œ JDBCì™€ DataSourceë¥¼ í†µí•´ ì»¤ìŠ¤í…€í•´ì•¼ ì¿¼ë¦¬ ì¹´ìš´íŒ…ì„ í•  ìˆ˜ ìˆë‹¤.</strong></p>

<p><br /></p>

<p>ğŸ¤” <strong>ë„ëŒ€ì²´ ì–´ë–»ê²Œ í•œë‹¤ëŠ” ê²ƒì¸ê°€?</strong></p>

<p>ì½”ë“œë¥¼ í†µí•´ ì–´ëŠ ë¶€ë¶„ì„ ì»¤ìŠ¤í…€í•˜ë©´ ì¿¼ë¦¬ ì¹´ìš´íŒ…ì´ ê°€ëŠ¥í•œì§€ ì‚´í´ë³´ì.</p>

<blockquote>
  <p>DataSourceConfig</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DataSourceConfig</span> <span class="o">{</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">UserDao</span> <span class="nf">userDao</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">UserDao</span><span class="o">(</span><span class="n">dataSource</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">DataSource</span> <span class="nf">dataSource</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">DriverManagerDataSource</span> <span class="n">dataSource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DriverManagerDataSource</span><span class="o">();</span>
        <span class="n">dataSource</span><span class="o">.</span><span class="na">setDriverClassName</span><span class="o">(</span><span class="s">"org.h2.Driver"</span><span class="o">);</span>
        <span class="n">dataSource</span><span class="o">.</span><span class="na">setUrl</span><span class="o">(</span><span class="s">"jdbc:h2:tcp://localhost/~/toby"</span><span class="o">);</span>
        <span class="n">dataSource</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="s">"sa"</span><span class="o">);</span>
        <span class="n">dataSource</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">dataSource</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <p>UserDao</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserDao</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">UserDao</span><span class="o">(</span><span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">dataSource</span> <span class="o">=</span> <span class="n">dataSource</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">save</span><span class="o">(</span><span class="nc">User</span> <span class="n">user</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="nc">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">PreparedStatement</span> <span class="n">ps</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// DataSourceë¡œë¶€í„° Connectionì„ ê°€ì ¸ì˜´.</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="n">dataSource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>

            <span class="c1">// Connectionìœ¼ë¡œë¶€í„° Statementë¥¼ ê°€ì ¸ì™€ SQL ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•œë‹¤.</span>
            <span class="n">ps</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="s">"insert into users(id, name, password) values(?, ?, ?)"</span><span class="o">);</span>
            <span class="n">ps</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
            <span class="n">ps</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
            <span class="n">ps</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getPassword</span><span class="o">());</span>

            <span class="n">ps</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">){</span>
            <span class="o">...</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="o">...</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <p>ì „í˜•ì ì¸ ë‚œê°í•œ UserDao ì˜ˆì‹œì´ë‹¤.</p>
</blockquote>

<p><br /></p>

<p>ğŸ¤” <strong>ìœ„ ì½”ë“œì—ì„œ ì¿¼ë¦¬ ì¹´ìš´íŒ…ì„ í•´ë³¼ ì»¤ìŠ¤í…€í•  ë¶€ë¶„ì„ ì°¾ì•˜ëŠ”ê°€?</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// DataSourceë¡œë¶€í„° Connectionì„ ê°€ì ¸ì˜´.</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">dataSource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>

<span class="c1">// Connectionìœ¼ë¡œë¶€í„° Statementë¥¼ ê°€ì ¸ì™€ SQL ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•œë‹¤.</span>
<span class="n">ps</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="s">"insert into users(id, name, password) values(?, ?, ?)"</span><span class="o">);</span>
</code></pre></div></div>

<p><strong>ë°”ë¡œ SQL ì¿¼ë¦¬ê°€ ë§¤ê°œë³€ìˆ˜ë¡œ ì£¼ì–´ì§€ëŠ” <code class="language-plaintext highlighter-rouge">conn.preparedStatement</code> ë©”ì„œë“œ ì´ë‹¤.</strong></p>

<p>ì¦‰, <strong><code class="language-plaintext highlighter-rouge">DataSource</code>ì—ì„œ ë°˜í™˜í•˜ëŠ” <code class="language-plaintext highlighter-rouge">Connection</code>ì„ í”„ë¡ì‹œë¡œ ê°ì‹¸ì„œ <code class="language-plaintext highlighter-rouge">preparedStatement</code>ê°€ í˜¸ì¶œë  ë•Œ í•´ë‹¹ ë§¤ê°œë³€ìˆ˜ë¥¼ ì¹´ìš´íŒ…í•˜ë©´ ëœë‹¤.</strong></p>

<blockquote>
  <p>ì•„ì§ ì–´ë ¤ìš´ê°€? ê±±ì •ë§ë¼. ë°‘ì—ì„œ ì»¤ìŠ¤í…€í•˜ë©´ì„œ ì´í•´ê°€ ë  ê²ƒì´ë‹¤.</p>
</blockquote>

<p><br /></p>

<h2 id="ë‹¤ì´ë‚´ë¯¹-í”„ë¡ì‹œ">ë‹¤ì´ë‚´ë¯¹ í”„ë¡ì‹œ</h2>
<p>ìœ„ì—ì„œ ì–¸ê¸‰í–ˆë“¯ì´ <code class="language-plaintext highlighter-rouge">Connection</code>ì„ í”„ë¡ì‹œë¡œ ê°ì‹¸ì•¼ ì¿¼ë¦¬ ì¹´ìš´íŒ…ì´ ê°€ëŠ¥í•˜ë‹¤.</p>

<p><br /></p>

<p>ğŸ¤” <strong>ë‹¤ì´ë‚´ë¯¹ í”„ë¡ì‹œ ë™ì‘ ì›ë¦¬</strong></p>

<p align="center"><img src="../assets/img/binghe/21-10-08-query-counter/dynamic_proxy_example.png" width="600" /> </p>

<ul>
  <li>ì¼ë°˜ì ì¸ í”„ë¡ì‹œì™€ ë‹¤ë¥´ê²Œ, ë‹¤ì´ë‚´ë¯¹ í”„ë¡ì‹œëŠ” ëª¨ë“  ìš”ì²­ì„ <code class="language-plaintext highlighter-rouge">InvocationHandler</code>ì— ìœ„ì„í•œë‹¤.
    <ul>
      <li>ì¦‰, <code class="language-plaintext highlighter-rouge">sayHello</code>, <code class="language-plaintext highlighter-rouge">sayHi</code>, <code class="language-plaintext highlighter-rouge">sayThankYou</code>ë“± ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ë©´ ë¦¬í”Œë ‰ì…˜ì„ í†µí•´ <code class="language-plaintext highlighter-rouge">Method</code>ì™€ <code class="language-plaintext highlighter-rouge">args</code>ë¡œ ë³€í™˜ë˜ì–´ <code class="language-plaintext highlighter-rouge">InvocationHandler</code>ì˜ <code class="language-plaintext highlighter-rouge">invoke()</code>ì— ë„˜ê²¨ì§„ë‹¤.</li>
      <li>ë¶€ê°€ë¡œì§ì€ ê¸°ì¡´ì˜ í”„ë¡ì‹œì²˜ëŸ¼ <code class="language-plaintext highlighter-rouge">InvocationHandler</code>ì— ì •ì˜í•´ë‘ë©´ ëœë‹¤.</li>
    </ul>
  </li>
  <li><strong>êµ¬ì²´ì ìœ¼ë¡œ ë³´ë©´ ë‹¤ì´ë‚´ë¯¹ í”„ë¡ì‹œ ê°ì²´ê°€ í´ë¼ì´ì–¸íŠ¸ì˜ ëª¨ë“  ìš”ì²­ì„ ë¦¬í”Œë ‰ì…˜ ì •ë³´ë¡œ ë³€í™˜í•´ì„œ <code class="language-plaintext highlighter-rouge">InvocationHandler</code> êµ¬í˜„ ê°ì²´ì˜ <code class="language-plaintext highlighter-rouge">invoke()</code>ë©”ì„œë“œë¡œ ë„˜ê¸´ë‹¤.</strong>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">public Object invoke(Object proxy, Method method, Object[] args)</code>
        <ul>
          <li>ë§Œë“¤ì–´ì§„ ë‹¤ì´ë‚´ë¯¹ í”„ë¡ì‹œëŠ” ë©”ì„œë“œ ìš”ì²­ì„ ë¦¬í”Œë ‰ì…˜ì„ ì´ìš©í•´ ë©”íƒ€ ë°ì´í„°ë¥¼ ë½‘ì•„ë‚´ê³ ,</li>
          <li><code class="language-plaintext highlighter-rouge">Method</code>ì™€ ë§¤ê°œë³€ìˆ˜ì™€ í•¨ê»˜ <code class="language-plaintext highlighter-rouge">InvocationHandler.invoke</code>ì—ê²Œ ë©”ì‹œì§€ ìš”ì²­í•œë‹¤.</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p><br /></p>

<blockquote>
  <p>ë” ìì„¸í•œ ë‚´ìš©ì€ <a href="https://github.com/binghe819/TIL/blob/master/OOP&amp;%EC%84%A4%EA%B3%84/%EB%94%94%EC%9E%90%EC%9D%B8%ED%8C%A8%ED%84%B4/Dynamic%20Proxy.md">ë‹¤ì´ë‚´ë¯¹ í”„ë¡ì‹œ ì •ë¦¬ ê¸€</a>ì„ ì°¸ê³ .</p>
</blockquote>

<p><br /></p>

<p>ğŸ¤” <strong>ì¼ë°˜ì ì¸ í”„ë¡ì‹œë„ ìˆëŠ”ë° ì™œ ë‹¤ì´ë‚´ë¯¹ í”„ë¡ì‹œë¥¼ ì‚¬ìš©í•´ì•¼í•˜ëŠ”ê°€?</strong></p>

<blockquote>
  <p>í•„ìëŠ” ì²˜ìŒì— ì˜ë¬¸ì´ì—ˆë‹¤. í•˜ì§€ë§Œ êµ¬í˜„í•˜ë©´ì„œ ì˜ë¬¸ì ì„ í•´ê²°í•  ìˆ˜ ìˆì—ˆë‹¤.</p>
</blockquote>

<p>í”„ë¡ì‹œì˜ ë¬¸ì œì ì¤‘ í•˜ë‚˜ëŠ” <strong>ë¶€ê°€ê¸°ëŠ¥ì´ í•„ìš”ì—†ëŠ” ë©”ì„œë“œë„ êµ¬í˜„í•´ì„œ íƒ€ê¹ƒìœ¼ë¡œ ìœ„ì„í•˜ëŠ” ì½”ë“œë¥¼ ì¼ì¼ì´ ë§Œë“¤ì–´ì¤˜ì•¼í•œë‹¤ëŠ” ê²ƒì´ë‹¤.</strong></p>

<p>ì‹¬ì§€ì–´ íƒ€ê¹ƒ ì¸í„°í˜ì´ìŠ¤ì˜ ë©”ì„œë“œê°€ ì¶”ê°€ë˜ê±°ë‚˜ ë³€ê²½ë  ë•Œë§ˆë‹¤ í•¨ê»˜ ìˆ˜ì •í•´ì¤˜ì•¼ í•œë‹¤.</p>

<p>í˜„ì¬ í”„ë¡ì‹œë¥¼ í†µí•´ ì»¤ìŠ¤í…€í•´ì•¼í•˜ëŠ” ì¸í„°í˜ì´ìŠ¤ëŠ” <code class="language-plaintext highlighter-rouge">Connection</code>ì´ë‹¤.</p>

<p><strong><a href="https://docs.oracle.com/javase/8/docs/api/java/sql/Connection.html">Docs - Connection</a>ë¥¼ ê°€ì„œ ë©”ì„œë“œ ê°œìˆ˜ë¥¼ ë³´ë©´ ì•Œê² ì§€ë§Œ, 10ê°œê°€ í›Œì© ë„˜ëŠ”ë‹¤.</strong></p>

<p><strong>ë°˜ë©´ì—, ì»¤ìŠ¤í…€ì— ì‚¬ìš©ë˜ëŠ” ë©”ì„œë“œëŠ” <code class="language-plaintext highlighter-rouge">prepareStatement</code>ë©”ì„œë“œ ë¿ì´ë‹¤.</strong></p>

<p>ì¦‰, <strong>ê´€ë ¨ì—†ëŠ” 10ê°œê°€ ë„˜ëŠ” ë©”ì„œë“œë¥¼ ëª¨ë‘ ìœ„ì„í•´ì£¼ëŠ” ì½”ë“œë¥¼ ì‘ì„±í•´ì¤˜ì•¼í•œë‹¤.</strong></p>

<p>ì´ëŸ° ìˆ˜ê³ ìŠ¤ëŸ¬ì›€ì„ í•´ê²°í•˜ê¸° ìœ„í•´ì„œ ë‹¤ì´ë‚´ë¯¹ í”„ë¡ì‹œë¥¼ ì´ìš©í•œë‹¤.</p>

<p><br /></p>

<h1 id="ì¿¼ë¦¬-ì¹´ìš´íŒ…-êµ¬í˜„">ì¿¼ë¦¬ ì¹´ìš´íŒ… êµ¬í˜„</h1>
<p>ì´ì œ ë³¸ê²©ì ìœ¼ë¡œ ì¿¼ë¦¬ ì¹´ìš´íŒ…ì„ ì ìš©ì‹œì¼œ N + 1 ë¬¸ì œë¥¼ í•´ê²°ë³¸ë‹¤.</p>

<p>í”„ë¡ì‹œë¥¼ ì ìš©í•˜ëŠ” ê²ƒì„ í°ê·¸ë¦¼ìœ¼ë¡œ ê·¸ë ¤ë³´ë©´ ë‹¤ìŒê³¼ ê°™ë‹¤.</p>

<p align="center"><img src="../assets/img/binghe/21-10-08-query-counter/proxy_before.png" /><br />ì ìš©ì „ </p>

<p><br /></p>

<p align="center"><img src="../assets/img/binghe/21-10-08-query-counter/proxy_after.png" /><br />ì ìš©í›„ </p>

<p><br /></p>

<p><strong>ì¹´ìš´íŠ¸ ë°ì´í„° ê°ì²´ êµ¬í˜„</strong></p>

<blockquote>
  <p>Count</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Getter</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Count</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kt">long</span> <span class="n">value</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Count</span><span class="o">(</span><span class="kt">long</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Count</span> <span class="nf">countOne</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Count</span><span class="o">(++</span><span class="n">value</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <p>QueryCounter</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Getter</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">QueryCounter</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">Count</span> <span class="n">count</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">countable</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">QueryCounter</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">countable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="n">count</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Count</span><span class="o">(</span><span class="mi">0L</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">startCount</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">countable</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="n">count</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Count</span><span class="o">(</span><span class="mi">0L</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">countOne</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">isCountable</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"[Error] ì•„ì§ ì¹´ìš´íŠ¸ë¥¼ ì‹œì‘í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">count</span><span class="o">.</span><span class="na">countOne</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">endCount</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">countable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li><a href="https://github.com/binghe819/spring-query-counter/blob/main/src/test/java/com/binghe/querycounter/query_counter/QueryCounterTest.java">QueryCounter í…ŒìŠ¤íŠ¸ ì½”ë“œ</a></li>
</ul>

<p><br /></p>

<p><strong>Connection í”„ë¡ì‹œ êµ¬í˜„</strong></p>

<blockquote>
  <p>ProxyConnectionHandler</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProxyConnectionHandler</span> <span class="kd">implements</span> <span class="nc">InvocationHandler</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Connection</span> <span class="n">connection</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">QueryCounter</span> <span class="n">queryCounter</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">ProxyConnectionHandler</span><span class="o">(</span><span class="nc">Connection</span> <span class="n">connection</span><span class="o">,</span> <span class="nc">QueryCounter</span> <span class="n">queryCounter</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">connection</span> <span class="o">=</span> <span class="n">connection</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">queryCounter</span> <span class="o">=</span> <span class="n">queryCounter</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// ì¿¼ë¦¬ ì¹´ìš´íŒ… (ë¶€ê°€ ê¸°ëŠ¥ êµ¬í˜„)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="nc">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">queryCounter</span><span class="o">.</span><span class="na">isCountable</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"prepareStatement"</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">return</span> <span class="nf">getConnectionWithCountQuery</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span> <span class="c1">// í•µì‹¬ ë¡œì§ í˜¸ì¶œ ë° ë°˜í™˜</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">connection</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span> <span class="c1">// í•µì‹¬ ë¡œì§ í˜¸ì¶œ ë° ë°˜í™˜</span>
    <span class="o">}</span>

    <span class="c1">// ì¹´ìš´íŠ¸</span>
    <span class="kd">private</span> <span class="nc">Object</span> <span class="nf">getConnectionWithCountQuery</span><span class="o">(</span><span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="nc">InvocationTargetException</span><span class="o">,</span> <span class="nc">IllegalAccessException</span> <span class="o">{</span>
        <span class="nc">PreparedStatement</span> <span class="n">preparedStatement</span> <span class="o">=</span> <span class="o">(</span><span class="nc">PreparedStatement</span><span class="o">)</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">connection</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>

        <span class="k">for</span> <span class="o">(</span><span class="nc">Object</span> <span class="n">statement</span> <span class="o">:</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">isQueryStatement</span><span class="o">(</span><span class="n">statement</span><span class="o">))</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"## Query : "</span> <span class="o">+</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">statement</span><span class="o">);</span> <span class="c1">// ì¶”í›„ì— ë¡œê¹…ìœ¼ë¡œ ìˆ˜ì • ì˜ˆì •</span>
                <span class="n">queryCounter</span><span class="o">.</span><span class="na">countOne</span><span class="o">();</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">preparedStatement</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// preparedStatementê°€ í˜¸ì¶œë  ë•Œ í•´ë‹¹ ë§¤ê°œë³€ìˆ˜ê°€ String í˜•ì‹ì´ë©°, selectìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ì¿¼ë¦¬ì¸ì§€ ì²´í¬.</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isQueryStatement</span><span class="o">(</span><span class="nc">Object</span> <span class="n">statement</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">statement</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span> <span class="c1">// ë§¤ê°œë³€ìˆ˜ê°€ Stringì¸ì§€ í™•ì¸</span>
            <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">statement</span><span class="o">;</span> 
            <span class="k">return</span> <span class="n">sql</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"select"</span><span class="o">);</span> 
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ì–´ë ¤ì›Œ ë³´ì´ì§€ë§Œ, ì‚¬ì‹¤ ê°„ë‹¨í•œ ì½”ë“œì´ë‹¤.</p>

<p><strong>ë‹¤ì´ë‚´ë¯¹ í”„ë¡ì‹œë¥¼ ì´ìš©í•˜ì—¬ <code class="language-plaintext highlighter-rouge">invoke</code>ì— ë„˜ì–´ì˜¤ëŠ” í˜¸ì¶œ ë©”ì„œë“œ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">PreparedStatement</code>ë©”ì„œë“œë©´ í•´ë‹¹ ë©”ì„œë“œì˜ ë§¤ê°œë³€ìˆ˜ë¥¼ ë½‘ì•„ë‚´ì„œ ì¹´ìš´íŒ…í•˜ëŠ” ê²ƒì´ë‹¤.</strong></p>

<p><a href="https://github.com/binghe819/spring-query-counter/blob/main/src/main/java/com/binghe/querycounter/query_counter/ProxyConnectionHandler.java">ProxyConnectionHandler - ì†ŒìŠ¤ ì½”ë“œ</a></p>

<p><br /></p>

<p><strong>DataSource í”„ë¡ì‹œ êµ¬í˜„</strong></p>

<blockquote>
  <p>CountDataSource</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CountDataSource</span> <span class="kd">implements</span> <span class="nc">DataSource</span> <span class="o">{</span>
    
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">QueryCounter</span> <span class="n">queryCounter</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">DataSource</span> <span class="n">targetDataSource</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">CountDataSource</span><span class="o">(</span><span class="nc">QueryCounter</span> <span class="n">queryCounter</span><span class="o">,</span> <span class="nc">DataSource</span> <span class="n">targetDataSource</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">queryCounter</span> <span class="o">=</span> <span class="n">queryCounter</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">targetDataSource</span> <span class="o">=</span> <span class="n">targetDataSource</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Connection</span> <span class="nf">getConnection</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">targetDataSource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
        <span class="k">return</span> <span class="o">(</span><span class="nc">Connection</span><span class="o">)</span> <span class="nc">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span>
            <span class="n">connection</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getClassLoader</span><span class="o">(),</span>
            <span class="n">connection</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getInterfaces</span><span class="o">(),</span>
            <span class="k">new</span> <span class="nf">ProxyConnectionHandler</span><span class="o">(</span><span class="n">connection</span><span class="o">,</span> <span class="n">queryCounter</span><span class="o">)</span>
        <span class="o">);</span>
    <span class="o">}</span>

    <span class="o">...</span> <span class="n">íƒ€ê¹ƒìœ¼ë¡œ</span> <span class="n">ìœ„ì„í•˜ëŠ”</span> <span class="n">ì½”ë“œ</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ì´ì œ <code class="language-plaintext highlighter-rouge">Connection</code>ì— í”„ë¡ì‹œë¥¼ ì„¤ì •í•´ì£¼ê¸° ìœ„í•´ì„œ ê¸°ì¡´ì˜ <code class="language-plaintext highlighter-rouge">DataSource</code>ì˜ í”„ë¡ì‹œ ì—­í• ì„ í•˜ëŠ” <code class="language-plaintext highlighter-rouge">CountDataSource</code> ìƒì„±í•´ì£¼ì—ˆë‹¤.</p>

<p><a href="https://github.com/binghe819/spring-query-counter/blob/main/src/main/java/com/binghe/querycounter/query_counter/CountDataSource.java">CountDataSource - ì†ŒìŠ¤ ì½”ë“œ</a></p>

<p><br /></p>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">getConnection</code>ì œì™¸í•˜ê³ ëŠ” ëª¨ë“  ë©”ì„œë“œì— ìœ„ì„í•˜ëŠ” ì½”ë“œë¥¼ ì‚½ì…í•´ì¤˜ì•¼í•œë‹¤.</p>

  <p>í”„ë¡ì‹œì˜ ë‹¨ì ì´ê¸°ë„ í•˜ë©°, ì´ ë¶€ë¶„ë„ ë‹¤ì´ë‚´ë¯¹ í”„ë¡ì‹œë¥¼ ì‚¬ìš©í•´ë„ ì¢‹ë‹¤.</p>

  <p>í•˜ì§€ë§Œ í•„ìëŠ” ì¦ì€ ë¦¬í”Œë ‰ì…˜ì€ ì„±ëŠ¥ìƒ ì¢‹ì§€ ì•Šê³ , ë©”ì„œë“œì˜ ê°œìˆ˜ê°€ ì ìœ¼ë¯€ë¡œ, ì´ ë¶€ë¶„ì€ ì¼ë°˜ì ì¸ í”„ë¡ì‹œ íŒ¨í„´ì„ ì‚¬ìš©í–ˆë‹¤.</p>
</blockquote>

<p><br /></p>

<p><strong>DataSource ì„¤ì •</strong></p>

<blockquote>
  <p>DataSourceConfig</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DataSourceConfig</span> <span class="o">{</span>
    
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">QueryCounter</span> <span class="nf">queryCounter</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">QueryCounter</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">DataSource</span> <span class="nf">dataSource</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">DataSource</span> <span class="n">dataSource</span> <span class="o">=</span> <span class="nc">DataSourceBuilder</span><span class="o">.</span><span class="na">create</span><span class="o">()</span>
            <span class="o">.</span><span class="na">driverClassName</span><span class="o">(</span><span class="s">"org.h2.Driver"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">url</span><span class="o">(</span><span class="s">"jdbc:h2:mem:~/test;MODE=MySQL;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">username</span><span class="o">(</span><span class="s">"SA"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">password</span><span class="o">(</span><span class="s">""</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">CountDataSource</span><span class="o">(</span><span class="n">queryCounter</span><span class="o">(),</span> <span class="n">dataSource</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">QueryCount</code>ë¥¼ í†µí•´ ëª‡ ë²ˆ ì¿¼ë¦¬ê°€ ë‚ ë¼ê°”ëŠ”ì§€ í™•ì¸í•´ì•¼í•˜ê¸°ì—, ë¹ˆìœ¼ë¡œ ë“±ë¡í•˜ì—¬ ì—¬ëŸ¬ í…ŒìŠ¤íŠ¸ ì½”ë“œì—ì„œ ì£¼ì…ë°›ì•„ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•œë‹¤.</p>

<p><code class="language-plaintext highlighter-rouge">DataSource</code>ëŠ” ìœ„ì—ì„œ ë§Œë“  í”„ë¡ì‹œ ê°ì²´ (<code class="language-plaintext highlighter-rouge">CountDataSource</code>)ë¥¼ ë°˜í™˜í•˜ë„ë¡ ì„¤ì •í•œë‹¤.</p>

<blockquote>
  <p>ê°€ëŠ¥í•œ ì‰½ê²Œ ì½”ë“œë¥¼ ì„¤ëª…í•  ìˆ˜ ìˆë„ë¡, ì¿¼ë¦¬ë¥¼ ë¡œê¹…í•˜ëŠ” ê¸°ëŠ¥ì„ ì œì™¸í–ˆë‹¤.</p>
</blockquote>

<p><br /></p>

<p><strong>ì‚¬ìš©ë²•</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">queryCounter</span><span class="o">.</span><span class="na">startCount</span><span class="o">();</span> <span class="c1">// ì¹´ìš´íŠ¸ ì‹œì‘</span>
<span class="n">xxxrepository</span><span class="o">.</span><span class="na">findById</span><span class="o">();</span>
<span class="n">xxxrepository</span><span class="o">.</span><span class="na">findById</span><span class="o">();</span>
<span class="n">queryCounter</span><span class="o">.</span><span class="na">getCount</span><span class="o">();</span> <span class="c1">// ê°œìˆ˜ í™•ì¸</span>
<span class="n">queryCounter</span><span class="o">.</span><span class="na">endCount</span><span class="o">();</span> <span class="c1">// ì¹´ìš´íŠ¸ ì¢…ë£Œ ë° ë¦¬ì…‹</span>
</code></pre></div></div>

<p>ì‚¬ìš©ë²•ì€ ìœ„ì™€ ê°™ì´ ê°„ë‹¨í•˜ë‹¤.</p>
<ol>
  <li>ì¹´ìš´íŠ¸ ì‹œì‘</li>
  <li>ì¿¼ë¦¬ ì‹¤í–‰</li>
  <li>ì¹´ìš´íŠ¸ ê²°ê³¼ í™•ì¸</li>
  <li>ì¹´ìš´íŠ¸ ì¢…ë£Œ ë° ë¦¬ì…‹</li>
</ol>

<blockquote>
  <p>4ë²ˆì—ì„œ ë‹¤ì‹œ 1ë²ˆìœ¼ë¡œ ê°€ëŠ” ê²ƒë„ ê°€ëŠ¥í•˜ë‹¤.</p>
</blockquote>

<p><br /></p>

<h1 id="ì‚¬ìš©-ì˜ˆì‹œ">ì‚¬ìš© ì˜ˆì‹œ</h1>

<p>ì¿¼ë¦¬ ì¹´ìš´íŒ…ì˜ ì˜ˆì‹œë¥¼ ì‚´í´ë³¸ë‹¤.</p>

<p><br /></p>

<h2 id="ìºì‹±-í…ŒìŠ¤íŠ¸">ìºì‹± í…ŒìŠ¤íŠ¸</h2>

<p>ìºì‹±ì€ í…ŒìŠ¤íŠ¸í•˜ê¸° ìƒê°ë³´ë‹¤ ê¹Œë‹¤ë¡­ë‹¤. í•˜ì§€ë§Œ, DBì— ì¿¼ë¦¬ê°€ ë‚ ë¼ ê°”ëŠ”ì§€ë§Œ í™•ì¸ê°€ëŠ¥í•˜ë‹¤ë©´ ì‰½ê²Œ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆë‹¤.</p>

<p>ì‹¤ì œ ê¹ƒ-ë“¤ë‹¤ì—ì„œëŠ” ìºì‹±ì„ í…ŒìŠ¤íŠ¸í•˜ê¸° ìœ„í•´ì„œ, QueryCounterë¥¼ ì‚¬ìš©í•œë‹¤.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@DisplayName</span><span class="o">(</span><span class="s">"ìºì‹± - ë¹„ë¡œê·¸ì¸ í™ˆí”¼ë“œ ì¡°íšŒì‹œ ë‘ ë²ˆì§¸ ì¡°íšŒë¶€í„°ëŠ” ìºì‹œ ì €ì¥ì†Œì—ì„œ ê°€ì ¸ì˜¨ë‹¤. (í˜„ì¬ í˜ì´ì§€ë‹¹ ì¿¼ë¦¬ëŠ” 6ë²ˆ)"</span><span class="o">)</span>
<span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">readHomeFeed_Guest_LatestPosts</span><span class="o">()</span> <span class="o">{</span>
  <span class="c1">// given</span>
  <span class="o">...</span> <span class="n">ê²Œì‹œë¬¼</span> <span class="n">ì‘ì„±</span> <span class="n">ì½”ë“œ</span> <span class="o">...</span>

  <span class="c1">// when</span>
  <span class="n">queryCounter</span><span class="o">.</span><span class="na">startCount</span><span class="o">();</span> <span class="c1">// ì¿¼ë¦¬ ì¹´ìš´íŠ¸ ì‹œì‘</span>
  <span class="n">postFeedService</span><span class="o">.</span><span class="na">homeFeed</span><span class="o">(</span><span class="n">homeFeedRequestDto</span><span class="o">);</span> <span class="c1">// ì²«ë²ˆì§¸ ì¡°íšŒ (ìºì‹±)</span>

  <span class="c1">// ë‘ë²ˆì§¸ ì¡°íšŒ (ì´ë•Œ DBì— ì¿¼ë¦¬ë¥¼ ë‚ ë¦¬ì§€ ì•ŠëŠ”ë‹¤.)</span>
  <span class="nc">List</span><span class="o">&lt;</span><span class="nc">PostResponseDto</span><span class="o">&gt;</span> <span class="n">postResponseDtos</span> <span class="o">=</span> <span class="n">postFeedService</span><span class="o">.</span><span class="na">homeFeed</span><span class="o">(</span><span class="n">homeFeedRequestDto</span><span class="o">);</span>

  <span class="c1">// then</span>
  <span class="n">assertThat</span><span class="o">(</span><span class="n">queryCounter</span><span class="o">.</span><span class="na">getCount</span><span class="o">().</span><span class="na">getValue</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">6L</span><span class="o">);</span> <span class="c1">// ì¿¼ë¦¬ ì¹´ìš´íŒ…ì„ í†µí•œ í…ŒìŠ¤íŠ¸</span>
<span class="o">}</span>
</code></pre></div></div>

<p><br /></p>

<h2 id="n--1-ë¬¸ì œ-ë¶„ì„">N + 1 ë¬¸ì œ ë¶„ì„</h2>

<p>ì´ì œ ë³¸ê²©ì ìœ¼ë¡œ êµ¬í˜„í•œ QueryCounterë¡œ N + 1ë¬¸ì œë¥¼ ì‚´í´ë´ë³´ì.</p>

<p align="center"><img src="../assets/img/binghe/21-10-08-query-counter/N_1_count_example.png" width="450" /><br />N + 1 ë¬¸ì œ í•´ê²° ì „ </p>

<p><br /></p>

<p>ì´ì œ fetch joinìœ¼ë¡œ N + 1ì„ í•´ê²°í•´ë³´ê³  ë‹¤ì‹œ í…ŒìŠ¤íŠ¸ë¥¼ ëŒë ¤ë³´ë©´ ì•„ë˜ì™€ ê°™ì´ ì¿¼ë¦¬ ê°œìˆ˜ê°€ 1ë¡œ ë°”ë€ ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.</p>

<p align="center"><img src="../assets/img/binghe/21-10-08-query-counter/N_1_count_after_example.png" /><br />N + 1 ë¬¸ì œ í•´ê²° í›„ </p>

<p>ìœ„ì™€ ê°™ì´ ì¿¼ë¦¬ ì¹´ìš´íŒ…ì„ ì‚¬ìš©í•˜ë©´ N + 1 ë¬¸ì œì— ëŒ€í•œ ë¶„ì„ì´ í›¨ì”¬ ì‰½ë‹¤.</p>

<p><br /></p>

<h1 id="ë§ˆì¹˜ë©°">ë§ˆì¹˜ë©°</h1>
<p>ìºì‹±ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ì¿¼ë¦¬ ì¹´ìš´í„°ê°€ í•„ìš”í•˜ì—¬ êµ¬í˜„í•˜ë‹¤ë³´ë‹ˆ ì´ë ‡ê²Œê¹Œì§€ ì •ë¦¬í•˜ê²Œ ë˜ì—ˆë‹¤.</p>

<p>ì´í•´í•˜ê³  ì •ë¦¬í•˜ëŠ”ë° ê½¤ í˜ë“¤ì—ˆì§€ë§Œ, ê·¸ë˜ë„ ê·¸ ê³¼ì •ì—ì„œ í”„ë¡ì‹œì™€ ë‹¤ì´ë‚´ë¯¹ í”„ë¡ì‹œ, JDBC, Hibernateë“±ì˜ ì´í•´ë„ê°€ ê¹Šì–´ì ¸ì„œ ì¢‹ì€ ê²½í—˜ì´ì—ˆë‹¤!</p>

<p>ì´í›„ì—ë„ ì´ì™€ ê°™ì´ ê°ì²´ì§€í–¥ì„ ì‚¬ìš©í•œ ì»¤ìŠ¤í…€ì„ ë”ìš± ë§ì´ í•´ë³´ë¦¬~</p>

<blockquote>
  <p>ì•„! Thanks to ë‚˜ë´„ (Iâ€™m Spring) ê·¸ëŠ” G.O.D</p>
</blockquote>


      <div class="page-footer">
        <div class="page-share">
          <a href="https://twitter.com/intent/tweet?text=ë‹¤ì´ë‚´ë¯¹ í”„ë¡ì‹œë¥¼ ì´ìš©í•œ ì¿¼ë¦¬ ì¹´ìš´íŒ… ì ìš©ê¸° (feat. ìºì‹± í…ŒìŠ¤íŠ¸)&url=https://2021-pick-git.github.io//query-counter/" title="Share on Twitter" rel="nofollow" target="_blank">Twitter</a>
          <a href="https://facebook.com/sharer.php?u=https://2021-pick-git.github.io//query-counter/" title="Share on Facebook" rel="nofollow" target="_blank">Facebook</a>
          <a href="https://plus.google.com/share?url=https://2021-pick-git.github.io//query-counter/" title="Share on Google+" rel="nofollow" target="_blank">Google+</a>
        </div>
        <div class="page-tag">
          
            <a href="/tags#ë°±ì—”ë“œ" class="tag">&#35; ë°±ì—”ë“œ</a>
          
            <a href="/tags#ë‹¤ì´ë‚´ë¯¹í”„ë¡ì‹œ" class="tag">&#35; ë‹¤ì´ë‚´ë¯¹í”„ë¡ì‹œ</a>
          
            <a href="/tags#ì¿¼ë¦¬ì¹´ìš´íŒ…" class="tag">&#35; ì¿¼ë¦¬ì¹´ìš´íŒ…</a>
          
            <a href="/tags#ìºì‹±í…ŒìŠ¤íŠ¸" class="tag">&#35; ìºì‹±í…ŒìŠ¤íŠ¸</a>
          
        </div>
      </div>
      <section class="comment-area">
  <div class="comment-wrapper">
    
  </div>
</section> <!-- End Comment Area -->

    </div> <!-- End Wrap Content -->
  </div> <!-- End Page Content -->

  <script src="https://utteranc.es/client.js"
        repo="2021-pick-git/pick-git-comments"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
  </script>
</article> <!-- End Article Page -->

</div>

  </div>
  
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', '', 'auto');
  ga('send', 'pageview');
</script> <!-- End Analytics -->

</body>
</html>
