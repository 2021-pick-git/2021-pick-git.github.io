<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>M1(ARM)에서 Embedded Redis를 사용하는 방법 - BingheCompany 🇰🇷</title>

  <!-- Edit site and author settings in `_config.yml` to make the social details your own -->

    <meta content="BingheCompany 🇰🇷" property="og:site_name">
  
    <meta content="M1(ARM)에서 Embedded Redis를 사용하는 방법" property="og:title">
  
  
    <meta content="article" property="og:type">
  
  
    <meta content="M1(ARM)에서 Embedded Redis를 사용하는 방법을 알아봐요." property="og:description">
  
  
    <meta content="https://2021-pick-git.github.io//M1(ARM)%EC%97%90%EC%84%9C-Embedded-Redis%EB%A5%BC-%EC%82%AC%EC%9A%A9%ED%95%98%EB%8A%94-%EB%B0%A9%EB%B2%95/" property="og:url">
  
  
    <meta content="2021-10-20T16:21:00+09:00" property="article:published_time">
    <meta content="https://2021-pick-git.github.io//about/" property="article:author">
  
  
    <meta content="https://2021-pick-git.github.io//assets/img/redis-on-m1.png" property="og:image">
  
  
    
  
  
    
    <meta content="백엔드" property="article:tag">
    
    <meta content="Database" property="article:tag">
    
    <meta content="Embedded Redis" property="article:tag">
    
    <meta content="M1" property="article:tag">
    
    <meta content="ARM" property="article:tag">
    
  

    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@">
    <meta name="twitter:creator" content="@">
  
    <meta name="twitter:title" content="M1(ARM)에서 Embedded Redis를 사용하는 방법">
  
  
    <meta name="twitter:url" content="https://2021-pick-git.github.io//M1(ARM)%EC%97%90%EC%84%9C-Embedded-Redis%EB%A5%BC-%EC%82%AC%EC%9A%A9%ED%95%98%EB%8A%94-%EB%B0%A9%EB%B2%95/">
  
  
    <meta name="twitter:description" content="M1(ARM)에서 Embedded Redis를 사용하는 방법을 알아봐요.">
  
  
    <meta name="twitter:image:src" content="https://2021-pick-git.github.io//assets/img/redis-on-m1.png">
  

	<meta name="description" content="M1(ARM)에서 Embedded Redis를 사용하는 방법을 알아봐요.">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta property="og:image" content="">
	<link rel="shortcut icon" href="/assets/img/favicon/favicon.ico" type="image/x-icon">
	<link rel="apple-touch-icon" href="/assets/img/favicon/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicon/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicon/apple-touch-icon-144x144.png">
	<!-- Chrome, Firefox OS and Opera -->
	<meta name="theme-color" content="#263959">
	<!-- Windows Phone -->
	<meta name="msapplication-navbutton-color" content="#263959">
	<!-- iOS Safari -->
	<meta name="apple-mobile-web-app-status-bar-style" content="#263959">
	<!-- Google Fonts -->
	<link href="https://fonts.googleapis.com/css?family=PT+Serif:400,700|Lato:300,400,700&display=swap" rel="stylesheet">
	<!-- Font Awesome -->
	<link rel="stylesheet" href="/assets/fonts/font-awesome/css/font-awesome.min.css">
	<!-- Styles -->
	<link rel="stylesheet" href="/assets/css/main.css">
</head>

<body>

  <div class="wrapper">
    <aside class="sidebar">
  <header>
    <div class="about">
      <div class="cover-author-image">
        <a href="/"><img src="/assets/img/mark.jpg" alt="깃-들다 (pick-git)"></a>
      </div>
      <div class="author-name">깃-들다 (pick-git)</div>
      <p>깃-들다 기술 블로그입니다.</br>😇💪</br> This is a tech blog for pick-git.</br> ピクギトの技術のblogです。</br> 这是 pick-git 科技博客.</br></p>
    </div>
  </header> <!-- End Header -->
  <footer>
    <section class="contact">
      <h3 class="contact-title">Contact me</h3>
      <ul>
        <!-- 
          <li><a href="https://twitter.com/artemsheludko_" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
        
        
          <li><a href="https://facebook.com/" target="_blank"><i class="fa fa-facebook" aria-hidden="true"></i></a></li>
         -->
        
          <li class="github"><a href="http://github.com/woowacourse-teams/2021-pick-git" target="_blank"><i class="fa fa-github"></i></a></li>
        
        <!-- 
          <li class="linkedin"><a href="https://in.linkedin.com/" target="_blank"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li>
        
        
          <li class="email"><a href="mailto:example.david@blog.com"><i class="fa fa-envelope-o" aria-hidden="true"></i></a></li>
         -->
      </ul>
    </section> <!-- End Section Contact -->
    <div class="copyright">
      <p>2021 &copy; 깃-들다 (pick-git)</p>
    </div>
  </footer> <!-- End Footer -->
</aside> <!-- End Sidebar -->
<div class="content-box clearfix">
  <article class="article-page">
  <div class="page-content">
    
    <div class="page-cover-image">
      <figure>
        <img class="page-image" src=/assets/img/redis-on-m1.png alt="M1(ARM)에서 Embedded Redis를 사용하는 방법">
        
      </figure>
    </div> <!-- End Page Cover Image -->
    
    <div class="wrap-content">
      <header class="header-page">
        <h1 class="page-title">M1(ARM)에서 Embedded Redis를 사용하는 방법</h1>
        <div class="page-date"><span>2021, Oct 20&nbsp;&nbsp;&nbsp;&nbsp;</span></div>
      </header>
      <p>안녕하세요, 다니입니다. 🌻</p>

<p><br /></p>

<h2 id="이슈-1">이슈 1</h2>

<h3 id="문제-상황">문제 상황</h3>

<p>우아한테크코스 팀 프로젝트를 진행하며 Redis를 도입했다.<br />
테스트 환경에서는 Embedded Redis가 동작하게 구성했는데, M1에서는 해당 DB가 실행되지 않는 현상이 발생했다.<br />
백엔드 팀원 대부분이 M1을 사용하고 있어 이를 해결하는 게 우선시 됐다.<br /></p>

<p>관련 내용을 찾아보다가</p>

<ul>
  <li>Embedded Redis 라이브러리에서 mac_arm64용 바이너리가 준비되어 있지 않다.</li>
  <li>또, 소스 코드에도 MAC_OS_X_arm64가 없다.</li>
</ul>

<p>이와 같은 사실을 알게 됐다.<br /></p>

<p>참고한 글에 따르면, Embedded Redis 라이브러리를 수정해서 사용할 수도 있다고 한다.<br />
하지만, 공식 문서에서는 사용자가 직접 바이너리를 지정해서 이용하는 걸 추천한다고 설명했다.<br /></p>

<p>그래서 <code class="language-plaintext highlighter-rouge">RedisServer</code> 객체를 활용하는 방식을 선택했다.<br /></p>

<h3 id="해결-방법">해결 방법</h3>

<p>먼저 Redis 소스 코드를 다운받고 컴파일한다.<br />
아래 과정을 거치면, <code class="language-plaintext highlighter-rouge">redis-6.2.5/src</code> 경로에 바이너리 파일들이 빌드되어 준비된다.<br /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// 소스 코드 다운로드
% wget https://download.redis.io/releases/redis-6.2.5.tar.gz

// 압축 해제
% <span class="nb">tar </span>xzf redis-6.2.5.tar.gz 

// redis-6.2.5 디렉토리 이동
% <span class="nb">cd </span>redis-6.2.5

// 파일 링크 및 설치 등
% make
</code></pre></div></div>

<p><br /></p>

<p>다음으로 <code class="language-plaintext highlighter-rouge">redis-server</code> 바이너리 파일을 실행한다.<br /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% src/redis-server

39720:C 20 Oct 2021 14:28:50.565 <span class="c"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span>
39720:C 20 Oct 2021 14:28:50.565 <span class="c"># Redis version=6.2.5, bits=64, commit=d9e6d08d, modified=0, pid=39720, just started</span>
39720:C 20 Oct 2021 14:28:50.565 <span class="c"># Warning: no config file specified, using the default config. In order to specify a config file use src/redis-server /path/to/redis.conf</span>
39720:M 20 Oct 2021 14:28:50.566 <span class="k">*</span> monotonic clock: POSIX clock_gettime
                _._                                                  
           _.-<span class="sb">``</span>__ <span class="s1">''</span>-._                                             
      _.-<span class="sb">``</span>    <span class="sb">`</span><span class="nb">.</span>  <span class="sb">`</span>_.  <span class="s1">''</span>-._           Redis 6.2.5 <span class="o">(</span>d9e6d08d/0<span class="o">)</span> 64 bit
  .-<span class="sb">``</span> .-<span class="sb">```</span><span class="nb">.</span>  <span class="sb">```</span><span class="se">\/</span>    _.,_ <span class="s1">''</span>-._                                  
 <span class="o">(</span>    <span class="s1">'      ,       .-`  | `,    )     Running in standalone mode
 |`-._`-...-` __...-.``-._|'</span><span class="sb">`</span> _.-<span class="s1">'|     Port: 6379
 |    `-._   `._    /     _.-'</span>    |     PID: 39720
  <span class="sb">`</span>-._    <span class="sb">`</span>-._  <span class="sb">`</span>-./  _.-<span class="s1">'    _.-'</span>                                   
 |<span class="sb">`</span>-._<span class="sb">`</span>-._    <span class="sb">`</span>-.__.-<span class="s1">'    _.-'</span>_.-<span class="s1">'|                                  
 |    `-._`-._        _.-'</span>_.-<span class="s1">'    |           https://redis.io       
  `-._    `-._`-.__.-'</span>_.-<span class="s1">'    _.-'</span>                                   
 |<span class="sb">`</span>-._<span class="sb">`</span>-._    <span class="sb">`</span>-.__.-<span class="s1">'    _.-'</span>_.-<span class="s1">'|                                  
 |    `-._`-._        _.-'</span>_.-<span class="s1">'    |                                  
  `-._    `-._`-.__.-'</span>_.-<span class="s1">'    _.-'</span>                                   
      <span class="sb">`</span>-._    <span class="sb">`</span>-.__.-<span class="s1">'    _.-'</span>                                       
          <span class="sb">`</span>-._        _.-<span class="s1">'                                           
              `-.__.-'</span>                                               

39720:M 20 Oct 2021 14:28:50.569 <span class="c"># Server initialized</span>
39720:M 20 Oct 2021 14:28:50.569 <span class="k">*</span> Ready to accept connections 
</code></pre></div></div>

<p><br /></p>

<p>앞에서 <code class="language-plaintext highlighter-rouge">redis-server</code>가 잘 실행됐다면, 해당 파일의 이름을 변경하여 프로젝트에 추가한다.<br />
이때, resources 디렉토리 하위에 복사해야 한다.<br /></p>

<p align="center">
    <img style="width: 490px; height: 180px" src="https://user-images.githubusercontent.com/50176238/138035778-731a34b3-995a-4244-9913-d657a5d5a7ac.png" />
</p>

<p><br /></p>

<p>마지막으로 <code class="language-plaintext highlighter-rouge">EmbeddedRedisConfiguration</code> 클래스에 아래 코드를 추가한다.<br />
여기까지 하면, M1에서도 Embedded Redis가 잘 작동된다.<br /></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@PostConstruct</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">redisServer</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">URISyntaxException</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">redisPort</span> <span class="o">=</span> <span class="n">isRedisRunning</span><span class="o">()</span> <span class="o">?</span> <span class="n">findAvailablePort</span><span class="o">()</span> <span class="o">:</span> <span class="n">port</span><span class="o">;</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">isArmMac</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">redisServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RedisServer</span><span class="o">(</span>
            <span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">getRedisFileForArcMac</span><span class="o">()),</span>
            <span class="n">redisPort</span>
        <span class="o">);</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">isArmMac</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">redisServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RedisServer</span><span class="o">(</span><span class="n">redisPort</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="n">redisServer</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isArmMac</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Objects</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"os.arch"</span><span class="o">),</span> <span class="s">"aarch64"</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
        <span class="nc">Objects</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"os.name"</span><span class="o">),</span> <span class="s">"Mac OS X"</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="nc">File</span> <span class="nf">getRedisFileForArcMac</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ClassPathResource</span><span class="o">(</span><span class="s">"binary/redis/redis-server-6.2.5-mac-arm64"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getFile</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">EmbeddedRedisServerException</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><br /></p>

<h2 id="이슈-2">이슈 2</h2>

<h3 id="문제-상황-1">문제 상황</h3>

<p>그런데, 나는 위의 방법을 적용해도 테스트가 계속 실패했다.<br />
어떤 부분을 놓쳤는지 원인을 분석했는데, JDK 버전이 호환되지 않아 터진 것이었다.<br />
기존에는 default 버전을 쓰고 있었는데, <code class="language-plaintext highlighter-rouge">Azul Zulu Community(M1용)</code> 버전으로 바꿔야 했다.<br /></p>

<h3 id="해결-방법-1">해결 방법</h3>

<p>해당 버전으로 변경하고 실행해보니까, 이번에는 정말로 문제 없이 잘 작동했다.<br />
테스트 실행 속도가 이전보다 빨라진 건 덤이었다!<br /></p>

<p align="center">
    <img src="https://user-images.githubusercontent.com/50176238/137240384-f05b3448-dc53-4ee6-b044-972c7a19d94f.png" />
</p>

<p><br /></p>

<h2 id="references">References</h2>

<ul>
  <li><a href="https://velog.io/@hakjong/ARM-Mac-M1-%EC%97%90%EC%84%9C-embedded-redis-%EC%82%AC%EC%9A%A9">ARM Mac (M1) 에서 embedded-redis 사용하기</a></li>
  <li><a href="https://redis.io/download">Redis - Download</a></li>
  <li><a href="https://cholchori.tistory.com/2167">Apple Silicon M1 용 어플 호환성+JDK</a></li>
</ul>

      <div class="page-footer">
        <div class="page-share">
          <a href="https://twitter.com/intent/tweet?text=M1(ARM)에서 Embedded Redis를 사용하는 방법&url=https://2021-pick-git.github.io//M1(ARM)%EC%97%90%EC%84%9C-Embedded-Redis%EB%A5%BC-%EC%82%AC%EC%9A%A9%ED%95%98%EB%8A%94-%EB%B0%A9%EB%B2%95/" title="Share on Twitter" rel="nofollow" target="_blank">Twitter</a>
          <a href="https://facebook.com/sharer.php?u=https://2021-pick-git.github.io//M1(ARM)%EC%97%90%EC%84%9C-Embedded-Redis%EB%A5%BC-%EC%82%AC%EC%9A%A9%ED%95%98%EB%8A%94-%EB%B0%A9%EB%B2%95/" title="Share on Facebook" rel="nofollow" target="_blank">Facebook</a>
          <a href="https://plus.google.com/share?url=https://2021-pick-git.github.io//M1(ARM)%EC%97%90%EC%84%9C-Embedded-Redis%EB%A5%BC-%EC%82%AC%EC%9A%A9%ED%95%98%EB%8A%94-%EB%B0%A9%EB%B2%95/" title="Share on Google+" rel="nofollow" target="_blank">Google+</a>
        </div>
        <div class="page-tag">
          
            <a href="/tags#백엔드" class="tag">&#35; 백엔드</a>
          
            <a href="/tags#Database" class="tag">&#35; Database</a>
          
            <a href="/tags#Embedded Redis" class="tag">&#35; Embedded Redis</a>
          
            <a href="/tags#M1" class="tag">&#35; M1</a>
          
            <a href="/tags#ARM" class="tag">&#35; ARM</a>
          
        </div>
      </div>
      <section class="comment-area">
  <div class="comment-wrapper">
    
  </div>
</section> <!-- End Comment Area -->

    </div> <!-- End Wrap Content -->
  </div> <!-- End Page Content -->

  <script src="https://utteranc.es/client.js"
        repo="2021-pick-git/pick-git-comments"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
  </script>
</article> <!-- End Article Page -->

</div>

  </div>
  
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', '', 'auto');
  ga('send', 'pageview');
</script> <!-- End Analytics -->

</body>
</html>
