<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>NGINX 로드 밸런싱 (무료 헬스체크를 곁들인) - BingheCompany 🇰🇷</title>

  <!-- Edit site and author settings in `_config.yml` to make the social details your own -->

    <meta content="BingheCompany 🇰🇷" property="og:site_name">
  
    <meta content="NGINX 로드 밸런싱 (무료 헬스체크를 곁들인)" property="og:title">
  
  
    <meta content="article" property="og:type">
  
  
    <meta content="NGINX 로드 밸런싱 (무료 헬스체크를 곁들인)" property="og:description">
  
  
    <meta content="https://2021-pick-git.github.io//NGINX-%EB%A1%9C%EB%93%9C-%EB%B0%B8%EB%9F%B0%EC%8B%B1-%EB%AC%B4%EB%A3%8C-%ED%97%AC%EC%8A%A4%EC%B2%B4%ED%81%AC%EB%A5%BC-%EA%B3%81%EB%93%A4%EC%9D%B8/" property="og:url">
  
  
    <meta content="2021-10-04T14:41:00+09:00" property="article:published_time">
    <meta content="https://2021-pick-git.github.io//about/" property="article:author">
  
  
    <meta content="https://2021-pick-git.github.io//assets/img/mark.jpg" property="og:image">
  
  
    
  
  
    
    <meta content="백엔드" property="article:tag">
    
    <meta content="NginX" property="article:tag">
    
    <meta content="HealthCheck" property="article:tag">
    
    <meta content="LoadBalancing" property="article:tag">
    
  

    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@">
    <meta name="twitter:creator" content="@">
  
    <meta name="twitter:title" content="NGINX 로드 밸런싱 (무료 헬스체크를 곁들인)">
  
  
    <meta name="twitter:url" content="https://2021-pick-git.github.io//NGINX-%EB%A1%9C%EB%93%9C-%EB%B0%B8%EB%9F%B0%EC%8B%B1-%EB%AC%B4%EB%A3%8C-%ED%97%AC%EC%8A%A4%EC%B2%B4%ED%81%AC%EB%A5%BC-%EA%B3%81%EB%93%A4%EC%9D%B8/">
  
  
    <meta name="twitter:description" content="NGINX 로드 밸런싱 (무료 헬스체크를 곁들인)">
  
  
    <meta name="twitter:image:src" content="https://2021-pick-git.github.io//assets/img/mark.jpg">
  

	<meta name="description" content="NGINX 로드 밸런싱 (무료 헬스체크를 곁들인)">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta property="og:image" content="">
	<link rel="shortcut icon" href="/assets/img/favicon/favicon.ico" type="image/x-icon">
	<link rel="apple-touch-icon" href="/assets/img/favicon/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicon/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicon/apple-touch-icon-144x144.png">
	<!-- Chrome, Firefox OS and Opera -->
	<meta name="theme-color" content="#263959">
	<!-- Windows Phone -->
	<meta name="msapplication-navbutton-color" content="#263959">
	<!-- iOS Safari -->
	<meta name="apple-mobile-web-app-status-bar-style" content="#263959">
	<!-- Google Fonts -->
	<link href="https://fonts.googleapis.com/css?family=PT+Serif:400,700|Lato:300,400,700&display=swap" rel="stylesheet">
	<!-- Font Awesome -->
	<link rel="stylesheet" href="/assets/fonts/font-awesome/css/font-awesome.min.css">
	<!-- Styles -->
	<link rel="stylesheet" href="/assets/css/main.css">
</head>

<body>

  <div class="wrapper">
    <aside class="sidebar">
  <header>
    <div class="about">
      <div class="cover-author-image">
        <a href="/"><img src="/assets/img/mark.jpg" alt="깃-들다 (pick-git)"></a>
      </div>
      <div class="author-name">깃-들다 (pick-git)</div>
      <p>깃-들다 기술 블로그입니다.</br>😇💪</br> This is a tech blog for pick-git.</br> ピクギトの技術のblogです。</br> 这是 pick-git 科技博客.</br></p>
    </div>
  </header> <!-- End Header -->
  <footer>
    <section class="contact">
      <h3 class="contact-title">Contact me</h3>
      <ul>
        <!-- 
          <li><a href="https://twitter.com/artemsheludko_" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
        
        
          <li><a href="https://facebook.com/" target="_blank"><i class="fa fa-facebook" aria-hidden="true"></i></a></li>
         -->
        
          <li class="github"><a href="http://github.com/woowacourse-teams/2021-pick-git" target="_blank"><i class="fa fa-github"></i></a></li>
        
        <!-- 
          <li class="linkedin"><a href="https://in.linkedin.com/" target="_blank"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li>
        
        
          <li class="email"><a href="mailto:example.david@blog.com"><i class="fa fa-envelope-o" aria-hidden="true"></i></a></li>
         -->
      </ul>
    </section> <!-- End Section Contact -->
    <div class="copyright">
      <p>2021 &copy; 깃-들다 (pick-git)</p>
    </div>
  </footer> <!-- End Footer -->
</aside> <!-- End Sidebar -->
<div class="content-box clearfix">
  <article class="article-page">
  <div class="page-content">
    
    <div class="page-cover-image">
      <figure>
        <img class="page-image" src=/assets/img/mark.jpg alt="NGINX 로드 밸런싱 (무료 헬스체크를 곁들인)">
        
      </figure>
    </div> <!-- End Page Cover Image -->
    
    <div class="wrap-content">
      <header class="header-page">
        <h1 class="page-title">NGINX 로드 밸런싱 (무료 헬스체크를 곁들인)</h1>
        <div class="page-date"><span>2021, Oct 04&nbsp;&nbsp;&nbsp;&nbsp;</span></div>
      </header>
      <h1 id="목차">목차</h1>

<p><br /></p>

<ul>
  <li><a href="#목차">목차</a></li>
  <li><a href="#개요">개요</a></li>
  <li><a href="#준비물">준비물</a></li>
  <li><a href="#nginx-컴파일-설치-with-module">NginX 컴파일 설치 with Module</a></li>
  <li><a href="#nginx-설정">NginX 설정</a>
    <ul>
      <li><a href="#로드-밸런싱-및-헬스-체크-설정">로드 밸런싱 및 헬스 체크 설정</a></li>
    </ul>
  </li>
  <li><a href="#nginx-실행">NginX 실행</a></li>
  <li><a href="#참고">참고</a></li>
</ul>

<p><br /></p>

<h1 id="들어가며">들어가며</h1>
<p>NginX는 대표적으로 리버스 프록시와 로드 밸런서 역할을 담당할 수 있는 웹 서버이다.</p>

<p>로드 밸런싱을 구현하면 꼭 같이 구성해야하는 기능이 있다. 바로 ‘헬스 체크’다.</p>

<p>‘헬스 체크’란 간단히 말하면 로드 밸런싱 서비스를 제공하는 다수의 서버의 상태를 점검하기 위한 기술이다.</p>

<blockquote>
  <p>쉽게 말해 WAS들의 건강을 체크하는 기술이다.</p>
</blockquote>

<p>NginX는 헬스 체크 기능을 간편히 설정할 수 있도록 해준다. 하지만 이 설정을 하기위해선 NginX Plus를 사용해야 하는데.. 바로! 유료버전이다…</p>

<blockquote>
  <p><a href="https://docs.nginx.com/nginx/admin-guide/load-balancer/http-health-check/">여기</a>를 가면 유료버전이라고 나와있다.</p>
</blockquote>

<p>대체하는 방법이 있나 서칭해보니 무료로 사용가능한 모듈이 존재했다.</p>

<p>이 글은 NginX에 무료로 사용가능한 헬스 체크 모듈 (<a href="https://github.com/yaoweibin/nginx_upstream_check_module">nginx_upstream_check_module</a>)를 설치하고 설정하는 방법에 대해서 다룬다.</p>

<blockquote>
  <p>환경</p>
  <ul>
    <li>Ubuntu 18.14 LTS</li>
    <li>NginX 1.14.2</li>
  </ul>
</blockquote>

<p><br /></p>

<h1 id="준비물">준비물</h1>
<p>로드 밸런싱과 헬스 체크 기능을 테스트하기위해 NginX서버와 두 개의 WAS를 구성해보자.</p>
<ul>
  <li>NginX 1대</li>
  <li>WAS 2대</li>
</ul>

<blockquote>
  <p>본 글은 AWS EC2 기준으로 작성되었습니다. (모든 EC2의 한 VPC안에 존재시키며, Private IP를 통해 통신합니다.)</p>
</blockquote>

<p><br /></p>

<p>또한, 각각의 WAS에는 Spring기반의 프로젝트는 실행해둔다. (아무 프로젝트를 실행하면 된다.)</p>

<blockquote>
  <p>필자는 <a href="https://github.com/spring-projects/spring-petclinic">Spring Petclinic</a>를 사용했다.</p>
</blockquote>

<p><br /></p>

<h1 id="nginx-컴파일-설치-with-module">NginX 컴파일 설치 with Module</h1>
<p>NginX를 쉽게 설치하는 방법으론 자동인스톨(ex <code class="language-plaintext highlighter-rouge">apt</code>)와 Docker 컨테이너가 있다. <a href="./NGINX%20%EC%84%A4%EC%B9%98.md">참고</a></p>

<p>하지만 위와 같은 방법은 특정 모듈을 같이 설치하지 못한다.</p>

<p>다시 말해, 특정 모듈은 컴파일 설치를 통해서만 설치 가능하다. 헬스 체크 모듈을 사용하기 위해선 NginX를 컴파일 설치해야하는 것이다.</p>

<blockquote>
  <p>공식 모듈 DOCS는 <a href="https://github.com/yaoweibin/nginx_upstream_check_module">여기</a>를 참고하세요.</p>
</blockquote>

<p><br /></p>

<p><strong>1. 설치 파일 다운로드</strong></p>

<p>헬스 체크 모듈을 <a href="https://github.com/yaoweibin/nginx_upstream_check_module">깃허브</a>에서 clone해온다.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>git clone https://github.com/yaoweibin/nginx_upstream_check_module.git
</code></pre></div></div>

<p><br /></p>

<p>NginX 다운로드 사이트에서 컴파일 버전도 다운받아준다. (본 글에선 1.14.2)</p>

<p>그리고 압축을 풀어준다.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>wget <span class="s1">'http://nginx.org/download/nginx-1.14.2.tar.gz'</span>
<span class="nv">$ </span><span class="nb">tar</span> <span class="nt">-xzvf</span> nginx-1.14.2.tar.gz
</code></pre></div></div>

<p><br /></p>

<p><strong>2. NginX 모듈 path</strong></p>

<p>압축 푼 NginX디렉토리에 들어가서 아래와 같이 헬스 체크 모듈을 patch 해준다. (NginX버전에 맞는 <code class="language-plaintext highlighter-rouge">*.patch</code>파일을 설정해주면 된다.)</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd </span>nginx-1.14.2/
<span class="nv">$ </span>patch <span class="nt">-p1</span> &lt; <span class="o">{</span><span class="nv">$module</span> <span class="nb">source </span>directory<span class="o">}</span>/check_1.14.0+.patch
</code></pre></div></div>
<p align="center"><img src="../assets/img/binghe/21-10-04-nginx-health-check/nginx_install_patch.png" />patch 결과</p>

<p><br /></p>

<p><strong>3. 설정하기 위한 의존성 설치</strong></p>

<p>이제 설치하기 위한 configure를 해야한다.</p>

<p>이때 필요한 의존성이 있다.</p>

<ul>
  <li>PCRE -&gt; <code class="language-plaintext highlighter-rouge">apt install libpcre3-dev</code>
    <ul>
      <li>NginX는 Perl5에서 사용하는 정규표현식 라이브러리인 PCRE를 사용한다.</li>
    </ul>
  </li>
  <li>openssl -&gt; <code class="language-plaintext highlighter-rouge">apt install openssl</code>, <code class="language-plaintext highlighter-rouge">sudo apt install libssl-dev</code>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">https</code> 모듈인 <code class="language-plaintext highlighter-rouge">HttpSslModule</code>을 사용하기 위해서 설치해줘야 한다.</li>
    </ul>
  </li>
  <li>zlib -&gt; <code class="language-plaintext highlighter-rouge">apt install zlib1g</code>, <code class="language-plaintext highlighter-rouge">apt install zlib1g-dev</code>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">ngx_http_gzip_module</code> 모듈을 사용하기 위해서 설치하는 zlib 라이브러리.</li>
    </ul>
  </li>
  <li>컴파일 -&gt; <code class="language-plaintext highlighter-rouge">apt install make</code>
    <ul>
      <li>경우에 따라 <code class="language-plaintext highlighter-rouge">gcc</code>와 <code class="language-plaintext highlighter-rouge">g++</code>를 설치해야할 수도 있다.</li>
    </ul>
  </li>
</ul>

<p><br /></p>

<p><strong>4. 컴파일 설치 전 configure</strong></p>

<p>NginX 소스 디렉토리로 이동하여 <code class="language-plaintext highlighter-rouge">configure</code> 명령을 실행한다.</p>

<p><code class="language-plaintext highlighter-rouge">configure</code>의 설정은 <a href="http://nginx.org/en/docs/configure.html">공식 문서</a>에서 쉽게 파악할 수 있다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>./configure <span class="nt">--add-module</span><span class="o">={</span><span class="nv">$module</span> <span class="nb">source </span>directory<span class="o">}</span> <span class="nt">--with-http_ssl_module</span>
</code></pre></div></div>

<p align="center"><img src="../assets/img/binghe/21-10-04-nginx-health-check/nginx_install_configure.png" /><br />설정 결과 </p>

<p><br /></p>

<p><strong>5. 컴파일 설치</strong></p>

<p>이제 마지막으로 컴파일 설치를 진행해주면 된다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>make
<span class="nv">$ </span>make <span class="nb">install</span>
</code></pre></div></div>

<p><br /></p>

<p><strong>이제 <code class="language-plaintext highlighter-rouge">/usr/local/nginx</code>를 가면 설치된 nginx를 찾을 수 있다.</strong></p>

<p align="center"><img src="../assets/img/binghe/21-10-04-nginx-health-check/nginx_compile_installed_directory.png" /> </p>

<ul>
  <li>conf: 설정 파일</li>
  <li>html: index와 500에러 관련 html (정적)</li>
  <li>logs: 로그 디렉터리 (기본)</li>
  <li>sbin: nginx 실행 파일 디렉토리</li>
</ul>

<p><br /></p>

<h1 id="nginx-설정">NginX 설정</h1>
<p>이제 헬스 체크 모듈을 포함한 NginX를 설치하였으니, 아래와 같이 설정해주면 된다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>worker_processes  auto<span class="p">;</span>

events <span class="o">{</span>
    worker_connections  1024<span class="p">;</span>
<span class="o">}</span>

http <span class="o">{</span>
    include       ./mime.types<span class="p">;</span>

    log_format  main  <span class="s1">'$remote_addr - $remote_user [$time_local] "$request" '</span>
                      <span class="s1">'$status $body_bytes_sent "$http_referer" '</span>
                      <span class="s1">'"$http_user_agent" "$http_x_forwarded_for"'</span><span class="p">;</span>

    access_log  ./logs/access.log  main<span class="p">;</span>

    upstream app <span class="o">{</span>
      server 192.168.1.126:8000<span class="p">;</span>
      server 192.168.1.110:8000<span class="p">;</span>

      check <span class="nv">interval</span><span class="o">=</span>3000 <span class="nv">rise</span><span class="o">=</span>2 <span class="nv">fall</span><span class="o">=</span>5 <span class="nb">timeout</span><span class="o">=</span>4000 <span class="nb">type</span><span class="o">=</span>http<span class="p">;</span>
      check_http_send <span class="s2">"HEAD / HTTP/1.0</span><span class="se">\r\n\r\n</span><span class="s2">"</span><span class="p">;</span>
      check_http_expect_alive http_2xx http_3xx<span class="p">;</span>
    <span class="o">}</span>

    server <span class="o">{</span>
      listen 80<span class="p">;</span>

      location / <span class="o">{</span>
        proxy_pass http://app<span class="p">;</span>
      <span class="o">}</span>

      location /status <span class="o">{</span>
        check_status<span class="p">;</span>

        access_log off<span class="p">;</span>
      <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><br /></p>

<h2 id="로드-밸런싱-및-헬스-체크-설정">로드 밸런싱 및 헬스 체크 설정</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>upstream app <span class="o">{</span>
    server 192.168.1.126:8000<span class="p">;</span>
    server 192.168.1.110:8000<span class="p">;</span>

    check <span class="nv">interval</span><span class="o">=</span>3000 <span class="nv">rise</span><span class="o">=</span>2 <span class="nv">fall</span><span class="o">=</span>5 <span class="nb">timeout</span><span class="o">=</span>4000 <span class="nb">type</span><span class="o">=</span>http<span class="p">;</span>
    check_http_send <span class="s2">"HEAD / HTTP/1.0</span><span class="se">\r\n\r\n</span><span class="s2">"</span><span class="p">;</span>
    check_http_expect_alive http_2xx http_3xx<span class="p">;</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>app이란 이름으로 서버 클러스터 설정.
    <ul>
      <li>두 대의 WAS로 부하 분산</li>
      <li>이외에도 <a href="https://docs.nginx.com/nginx/admin-guide/load-balancer/http-load-balancer/">로드 밸런싱 설정 공식 문서</a>에서 부하 분산 알고리즘등을 설정해줄 수 있다.</li>
    </ul>
  </li>
  <li>헬스 체크
    <ul>
      <li>3초 단위로 체크, 두 번 성공하면 정상, 5번 실패하면 비정상으로 판단한다. (타임 아웃 4초)</li>
      <li>http 프로토콜 사용</li>
      <li>서버에 HEAD 메서드, HTTP 1.0을 사용하여 보냄.</li>
      <li>HTTP 응답 코드가 2xx이거나, 3xx라면 정상 상태로 판단.</li>
    </ul>
  </li>
</ul>

<p><br /></p>

<h1 id="nginx-실행">NginX 실행</h1>
<blockquote>
  <p><a href="https://www.nginx.com/resources/wiki/start/topics/tutorials/commandline/">NginX 실행 공식 문서</a></p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>./sbin/nginx <span class="nt">-t</span>
<span class="nv">$ </span>./sbin/nginx <span class="nt">-c</span> ./conf/nginx.conf
</code></pre></div></div>
<ul>
  <li><code class="language-plaintext highlighter-rouge">-t</code>를 통해 설정 파일을 테스트한다.</li>
  <li><code class="language-plaintext highlighter-rouge">-c</code>를 통해 설정 파일 위치를 지정해주고 실행해주면 끝!</li>
</ul>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">/status?format=json</code>으로 보내면 json형식으로 반환해준다.</p>
</blockquote>

<p><br /></p>

<p align="center"><img src="../assets/img/binghe/21-10-04-nginx-health-check/nginx_health_check_html.png" /> </p>

<p><br /></p>

<h1 id="마치며">마치며</h1>

<p>개인적으론 처음엔 막막했지만.. 그래도 적용시키는 과정에서 리눅스와 NginX에 대해 배울 점이 많아서 좋았습니다!</p>

<p>이제 운영 환경에서 로드 밸런싱에 연결된 WAS들이 잘 운영되고 있는지 한 눈에 확인할 수 있게 되었습니다 :)</p>

<p><br /></p>

<h1 id="참고">참고</h1>
<ul>
  <li>https://github.com/yaoweibin/nginx_upstream_check_module</li>
  <li>https://opentutorials.org/module/384/4511</li>
  <li>https://m.blog.naver.com/sehyunfa/221707853050</li>
</ul>


      <div class="page-footer">
        <div class="page-share">
          <a href="https://twitter.com/intent/tweet?text=NGINX 로드 밸런싱 (무료 헬스체크를 곁들인)&url=https://2021-pick-git.github.io//NGINX-%EB%A1%9C%EB%93%9C-%EB%B0%B8%EB%9F%B0%EC%8B%B1-%EB%AC%B4%EB%A3%8C-%ED%97%AC%EC%8A%A4%EC%B2%B4%ED%81%AC%EB%A5%BC-%EA%B3%81%EB%93%A4%EC%9D%B8/" title="Share on Twitter" rel="nofollow" target="_blank">Twitter</a>
          <a href="https://facebook.com/sharer.php?u=https://2021-pick-git.github.io//NGINX-%EB%A1%9C%EB%93%9C-%EB%B0%B8%EB%9F%B0%EC%8B%B1-%EB%AC%B4%EB%A3%8C-%ED%97%AC%EC%8A%A4%EC%B2%B4%ED%81%AC%EB%A5%BC-%EA%B3%81%EB%93%A4%EC%9D%B8/" title="Share on Facebook" rel="nofollow" target="_blank">Facebook</a>
          <a href="https://plus.google.com/share?url=https://2021-pick-git.github.io//NGINX-%EB%A1%9C%EB%93%9C-%EB%B0%B8%EB%9F%B0%EC%8B%B1-%EB%AC%B4%EB%A3%8C-%ED%97%AC%EC%8A%A4%EC%B2%B4%ED%81%AC%EB%A5%BC-%EA%B3%81%EB%93%A4%EC%9D%B8/" title="Share on Google+" rel="nofollow" target="_blank">Google+</a>
        </div>
        <div class="page-tag">
          
            <a href="/tags#백엔드" class="tag">&#35; 백엔드</a>
          
            <a href="/tags#NginX" class="tag">&#35; NginX</a>
          
            <a href="/tags#HealthCheck" class="tag">&#35; HealthCheck</a>
          
            <a href="/tags#LoadBalancing" class="tag">&#35; LoadBalancing</a>
          
        </div>
      </div>
      <section class="comment-area">
  <div class="comment-wrapper">
    
  </div>
</section> <!-- End Comment Area -->

    </div> <!-- End Wrap Content -->
  </div> <!-- End Page Content -->

  <script src="https://utteranc.es/client.js"
        repo="2021-pick-git/pick-git-comments"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
  </script>
</article> <!-- End Article Page -->

</div>

  </div>
  
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', '', 'auto');
  ga('send', 'pageview');
</script> <!-- End Analytics -->

</body>
</html>
