<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>DB ë¦¬í”Œë¦¬ì¼€ì´ì…˜ ì ìš©ê¸° - BingheCompany ğŸ‡°ğŸ‡·</title>

  <!-- Edit site and author settings in `_config.yml` to make the social details your own -->

    <meta content="BingheCompany ğŸ‡°ğŸ‡·" property="og:site_name">
  
    <meta content="DB ë¦¬í”Œë¦¬ì¼€ì´ì…˜ ì ìš©ê¸°" property="og:title">
  
  
    <meta content="article" property="og:type">
  
  
    <meta content="DB replicationìœ¼ë¡œ DB ì„œë²„ë¥¼ ë‹¤ì¤‘í™”í•œ ê³¼ì •ì„ ê¸°ë¡í•œë‹¤." property="og:description">
  
  
    <meta content="https://2021-pick-git.github.io//db-replication/" property="og:url">
  
  
    <meta content="2021-09-30T19:32:20+09:00" property="article:published_time">
    <meta content="https://2021-pick-git.github.io//about/" property="article:author">
  
  
    <meta content="https://2021-pick-git.github.io//assets/img/database.png" property="og:image">
  
  
    
  
  
    
    <meta content="ë°±ì—”ë“œ" property="article:tag">
    
    <meta content="Database" property="article:tag">
    
  

    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@">
    <meta name="twitter:creator" content="@">
  
    <meta name="twitter:title" content="DB ë¦¬í”Œë¦¬ì¼€ì´ì…˜ ì ìš©ê¸°">
  
  
    <meta name="twitter:url" content="https://2021-pick-git.github.io//db-replication/">
  
  
    <meta name="twitter:description" content="DB replicationìœ¼ë¡œ DB ì„œë²„ë¥¼ ë‹¤ì¤‘í™”í•œ ê³¼ì •ì„ ê¸°ë¡í•œë‹¤.">
  
  
    <meta name="twitter:image:src" content="https://2021-pick-git.github.io//assets/img/database.png">
  

	<meta name="description" content="DB replicationìœ¼ë¡œ DB ì„œë²„ë¥¼ ë‹¤ì¤‘í™”í•œ ê³¼ì •ì„ ê¸°ë¡í•œë‹¤.">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta property="og:image" content="">
	<link rel="shortcut icon" href="/assets/img/favicon/favicon.ico" type="image/x-icon">
	<link rel="apple-touch-icon" href="/assets/img/favicon/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicon/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicon/apple-touch-icon-144x144.png">
	<!-- Chrome, Firefox OS and Opera -->
	<meta name="theme-color" content="#263959">
	<!-- Windows Phone -->
	<meta name="msapplication-navbutton-color" content="#263959">
	<!-- iOS Safari -->
	<meta name="apple-mobile-web-app-status-bar-style" content="#263959">
	<!-- Google Fonts -->
	<link href="https://fonts.googleapis.com/css?family=PT+Serif:400,700|Lato:300,400,700&display=swap" rel="stylesheet">
	<!-- Font Awesome -->
	<link rel="stylesheet" href="/assets/fonts/font-awesome/css/font-awesome.min.css">
	<!-- Styles -->
	<link rel="stylesheet" href="/assets/css/main.css">
</head>

<body>

  <div class="wrapper">
    <aside class="sidebar">
  <header>
    <div class="about">
      <div class="cover-author-image">
        <a href="/"><img src="/assets/img/mark.jpg" alt="ê¹ƒ-ë“¤ë‹¤ (pick-git)"></a>
      </div>
      <div class="author-name">ê¹ƒ-ë“¤ë‹¤ (pick-git)</div>
      <p>ê¹ƒ-ë“¤ë‹¤ ê¸°ìˆ  ë¸”ë¡œê·¸ì…ë‹ˆë‹¤.</br>ğŸ˜‡ğŸ’ª</br> This is a tech blog for pick-git.</br> ãƒ”ã‚¯ã‚®ãƒˆã®æŠ€è¡“ã®blogã§ã™ã€‚</br> è¿™æ˜¯ pick-git ç§‘æŠ€åšå®¢.</br></p>
    </div>
  </header> <!-- End Header -->
  <footer>
    <section class="contact">
      <h3 class="contact-title">Contact me</h3>
      <ul>
        <!-- 
          <li><a href="https://twitter.com/artemsheludko_" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
        
        
          <li><a href="https://facebook.com/" target="_blank"><i class="fa fa-facebook" aria-hidden="true"></i></a></li>
         -->
        
          <li class="github"><a href="http://github.com/woowacourse-teams/2021-pick-git" target="_blank"><i class="fa fa-github"></i></a></li>
        
        <!-- 
          <li class="linkedin"><a href="https://in.linkedin.com/" target="_blank"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li>
        
        
          <li class="email"><a href="mailto:example.david@blog.com"><i class="fa fa-envelope-o" aria-hidden="true"></i></a></li>
         -->
      </ul>
    </section> <!-- End Section Contact -->
    <div class="copyright">
      <p>2021 &copy; ê¹ƒ-ë“¤ë‹¤ (pick-git)</p>
    </div>
  </footer> <!-- End Footer -->
</aside> <!-- End Sidebar -->
<div class="content-box clearfix">
  <article class="article-page">
  <div class="page-content">
    
    <div class="page-cover-image">
      <figure>
        <img class="page-image" src=/assets/img/database.png alt="DB ë¦¬í”Œë¦¬ì¼€ì´ì…˜ ì ìš©ê¸°">
        
      </figure>
    </div> <!-- End Page Cover Image -->
    
    <div class="wrap-content">
      <header class="header-page">
        <h1 class="page-title">DB ë¦¬í”Œë¦¬ì¼€ì´ì…˜ ì ìš©ê¸°</h1>
        <div class="page-date"><span>2021, Sep 30&nbsp;&nbsp;&nbsp;&nbsp;</span></div>
      </header>
      <h2 id="intro">INTRO</h2>
<ul>
  <li>DB Replicationì„ MySQL ê³µì‹ í™ˆí˜ì´ì§€ì—ì„œ ì°¾ì•„ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì´ ë§í•œë‹¤.
    <blockquote>
      <p>Replication enables data from one MySQL databse server (known as a source) to be copied to one or more MySQL database servers (know as replicas) 
ì¶œì²˜ : <a href="https://dev.mysql.com/doc/refman/8.0/en/replication.html">ë§í¬</a></p>
    </blockquote>
  </li>
  <li>ì¦‰, í•˜ë‚˜ì˜ ë°ì´í„°ë² ì´ìŠ¤(master/source)ì—ì„œ ë‹¤ë¥¸ í•˜ë‚˜ ë˜ëŠ” ê·¸ ì´ìƒì˜ ë°ì´í„°ë² ì´ìŠ¤(slaves/replicas)ë¡œ ë°ì´í„°ë¥¼ ë³µì œí•˜ì—¬ ì €ì¥í•˜ëŠ” ê²ƒì´ë‹¤.</li>
  <li>Replicationì€ ë¹„ë™ê¸°ë¡œ ë™ì‘í•œë‹¤. ë”°ë¼ì„œ replicasê°€ masterì— ì§€ì†ì ìœ¼ë¡œ ì—°ê²°ë˜ì–´ëŠ” ë™ê¸°ì‹ìœ¼ë¡œ ë™ì‘í•˜ì§€ ì•ŠëŠ”ë‹¤.</li>
  <li>ì„¤ì •ì— ë”°ë¼ì„œ ì—¬ëŸ¬ ë°ì´í„°ë² ì´ìŠ¤, ì„ íƒëœ ë°ì´í„°ë² ì´ìŠ¤, ì„ íƒëœ í…Œì´ë¸”ì—ë§Œ replicationì„ ì ìš©í•  ìˆ˜ë„ ìˆë‹¤.</li>
</ul>

<p><br />
<br /></p>

<h2 id="mysql-replication-ì¥ì ">MySQL replication ì¥ì </h2>
<p>ê³µì‹ í™ˆí˜ì´ì§€ì— ë‚˜ì™€ìˆëŠ” ì¥ì  4ê°€ì§€ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.</p>
<ol>
  <li>Scale-out solutions
    <ul>
      <li>ë‹¤ìˆ˜ì˜ replicasë¥¼ ë‘ê³  loadë¥¼ ë¶„ì‚°í•´ì„œ í¼í¬ë¨¼ìŠ¤ë¥¼ ë†’ì´ëŠ” ì¥ì ì´ ìˆë‹¤.</li>
      <li>ëŒ€ë¶€ë¶„ì˜ replication ì ìš©ì´ìœ ì´ê¸°ë„ í•˜ë‹¤.</li>
      <li>ì“°ê¸° ë° ì—…ë°ì´íŠ¸ëŠ” master ì„œë²„ì—ì„œ ì´ë£¨ì–´ì§„ë‹¤.</li>
      <li>ì¡°íšŒëŠ” í•˜ë‚˜ ë˜ëŠ” ì—¬ëŸ¬ slave ì„œë²„ì— ë¶„ì‚°ë˜ì„œ ì²˜ë¦¬ëœë‹¤.</li>
    </ul>
  </li>
  <li>Data security
    <ul>
      <li>master ì„œë²„ì™€ slave ì„œë²„ê°€ ë¶„ë¦¬ë˜ì–´ ìˆìœ¼ë¯€ë¡œ í•˜ë‚˜ì˜ slave ì„œë²„ì— ë¬¸ì œê°€ ìƒê²¨ë„ ë‹¤ë¥¸ slave ì„œë²„ì— ì˜í–¥ì„ ë¯¸ì¹˜ì§€ ì•Šê³  ë°ì´í„°ë¥¼ ë³´ì¡´í•  ìˆ˜ ìˆë‹¤.</li>
      <li>í•˜ì§€ë§Œ Master serverì— ì¥ì• ê°€ ìƒê¸°ë©´ ë¬¸ì œê°€ ìƒê¸´ë‹¤.</li>
    </ul>
  </li>
  <li>Analytics
    <ul>
      <li>ì‹¤ì‹œê°„ ë°ì´í„° ìƒì„± ë° ì—…ë°ì´í„°ê°€ master ì„œë²„ì—ì„œ ì´ë£¨ì–´ì§€ëŠ” ë™ì•ˆ ë°ì´í„° ë¶„ì„ì²˜ë¦¬ëŠ” slave ì„œë²„ì—ì„œ ì²˜ë¦¬í•˜ì—¬ master ì„œë²„ì— ì„±ëŠ¥ì €í•˜ë¥¼ ì „í˜€ ì¼ìœ¼í‚¤ì§€ ì•Šë„ë¡ ì§€ì›í•œë‹¤.</li>
    </ul>
  </li>
  <li>Long-distance data distribution
    <ul>
      <li>ë¦¬ëª¨íŠ¸ì— í•„ìš”í•œ ë°ì´í„°ë¥¼ ìœ„í•œ local ë°ì´í„° ë³µì œë¥¼ masterì— ì ‘ì´‰í•˜ì§€ ì•Šê³  slave ì„œë²„ì—ì„œ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤.</li>
    </ul>
  </li>
</ol>

<p>ë” ë§ì€ ì •ë³´ë¥¼ ìœ„í•´ì„œëŠ” ë‹¤ìŒ <a href="https://dev.mysql.com/doc/refman/8.0/en/replication.html">ë§í¬</a>ë¥¼ ì°¸ê³ í•œë‹¤.</p>

<p><br />
<br /></p>

<h2 id="replication-ì ìš©í•˜ê¸°">Replication ì ìš©í•˜ê¸°</h2>

<h3 id="ì ìš©ì´ìœ ">ì ìš©ì´ìœ </h3>
<ul>
  <li>í˜„ì¬ ì§„í–‰ì¤‘ì¸ <a href="pick-git.com">í”„ë¡œì íŠ¸</a>ì— DB replicationì„ ì ìš©í•˜ê¸°ë¡œ í–ˆë‹¤. ê·¸ ì´ìœ ëŠ” í”„ë¡œì íŠ¸ê°€ SNSì˜ ì¼ì¢…ì´ë¯€ë¡œ ìœ ì €ì— ì˜í•œ í˜ì´ì§€ ì´ë™ì´ ì¦ê³  ê·¸ê²ƒì— ë”°ë¥¸ ì¡°íšŒ ì¿¼ë¦¬ê°€ ë§¤ìš° ë§ê¸° ë•Œë¬¸ì´ë‹¤. ë”°ë¼ì„œ Master server 1ê°œ, slave server 2ê°œë¥¼ ë‘ì–´ ì¡°íšŒ ì¿¼ë¦¬ë¥¼ slave ì„œë²„ 2ê°œë¡œ ë¶„ì‚°í–ˆë‹¤.</li>
</ul>

<h3 id="ì°¸ê³ ì‚¬í•­">ì°¸ê³ ì‚¬í•­</h3>
<ul>
  <li>í˜„ì¬ ë³¸ í”„ë¡œì íŠ¸ì˜ WASê°€ AWS EC2 ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ì‹¤í–‰ ì¤‘ì´ë©° ì´ë²ˆì— DB Replicationì„ ì ìš©í•˜ë©´ì„œ DB ì„œë²„ë¥¼ ë¶„ë¦¬í–ˆë‹¤.</li>
  <li>AWS EC2 ì¸ìŠ¤í„´ìŠ¤ 3ê°œë¥¼ ì¶”ê°€ë¡œ ìƒì„±í•´ì„œ MySQL master ì„œë²„ 1ê°œ + slave ì„œë²„ 2ê°œë¥¼ êµ¬ì„±í–ˆë‹¤.</li>
  <li>ì“°ê¸° ë° ì—…ë°ì´íŠ¸ ì‘ì—…ì€ master, ì¡°íšŒëŠ” 2ê°œì˜ slave ì„œë²„ë¥¼ RR(Round Robin) ë°©ì‹ìœ¼ë¡œ ë¶„ì‚°ì²˜ë¦¬í•˜ë„ë¡ êµ¬ì„±í–ˆë‹¤. DBëŠ” MariaDBë¥¼ ì‚¬ìš©í•œë‹¤.</li>
  <li>ì¡°íšŒ ì‘ì—…ì€ Transactionì˜ read-only ì†ì„±ì„ í†µí•´ í™•ì¸í•˜ê³  slave dbë¥¼ ì—°ê²°í–ˆë‹¤.</li>
</ul>

<p><br /></p>

<h3 id="ì ìš©í•˜ê¸°">ì ìš©í•˜ê¸°</h3>
<p>DB replication ì ìš©ì—ëŠ” í¬ê²Œ 3ê°€ì§€ ë‹¨ê³„ê°€ ìˆë‹¤. ë‹¤ìŒ <a href="https://github.com/2021-pick-git/db-replication-learning-test">ë ˆí¬ì§€í† ë¦¬</a>ì— ê°€ë©´ ì ìš©ì„ ìœ„í•œ replication í•™ìŠµí…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</p>

<ol>
  <li>Remote ì„œë²„ì— MariaDB ë¡œì»¬ ì„¤ì¹˜ ë° ê¸°ë³¸ ì„¤ì •</li>
  <li>Master ì„œë²„ì™€ Slave ì„œë²„ replication ì—°ê²° ì„¤ì •</li>
  <li>í”„ë¡œë•ì…˜ ì½”ë“œì— DB ìˆ˜ë™ ì—°ê²° ë° (ì—¬ëŸ¬ slave ì„œë²„ë¥¼ ë‘ê³  ìˆë‹¤ë©´) slave DB ì„ íƒ ë¡œì§ êµ¬í˜„</li>
</ol>

<p><br /></p>

<h4 id="1-1-mariadb-ì„¤ì¹˜-ë°-ê¸°ë³¸-ì„¤ì •">1-1) MariaDB ì„¤ì¹˜ ë° ê¸°ë³¸ ì„¤ì •</h4>
<ul>
  <li>ìš°ë¶„íˆ¬ì— MariaDBë¥¼ ì„¤ì¹˜í•œë‹¤.
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>apt update
<span class="nv">$ </span><span class="nb">sudo </span>apt <span class="nb">install </span>mariadb-server
</code></pre></div>    </div>
  </li>
  <li>
    <p>í˜„ì¬ í”„ë¡œì íŠ¸ë¥¼ ìœ„í•´ì„œ ì œê³µë°›ì€ AWS ê¶Œí•œì€ ë§ì´ ë‹«í˜€ìˆìœ¼ë¯€ë¡œ ì‚¬ìš© ê°€ëŠ¥í•œ í¬íŠ¸(9000)ìœ¼ë¡œ ë°”ê¾¸ì–´ì£¼ì—ˆë‹¤. <a href="https://bskyvision.com/1049">í¬íŠ¸ë³€ê²½ë°©ë²•</a></p>
  </li>
  <li>í”„ë¡œì íŠ¸ì— ì‚¬ìš©í•  databaseë¥¼ ìƒì„±í•œë‹¤.
    <ul>
      <li>í˜„ì¬ ìš°ë¦¬ í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš©í•˜ëŠ” databaseëŠ” <code class="language-plaintext highlighter-rouge">pickgit</code>ì´ë‹¤.</li>
    </ul>
  </li>
  <li>ê° DB ì„œë²„ì— ê³„ì •ì„ ìƒì„±í•œë‹¤.
    <pre><code class="language-mysql">create user 'replication'@'%' identified by 'password';
</code></pre>
    <ul>
      <li>ê³„ì • ì´ë¦„ ë’¤ì— %ë¡œ ì§€ì •í•´ì•¼ ì „ì²´ì—ì„œ ì ‘ì†ì´ í—ˆìš©ëœë‹¤.</li>
    </ul>
  </li>
</ul>

<p><br /></p>

<h4 id="2-1-master-db-ì„¤ì •">2-1) Master DB ì„¤ì •</h4>
<ul>
  <li>í•´ë‹¹ ê³„ì •ì— ê¶Œí•œì„ ë¶€ì—¬í•œë‹¤. (master)
    <pre><code class="language-mysql">$ grant all privileges on {database}.* to 'replication'@'%'; 

$ flush privileges;
</code></pre>
  </li>
  <li>ìœ„ì™€ ê°™ì´ í•˜ë©´ í•´ë‹¹ ê³„ì •ì— ëŒ€í•œ ì „ì²´ ê¶Œí•œì´ ì—´ë¦°ë‹¤. ë¶ˆì•ˆí•˜ë‹¤ë©´ ë‹¤ìŒê³¼ ê°™ì´ replicationì— ëŒ€í•œ ê¶Œí•œë§Œ ì„¤ì •í•´ë„ ëœë‹¤.
    <pre><code class="language-mysql">  $ grant replication slave on *.* to 'replication'@'%'; 

  $ flush privileges;
</code></pre>
    <ul>
      <li>ì°¸ê³ ë¡œ replication slave ê¶Œí•œì„ ì¤„ ë•ŒëŠ” <code class="language-plaintext highlighter-rouge">*.*</code>ë¡œ ì£¼ì§€ ì•Šìœ¼ë©´ db grant ë° global privileges ê²½ê³ ê°€ ëœ¬ë‹¤.</li>
    </ul>
  </li>
  <li>ì„¤ì •ê³¼ì •
    <p align="center"><img width="600" alt="masterDb" src="https://user-images.githubusercontent.com/63405904/132974481-47521392-72e8-4596-9c08-0481b572717a.png" /></p>
  </li>
  <li>ë‹¤ìŒ ê²½ë¡œì˜ ì„¤ì •íŒŒì¼ì„ ì—´ì–´ ìˆ˜ì •í•œë‹¤. master db ì„œë²„ì˜ ì„œë²„ idë¥¼ ì„¤ì •í•˜ëŠ” ê³¼ì •ì´ë‹¤.
    <ul>
      <li>ì„¤ì •íŒŒì¼ ê²½ë¡œ</li>
    </ul>
    <p align="center"><img width="600" src="https://user-images.githubusercontent.com/63405904/132974223-9df3b0cb-68fc-451f-bcb5-703980a36a79.png" /></p>

    <ul>
      <li>ì„¤ì • ìˆ˜ì •</li>
    </ul>
    <p align="center"><img width="600" alt="masterDb" src="https://user-images.githubusercontent.com/63405904/132974298-64ba1690-5e69-441d-ba8e-b7ccc8887c43.png" /></p>
  </li>
  <li>ëª¨ë“  ì„¤ì •ì´ ëë‚œ ë’¤ì— mysqlë¥¼ ì¬ì‹¤í–‰í•˜ì—¬ ì„¤ì •ì„ ì ìš©í•œë‹¤.
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">$ </span><span class="nb">sudo </span>service mysqld restart
</code></pre></div>    </div>
  </li>
  <li>Master DB ì •ë³´ë¥¼ ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ í™•ì¸í•œë‹¤.
    <ul>
      <li>File ê°’ê³¼ position ê°’ìœ¼ë¡œ slave dbì— master dbì— ëŒ€í•œ ì •ë³´ë¥¼ ì„¤ì •í•´ì•¼ í•œë‹¤.
        <pre><code class="language-mysql">  $ show master status;
</code></pre>
      </li>
    </ul>

    <p align="center"><img width="600" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2021-09-05 á„‹á…©á„’á…® 4 25 23" src="https://user-images.githubusercontent.com/63405904/132974579-e455d052-e082-40f3-b68d-858692cbbb79.png" /></p>

    <ul>
      <li>
        <p>ìœ„ ë‘ ì •ë³´ê°€ ì˜ë¯¸í•˜ëŠ” ê²ƒì´ ë¬´ì—‡ì¸ì§€ í™•ì¸í•˜ê³  ì‹¶ë‹¤ë©´ ë‹¤ìŒ <a href="https://dev.mysql.com/doc/refman/5.7/en/replication-howto-masterstatus.html">ë§í¬</a>ë¥¼ ì°¸ê³ í•˜ì.</p>

        <blockquote>
          <p>The File column shows the name of the log file and the Position column shows the position within the file. In this example, the binary log file is mysql-bin.000003 and the position is 73. Record these values. You need them later when you are setting up the replica. They represent the replication coordinates at which the replica should begin processing new updates from the source.</p>
          <ul>
            <li>ê°„ë‹¨íˆ ë§í•˜ë©´ replicaê°€ master dbì˜ ë°ì´í„°ë¥¼ ì½ì„ binary íŒŒì¼ê³¼ ì½ê¸° ì‹œì‘í•  ìœ„ì¹˜ì¸ positionì— ëŒ€í•œ ì •ë³´ì´ë‹¤.</li>
          </ul>
        </blockquote>
      </li>
    </ul>
  </li>
</ul>

<p><br /></p>

<h4 id="2-2-slave-db-ì„¤ì •">2-2) Slave DB ì„¤ì •</h4>
<ul>
  <li>Master DB ê³¼ ë™ì¼í•˜ê²Œ ë‹¤ìŒ ì„¤ì •ê²½ë¡œë¡œ ê°€ì„œ <code class="language-plaintext highlighter-rouge">server-id</code>ë¥¼ ìˆ˜ì •í•œë‹¤.
    <ul>
      <li>í˜„ì¬ masterì˜ <code class="language-plaintext highlighter-rouge">server-id</code>ê°€ 1ì´ë¯€ë¡œ <code class="language-plaintext highlighter-rouge">slave1</code>ì€ 2, <code class="language-plaintext highlighter-rouge">slave2</code>ëŠ” 3ìœ¼ë¡œ ì„¤ì •í•´ì£¼ì—ˆë‹¤.
        <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">$ </span><span class="nb">sudo </span>vi /etc/mysql/mysql.conf.d/mysqld.cnf
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>Slave Dbì—ì„œ ì´ì „ì— ê¸°ë¡í•´ë‘” Master DBì˜ ì •ë³´ë¥¼ ì…ë ¥í•´ ë‘ DBë¥¼ ì—°ê²°í•œë‹¤.
    <pre><code class="language-mysql">mysql&gt; change master to master_host={master_db_ip}, master_port={master_db_port}, master_user={master_username}, master_password={master_password}, master_log_file={master_bin_file}, master_log_pos={position};
</code></pre>
  </li>
  <li>Slave DBë¥¼ ì‹¤í–‰ì‹œí‚¨ë‹¤.
    <pre><code class="language-mysql">mysql&gt; start slave;
</code></pre>
  </li>
  <li>
    <p>ì‹¤í–‰ ì‹œí‚¤ê³  ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì¹˜ë©´ slave dbì˜ ìƒíƒœì™€ masterì™€ì˜ ì—°ê²°ìƒíƒœ ì—¬ë¶€ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</p>

    <p align="center"><img width="600" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2021-09-05 á„‹á…©á„’á…® 4 25 23" src="https://user-images.githubusercontent.com/63405904/132976950-0bb84655-da17-4b4b-8d44-c03626b46e51.png" /></p>
  </li>
  <li>ì´ì œ master dbì— ë°ì´í„°ë¥¼ ì¶”ê°€í•˜ë©´ slave dbì—ë„ ì ìš©ì´ ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</li>
</ul>

<p><br /></p>

<h4 id="3-1-springboot-db-configuration-ì„¤ì •---datasource-ì •ë³´-ê¸°ì…">3-1) Springboot DB configuration ì„¤ì • - datasource ì •ë³´ ê¸°ì…</h4>
<ul>
  <li>DB ì„œë²„ì—ì„œ í•˜ëŠ” ì„¤ì •ì€ Master DBì— ì“°ê¸° ë° ì—…ë°ì´íŠ¸ ì²˜ë¦¬ì‹œ Slave DBì— ì ìš©ì´ ë˜ë„ë¡ í•˜ëŠ” ì—°ê²° ì„¤ì •ì´ë‹¤.</li>
  <li>ì´ì™¸ì˜ datasourceë¥¼ ì„ íƒí•˜ê³ , ì„¤ì •ì— ë§ê²Œ connectionì„ ë§Œë“¤ê³ , ì‹¤ì œ ì¿¼ë¦¬ë¥¼ ì²˜ë¦¬í•˜ë„ë¡ í•˜ëŠ” ê²ƒì€ ì–´í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œì—ì„œ êµ¬í˜„ì„ í•´ì•¼í•œë‹¤.
    <p align="center"><img width="600" src="https://user-images.githubusercontent.com/63405904/132996798-4b1a4c22-484c-415b-acdb-d599cdb0fcc2.png" /><br />ì´ì „ yml datasource ì„¤ì •</p>
    <p><br /></p>
  </li>
  <li>ë‹¤ìŒê³¼ ê°™ì´ datasource ì •ë³´ë¥¼ <code class="language-plaintext highlighter-rouge">yml</code> í˜¹ì€ <code class="language-plaintext highlighter-rouge">properties</code>ì— ê¸°ë¡í•œë‹¤.
    <p align="center"><img width="600" src="https://user-images.githubusercontent.com/63405904/132996912-59fcf5f4-2cd9-40c7-89e0-9a142c5d20f8.png" /><br />datasource ì •ë³´</p>
  </li>
</ul>

<p><br /></p>

<ul>
  <li>ìœ„ <code class="language-plaintext highlighter-rouge">ymlì—</code> ê¸°ì…í•œ <code class="language-plaintext highlighter-rouge">datasource</code> ì •ë³´ë¥¼ í™œìš©í•˜ê¸° ìœ„í•´ì„œ ë‹¤ìŒê³¼ ê°™ì€ ê°ì²´ë¥¼ ë§Œë“¤ì–´ <code class="language-plaintext highlighter-rouge">yml</code> ì •ë³´ë¥¼ ë°”ì¸ë”© í•œë‹¤.
    <ul>
      <li>ìœ ì˜í•  ì ì€ ë‚´ë¶€ì— ì„ ì–¸ëœ ì •ë³´ë¥¼ ìœ„í•´ì„œëŠ” <code class="language-plaintext highlighter-rouge">static inner class</code>ë¥¼ ì¹¼ëŸ¼ê³¼ ë™ì¼í•œ ì´ë¦„ìœ¼ë¡œ ìƒì„±í•´ì•¼ í•œë‹¤. ê·¸ëŸ¬ë©´ class ë‚´ë¶€ì˜ ìë£Œêµ¬ì¡°ë¡œ ì •ë³´ê°€ ë“¤ì–´ê°„ë‹¤.</li>
      <li><code class="language-plaintext highlighter-rouge">getter</code> ë° <code class="language-plaintext highlighter-rouge">setter</code>ê°€ í•„ìˆ˜ì ìœ¼ë¡œ ìˆì–´ì•¼í•œë‹¤.
        <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@ConfigurationProperties</span><span class="o">(</span><span class="n">prefix</span> <span class="o">=</span> <span class="s">"datasource"</span><span class="o">)</span> <span class="c1">//ì´ annotationì„ í™œìš©í•´ì„œ yml ì •ë³´ë¥¼ ë§¤í•‘í•œë‹¤.</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MasterDataSourceProperties</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Slave</span><span class="o">&gt;</span> <span class="n">slave</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">url</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">username</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">password</span><span class="o">;</span>

    <span class="c1">//getter ë° setter </span>
    <span class="c1">//slave mapì— ëŒ€í•œ setterëŠ” ë¶ˆí•„ìš”í•˜ë‹¤.</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Slave</span> <span class="o">{</span> <span class="c1">//ì¤‘ì²© ë°ì´í„° ëª…ê³¼ ì¼ì¹˜í•´ì•¼í•œë‹¤. ì¦‰, datasource.slaveì˜ ë‘ë²ˆì§¸ ìš”ì†Œì™€ ë™ì¼í•œ ì´ë¦„ìœ¼ë¡œ static classë¥¼ ë§Œë“¤ì–´ì•¼í•œë‹¤.</span>

        <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
        <span class="kd">private</span> <span class="nc">String</span> <span class="n">url</span><span class="o">;</span>
        <span class="kd">private</span> <span class="nc">String</span> <span class="n">username</span><span class="o">;</span>
        <span class="kd">private</span> <span class="nc">String</span> <span class="n">password</span><span class="o">;</span>

        <span class="c1">//getter ë° setter ìƒëµ </span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>        </div>
        <p><br /></p>
      </li>
    </ul>
  </li>
</ul>

<h4 id="3-2-springboot-db-configuration-êµ¬í˜„">3-2) Springboot DB configuration êµ¬í˜„</h4>
<ul>
  <li>
    <p>ìœ„ ì…ë ¥í•œ datasourceëŠ” í•˜ë‚˜ê°€ ì•„ë‹ˆê¸° ë•Œë¬¸ì— ìë™ìœ¼ë¡œ ì—°ê²°ì´ ì•ˆë˜ê³  ìƒí™©ì— ë”°ë¼ ë‹¤ë¥¸ datasourceê°€ ì—°ê²°ì´ ëœë‹¤. í•´ë‹¹ ì‘ì—…ì„ ìˆ˜ë™ìœ¼ë¡œ í•´ì•¼í•˜ê¸° ë•Œë¬¸ì— ëª‡ê°€ì§€ ì§ì ‘ ì„¤ì •í•´ì•¼í•˜ëŠ” ê²ƒë“¤ì´ ìˆë‹¤.</p>
  </li>
  <li>
    <p>1) ì²«ë²ˆì§¸ëŠ” ì í•©í•œ ìƒí™©ì— ë‹¤ë¥¸ datasourceë¥¼ ì œê³µí•˜ëŠ” ì„¤ì •ì´ë‹¤. í•˜ë‚˜ ì´ìƒì˜ datasourceë¥¼ ìƒì„±í•´ ì €ì¥í•œë‹¤.</p>
  </li>
  <li>2) ë‘ë²ˆì§¸ëŠ” Jpaì— ëŒ€í•œ entityManagerFactory <code class="language-plaintext highlighter-rouge">@bean</code> ì„¤ì •ì´ë‹¤. ë³¸ë˜ datasourceê°€ ìë™ì—°ê²°ë˜ë©´ì„œ JPAì— ëŒ€í•œ ì„¤ì •ë„ ë˜ì§€ë§Œ ì—¬ê¸°ì„œëŠ” ìˆ˜ë™ìœ¼ë¡œ í•´ì•¼í•œë‹¤.
    <ul>
      <li>ì´ë•Œ datasourceê°€ ë§¤ë²ˆ ë°”ë€Œë¯€ë¡œ entityManagerFactory ìƒì„±ì‹œ <code class="language-plaintext highlighter-rouge">LazyConnectionDataSourceProxy</code> ë¡œ í”„ë¡ì‹œ datasourceë¥¼ ì—°ê²°í•´ì¤€ë‹¤.</li>
    </ul>
  </li>
  <li>
    <p>3) ì„¸ë²ˆì¬ëŠ” TransactionManagerì— ëŒ€í•œ ì„¤ì •ì´ë‹¤. ì´ ë˜í•œ ìˆ˜ë™ìœ¼ë¡œ datasourceë¥¼ ê´€ë¦¬í•˜ë ¤ê³  í•˜ë‹ˆ ì¶”ê°€í•´ì•¼í•˜ëŠ” ë¶€ë¶„ì´ë‹¤.</p>
  </li>
  <li>4) ê¸°ì¡´ì— ìë™ìœ¼ë¡œ Datasourceë¥¼ ì—°ê²°í•˜ë˜ ì„¤ì •ì„ í•´ì œí•˜ê³ , ìˆ˜ë™ìœ¼ë¡œ ì—°ê²°í•  datasourceì˜ propertiesë¥¼ ì§€ì •í•´ì£¼ì–´ì•¼ í•œë‹¤. (class ìƒë‹¨ì— annotationìœ¼ë¡œ ì„¤ì •)</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@EnableAutoConfiguration</span><span class="o">(</span><span class="n">exclude</span> <span class="o">=</span> <span class="nc">DataSourceAutoConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="c1">//4)</span>
<span class="nd">@EnableConfigurationProperties</span><span class="o">(</span><span class="nc">MasterDataSourceProperties</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="c1">//4)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DataSourceConfiguration</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">MasterDataSourceProperties</span> <span class="n">dataSourceProperties</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">JpaProperties</span> <span class="n">jpaProperties</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">DataSourceConfiguration</span><span class="o">(</span>
        <span class="nc">MasterDataSourceProperties</span> <span class="n">dataSourceProperties</span><span class="o">,</span>
        <span class="nc">JpaProperties</span> <span class="n">jpaProperties</span>
    <span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">dataSourceProperties</span> <span class="o">=</span> <span class="n">dataSourceProperties</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">jpaProperties</span> <span class="o">=</span> <span class="n">jpaProperties</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span> <span class="c1">//1)ë²ˆ ë¶€ë¶„</span>
    <span class="kd">public</span> <span class="nc">DataSource</span> <span class="nf">routingDataSource</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">DataSource</span> <span class="n">master</span> <span class="o">=</span> <span class="n">createDataSource</span><span class="o">(</span>
            <span class="n">dataSourceProperties</span><span class="o">.</span><span class="na">getUrl</span><span class="o">(),</span>
            <span class="n">dataSourceProperties</span><span class="o">.</span><span class="na">getUsername</span><span class="o">(),</span>
            <span class="n">dataSourceProperties</span><span class="o">.</span><span class="na">getPassword</span><span class="o">()</span>
        <span class="o">);</span>

        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">dataSources</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">dataSources</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"master"</span><span class="o">,</span> <span class="n">master</span><span class="o">);</span>
        <span class="n">dataSourceProperties</span><span class="o">.</span><span class="na">getSlave</span><span class="o">().</span><span class="na">forEach</span><span class="o">((</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">)</span> <span class="o">-&gt;</span>
            <span class="n">dataSources</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">value</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">createDataSource</span><span class="o">(</span>
                <span class="n">value</span><span class="o">.</span><span class="na">getUrl</span><span class="o">(),</span> <span class="n">value</span><span class="o">.</span><span class="na">getUsername</span><span class="o">(),</span> <span class="n">value</span><span class="o">.</span><span class="na">getPassword</span><span class="o">()</span>
            <span class="o">))</span>
        <span class="o">);</span>

        <span class="nc">ReplicationRoutingDataSource</span> <span class="n">replicationRoutingDataSource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReplicationRoutingDataSource</span><span class="o">();</span>
        <span class="n">replicationRoutingDataSource</span><span class="o">.</span><span class="na">setDefaultTargetDataSource</span><span class="o">(</span><span class="n">dataSources</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"master"</span><span class="o">));</span>
        <span class="n">replicationRoutingDataSource</span><span class="o">.</span><span class="na">setTargetDataSources</span><span class="o">(</span><span class="n">dataSources</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">replicationRoutingDataSource</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">DataSource</span> <span class="nf">createDataSource</span><span class="o">(</span><span class="nc">String</span> <span class="n">url</span><span class="o">,</span> <span class="nc">String</span> <span class="n">username</span><span class="o">,</span> <span class="nc">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">DataSourceBuilder</span><span class="o">.</span><span class="na">create</span><span class="o">()</span>
            <span class="o">.</span><span class="na">type</span><span class="o">(</span><span class="nc">HikariDataSource</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">url</span><span class="o">(</span><span class="n">url</span><span class="o">)</span>
            <span class="o">.</span><span class="na">driverClassName</span><span class="o">(</span><span class="s">"org.mariadb.jdbc.Driver"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">username</span><span class="o">(</span><span class="n">username</span><span class="o">)</span>
            <span class="o">.</span><span class="na">password</span><span class="o">(</span><span class="n">password</span><span class="o">)</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span> <span class="c1">//2)ë²ˆ ë¶€ë¶„</span>
    <span class="kd">public</span> <span class="nc">LocalContainerEntityManagerFactoryBean</span> <span class="nf">entityManagerFactory</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">EntityManagerFactoryBuilder</span> <span class="n">entityManagerFactoryBuilder</span> <span class="o">=</span>
            <span class="n">createEntityManagerFactoryBuilder</span><span class="o">(</span><span class="n">jpaProperties</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">entityManagerFactoryBuilder</span><span class="o">.</span><span class="na">dataSource</span><span class="o">(</span><span class="n">dataSource</span><span class="o">())</span>
            <span class="o">.</span><span class="na">packages</span><span class="o">(</span><span class="s">"com.pickgit.dbreplicationlearningtest"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">EntityManagerFactoryBuilder</span> <span class="nf">createEntityManagerFactoryBuilder</span><span class="o">(</span>
        <span class="nc">JpaProperties</span> <span class="n">jpaProperties</span>
    <span class="o">)</span> <span class="o">{</span>
        <span class="nc">HibernateJpaVendorAdapter</span> <span class="n">vendorAdapter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HibernateJpaVendorAdapter</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">EntityManagerFactoryBuilder</span><span class="o">(</span><span class="n">vendorAdapter</span><span class="o">,</span> <span class="n">jpaProperties</span><span class="o">.</span><span class="na">getProperties</span><span class="o">(),</span> <span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">DataSource</span> <span class="nf">dataSource</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">LazyConnectionDataSourceProxy</span><span class="o">(</span><span class="n">routingDataSource</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span> <span class="c1">//3)ë²ˆ ë¶€ë¶„</span>
    <span class="kd">public</span> <span class="nc">PlatformTransactionManager</span> <span class="nf">transactionManager</span><span class="o">(</span>
        <span class="nc">EntityManagerFactory</span> <span class="n">entityManagerFactory</span>
    <span class="o">)</span> <span class="o">{</span>
        <span class="nc">JpaTransactionManager</span> <span class="n">jpaTransactionManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JpaTransactionManager</span><span class="o">();</span>
        <span class="n">jpaTransactionManager</span><span class="o">.</span><span class="na">setEntityManagerFactory</span><span class="o">(</span><span class="n">entityManagerFactory</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">jpaTransactionManager</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p><br /></p>

<h3 id="3-3-ì¡°íšŒ-ì¿¼ë¦¬ì‹œ-datasourceë¥¼-rrìœ¼ë¡œ-ì„ íƒí•˜ëŠ”-ë¡œì§">3-3) ì¡°íšŒ ì¿¼ë¦¬ì‹œ datasourceë¥¼ RRìœ¼ë¡œ ì„ íƒí•˜ëŠ” ë¡œì§</h3>
<ul>
  <li>í˜„ì¬ ì—°ê²°ê°€ëŠ¥í•œ datasourcesë“¤ì„ ìˆœíšŒí•˜ë©´ì„œ ì“°ê¸° ë° ì—…ë°ì´íŠ¸ë©´ master, ì¡°íšŒì‹œì—ëŠ” slaveë¥¼ ë²ˆê°ˆì•„ ì„ íƒí•˜ëŠ” ë¡œì§ì„ êµ¬í˜„í•œë‹¤.
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReplicationRoutingDataSource</span> <span class="kd">extends</span> <span class="nc">AbstractRoutingDataSource</span> <span class="o">{</span>

      <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="no">LOGGER</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">ReplicationRoutingDataSource</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

      <span class="kd">private</span> <span class="nc">SlaveNames</span> <span class="n">slaveNames</span><span class="o">;</span>

      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTargetDataSources</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">targetDataSources</span><span class="o">)</span> <span class="o">{</span>
          <span class="kd">super</span><span class="o">.</span><span class="na">setTargetDataSources</span><span class="o">(</span><span class="n">targetDataSources</span><span class="o">);</span>

          <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">replicas</span> <span class="o">=</span> <span class="n">targetDataSources</span><span class="o">.</span><span class="na">keySet</span><span class="o">().</span><span class="na">stream</span><span class="o">()</span>
              <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">Object:</span><span class="o">:</span><span class="n">toString</span><span class="o">)</span>
              <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">string</span> <span class="o">-&gt;</span> <span class="n">string</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">"slave"</span><span class="o">))</span>
              <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">toList</span><span class="o">());</span>

          <span class="k">this</span><span class="o">.</span><span class="na">slaveNames</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SlaveNames</span><span class="o">(</span><span class="n">replicas</span><span class="o">);</span>
      <span class="o">}</span>  

      <span class="nd">@Override</span>
      <span class="kd">protected</span> <span class="nc">String</span> <span class="nf">determineCurrentLookupKey</span><span class="o">()</span> <span class="o">{</span>
          <span class="kt">boolean</span> <span class="n">isReadOnly</span> <span class="o">=</span> <span class="nc">TransactionSynchronizationManager</span><span class="o">.</span><span class="na">isCurrentTransactionReadOnly</span><span class="o">();</span> <span class="c1">//ì¡°íšŒ ì¿¼ë¦¬ì¸ ê²½ìš° </span>
          <span class="k">if</span> <span class="o">(</span><span class="n">isReadOnly</span><span class="o">)</span> <span class="o">{</span>
              <span class="nc">String</span> <span class="n">slaveName</span> <span class="o">=</span> <span class="n">slaveNames</span><span class="o">.</span><span class="na">getNextName</span><span class="o">();</span> <span class="c1">//ë‹¤ìŒ slave ì„ íƒ </span>

              <span class="no">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Slave DB name: {}"</span><span class="o">,</span> <span class="n">slaveName</span><span class="o">);</span>

              <span class="k">return</span> <span class="n">slaveName</span><span class="o">;</span>
          <span class="o">}</span>

          <span class="k">return</span> <span class="s">"master"</span><span class="o">;</span>
      <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">SlaveNames</span> <span class="o">{</span>

      <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">value</span><span class="o">;</span>
      <span class="kd">private</span> <span class="kt">int</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

      <span class="kd">public</span> <span class="nf">SlaveNames</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">slaveDataSourceProperties</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">this</span><span class="o">(</span><span class="n">slaveDataSourceProperties</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="nc">String</span><span class="o">[]::</span><span class="k">new</span><span class="o">));</span>
      <span class="o">}</span>

      <span class="kd">public</span> <span class="nf">SlaveNames</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getNextName</span><span class="o">()</span> <span class="o">{</span>
          <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">counter</span><span class="o">;</span>
          <span class="n">counter</span> <span class="o">=</span> <span class="o">(</span><span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">%</span> <span class="n">value</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
          <span class="k">return</span> <span class="n">value</span><span class="o">[</span><span class="n">index</span><span class="o">];</span>
      <span class="o">}</span>
  <span class="o">}</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><br />
<br /></p>

<h2 id="replication-test-í•˜ê¸°">Replication Test í•˜ê¸°</h2>
<ul>
  <li>Memberë¥¼ ì…ë ¥í•˜ê³  ì¡°íšŒë¥¼ ì—¬ëŸ¬ë²ˆ í–ˆì„ ë•Œ ì˜ë„ëœ ëŒ€ë¡œ replicationì´ ì ìš©ë˜ëŠ”ì§€ í™•ì¸í•œë‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">@DataJpaTest</code>ë¡œë„ ì§„í–‰í•  ìˆ˜ ìˆìœ¼ë‚˜, ë¹ˆìœ¼ë¡œ ë“±ë¡ëœ ì„¤ì • ìš”ì†Œë“¤ì´ í•„ìš”í•˜ê¸° ë•Œë¬¸ì— <code class="language-plaintext highlighter-rouge">@SpringBootTest</code>ë¡œ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í–ˆë‹¤. (@<code class="language-plaintext highlighter-rouge">DataJpaTest</code>ë¥¼ ì§„í–‰í•˜ë©´ì„œ í•´ë‹¹ configurationë§Œ ë¹ˆìœ¼ë¡œ ë“±ë¡í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ í…ŒìŠ¤íŠ¸í•´ë„ ë¬´ë°©í•˜ë‹¤.)</li>
  <li>datasourceë¥¼ ìë™ ì—°ê²°í•˜ì§€ ì•ŠëŠ” ì„¤ì • annotationì„ class ìƒë‹¨ì— ì¶”ê°€í•´ì•¼í•œë‹¤.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SpringBootTest</span>
<span class="nd">@AutoConfigureTestDatabase</span><span class="o">(</span><span class="n">replace</span> <span class="o">=</span> <span class="nc">Replace</span><span class="o">.</span><span class="na">NONE</span><span class="o">)</span> <span class="c1">//datasource ìë™ì—°ê²° x</span>
<span class="nd">@ActiveProfiles</span><span class="o">(</span><span class="s">"db"</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">MemberRepositoryTest</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">MemberRepository</span> <span class="n">memberRepository</span><span class="o">;</span>

    <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">"Master DBì— ë°ì´í„°ë¥¼ ì¶”ê°€í•˜ë©´ slave DBì—ë„ ë°˜ì˜ëœë‹¤."</span><span class="o">)</span>
    <span class="nd">@Test</span>
    <span class="kt">void</span> <span class="nf">addMember_Success</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// given</span>
        <span class="nc">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Member</span><span class="o">(</span><span class="s">"pickgit"</span><span class="o">,</span> <span class="mi">29</span><span class="o">);</span>
        <span class="n">memberRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">member</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">"Slave DBì—ì„œ ë°ì´í„°ë¥¼ ì¡°íšŒí•œë‹¤ - ì—¬ëŸ¬ë²ˆ ì¡°íšŒì‹œ slave dbë¥¼ ë²ˆê°ˆì•„ ì¡°íšŒí•œë‹¤."</span><span class="o">)</span>
    <span class="nd">@Test</span>
    <span class="kt">void</span> <span class="nf">findMember_Success</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// given</span>
        <span class="nc">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span> <span class="k">new</span> <span class="nc">Member</span><span class="o">(</span><span class="s">"pickgit"</span><span class="o">,</span> <span class="mi">29</span><span class="o">));</span>

        <span class="c1">// when</span>
        <span class="nc">Member</span> <span class="n">findMember1</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">member</span><span class="o">.</span><span class="na">getId</span><span class="o">())</span>
            <span class="o">.</span><span class="na">orElseThrow</span><span class="o">();</span>
        <span class="nc">Member</span> <span class="n">findMember2</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">member</span><span class="o">.</span><span class="na">getId</span><span class="o">())</span>
            <span class="o">.</span><span class="na">orElseThrow</span><span class="o">();</span>
        <span class="nc">Member</span> <span class="n">findMember3</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">member</span><span class="o">.</span><span class="na">getId</span><span class="o">())</span>
            <span class="o">.</span><span class="na">orElseThrow</span><span class="o">();</span>
        <span class="nc">Member</span> <span class="n">findMember4</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">member</span><span class="o">.</span><span class="na">getId</span><span class="o">())</span>
            <span class="o">.</span><span class="na">orElseThrow</span><span class="o">();</span> <span class="c1">//ì¡°íšŒ í•  ë•Œë§ˆë‹¤ ì‚¬ìš© DB ë¡œê±°ê°€ ë²ˆê°ˆì•„ì„œ ì°íŒë‹¤. </span>

        <span class="c1">// then</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">findMember1</span><span class="o">.</span><span class="na">getId</span><span class="o">()).</span><span class="na">isNotNull</span><span class="o">();</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">findMember1</span><span class="o">.</span><span class="na">getName</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">member</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">findMember1</span><span class="o">.</span><span class="na">getAge</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">member</span><span class="o">.</span><span class="na">getAge</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>ê²°ê³¼ í™”ë©´: 4ë²ˆì˜ ì¡°íšŒë¥¼ í• ë•Œ 1, 2 slave DBê°€ ë²ˆê°ˆì•„ ì„ íƒëœë‹¤.
    <p align="center"><img width="600" src="https://user-images.githubusercontent.com/63405904/133017838-c022df09-9d81-407e-9eac-7cd1e5af5de6.png" /></p>
  </li>
</ul>

<p><br />
<br /></p>

<h2 id="ë§ˆì£¼í•œ-ì´ìŠˆ">ë§ˆì£¼í•œ ì´ìŠˆ</h2>
<ul>
  <li>ymlì— properties ì…ë ¥ì‹œ ì˜¤íƒ€ ì£¼ì˜ !! (ìë™ì™„ì„± ì•ˆí•´ì£¼ê¸° ë•Œë¬¸ì— ì ‘ë¯¸ì‚¬ -s ë“±ì„ ì£¼ì˜í•´ì•¼í•¨)</li>
  <li>JPA ì •ë³´ ë˜í•œ ìë™ì—°ê²°í•  ë•Œ í•´ì£¼ëŠ” ì„¤ì •ë“¤ì„ í•˜ë‚˜ì”© ë‹¤ ëª…ì‹œí•´ì£¼ì–´ì•¼í•œë‹¤.</li>
  <li>ê¸°ì¡´ì— ddl ì „ëµì„ ì™¸ë¶€ì— ê¸°ì…í–ˆë‹¤ë©´ ì™œì¸ì§€ <code class="language-plaintext highlighter-rouge">hbm2ddl.auto=create</code>ë¡œ ì§€ì •í•´ì•¼ ì ìš©ì´ ë˜ì—ˆë‹¤.
    <ul>
      <li>í˜„ì¬ JPA properties
        <div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">spring</span><span class="pi">:</span>
<span class="na">jpa</span><span class="pi">:</span>
    <span class="na">properties</span><span class="pi">:</span>
    <span class="na">hibernate</span><span class="pi">:</span>
        <span class="na">show-sql</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">dialect</span><span class="pi">:</span> <span class="s">org.hibernate.dialect.MySQL8Dialect</span>
        <span class="na">format_sql</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">physical_naming_strategy</span><span class="pi">:</span> <span class="s">org.springframework.boot.orm.jpa.hibernate.SpringPhysicalNamingStrategy</span>
        <span class="na">hbm2ddl</span><span class="pi">:</span>
            <span class="na">auto</span><span class="pi">:</span> <span class="s">create</span>
    <span class="na">generate-ddl</span><span class="pi">:</span> <span class="no">true</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ul>

<p><br /></p>

<ul>
  <li>Slave DB ê¶Œí•œë¶€ì—¬ ë° bind address ì˜¤í”ˆ
    <ul>
      <li>Hostì˜ ì ‘ê·¼ì´ í—ˆê°€ë˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ì˜¤ë¥˜ê°€ ë‚  ë•ŒëŠ” ë‹¤ìŒ ë‘ê°€ì§€ë¥¼ í•´ì£¼ì–´ì•¼í•œë‹¤.
        <ol>
          <li>slave db ê³„ì • ìƒì„± ë° ê¶Œí•œ ë¶€ì—¬ (ìœ„ master dbì— í–ˆë˜ ì‘ì—…ê³¼ ë™ì¼)</li>
          <li><code class="language-plaintext highlighter-rouge">sudo vim /etc/mysql/mariadb.conf.d/50-server.cnf</code>ì— bind-address ë¶€ë¶„ <code class="language-plaintext highlighter-rouge">0.0.0.0</code> ìœ¼ë¡œ ì§€ì •</li>
        </ol>
      </li>
    </ul>

    <p align="center"><img width="600" src="https://user-images.githubusercontent.com/63405904/133018579-e3f0221f-a767-4203-9b07-18bc41fc7f7c.png" /></p>

    <ul>
      <li>ë‹¤ìŒ <a href="https://blog.naver.com/6116949/221991858055">ë§í¬</a>ë¥¼ ì°¸ê³ í•˜ì.</li>
    </ul>
  </li>
</ul>

<p><br /></p>

<ul>
  <li>Springboot JPAì— ëŒ€í•œ Hibernate Naming Strategy ì§€ì •
    <ul>
      <li>Springbootì—ì„œ ìë™ìœ¼ë¡œ ì§€ì •í•  ë•ŒëŠ” ì•Œì•„ì„œ ë„¤ì´ë°ì „ëµì´ ì„¤ì •ë˜ì—ˆìœ¼ë‚˜, ìˆ˜ë™ì„ í•  ë•ŒëŠ” ì´ ë¶€ë¶„ë„ ymlì— ê¸°ì…í•´ì£¼ì–´ì•¼ í•œë‹¤.</li>
      <li>ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ í…Œì´ë¸” ë° ì¹¼ëŸ¼ëª…ì´ ê·¸ëŒ€ë¡œ camel caseë¡œ ì…ë ¥ëœë‹¤.</li>
      <li>ymlì— ë‹¤ìŒ ì„¤ì •ì„ í•´ì„œ DBì—ì„œ underscoreë¡œ ì§€ì •ë˜ë„ë¡ ì „ëµì„ ì§€ì •í•œë‹¤. 
<code class="language-plaintext highlighter-rouge">physical_naming_strategy: org.springframework.boot.orm.jpa.hibernate.SpringPhysicalNamingStrategy</code></li>
    </ul>
  </li>
</ul>

<p><br />
<br /></p>

<h2 id="ë²ˆì™¸-ê¸°ì¡´-dbì˜-ë°ì´í„°-dump-í•˜ê¸°">ë²ˆì™¸) ê¸°ì¡´ DBì˜ ë°ì´í„° dump í•˜ê¸°</h2>
<ul>
  <li>ê¸°ì¡´ DBì— ìˆë˜ ë°ì´í„°ë“¤ì„ ìƒˆë¡œ ìƒì„±í•œ master dbì— ì˜®ê¸°ê¸° ìœ„í•´ <code class="language-plaintext highlighter-rouge">mySqldump</code>ë¥¼ ì‚¬ìš©í•´ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ í–ˆë‹¤.
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">$ </span>mysqldump <span class="nt">-u</span> <span class="o">[</span>ì‚¬ìš©ì ê³„ì •] <span class="nt">-p</span> <span class="o">[</span>ì›ë³¸ ë°ì´í„°ë² ì´ìŠ¤ëª…] <span class="o">&gt;</span> <span class="o">[</span>ìƒì„±í•  ë°±ì—… íŒŒì¼ëª…].sql <span class="c">#ë°±ì—… sql ìƒì„± </span>

  <span class="c">#scpë¥¼ ì‚¬ìš©í•´ ìƒˆë¡œìš´ databaseê°€ ìˆëŠ” ì„œë²„ë¡œ sql íŒŒì¼ ì´ë™</span>

  <span class="nv">$ </span>mysql <span class="nt">-u</span> <span class="o">[</span>ì‚¬ìš©ì ê³„ì •] <span class="nt">-p</span> <span class="o">[</span>ë³µì›í•  DB] &lt; <span class="o">[</span>ë°±ì—…ëœ DB].sql <span class="c">#sql íŒŒì¼ì„ ì‚¬ìš©í•´ ë°ì´í„° ë³µì› </span>
</code></pre></div>    </div>
  </li>
  <li>Master DBì—ë§Œ ì ìš©í•˜ë©´ slave DBì— ì•Œì•„ì„œ ì ìš©ì´ ëœë‹¤.</li>
</ul>

<p><br />
<br /></p>

<p><strong>[ì°¸ê³ ìë£Œ]</strong></p>
<ul>
  <li><a href="https://mycup.tistory.com/237">https://mycup.tistory.com/237</a></li>
  <li><a href="https://velog.io/@max9106/DB-Spring-Replication">https://velog.io/@max9106/DB-Spring-Replication</a></li>
  <li><a href="https://mangkyu.tistory.com/97">https://mangkyu.tistory.com/97</a></li>
  <li><a href="https://velog.io/@kyujonglee/Mysql-%EB%B0%B1%EC%97%85-%EB%A7%88%EC%9D%B4%EA%B7%B8%EB%A0%88%EC%9D%B4%EC%85%98">https://velog.io/@kyujonglee/Mysql-%EB%B0%B1%EC%97%85-%EB%A7%88%EC%9D%B4%EA%B7%B8%EB%A0%88%EC%9D%B4%EC%85%98</a></li>
</ul>

<p><br />
<br /></p>

<blockquote>
  <p>ë°±ì—”ë“œ ì½”ë‹¤ì…ë‹ˆë‹¤ ğŸ™Œ</p>
</blockquote>

      <div class="page-footer">
        <div class="page-share">
          <a href="https://twitter.com/intent/tweet?text=DB ë¦¬í”Œë¦¬ì¼€ì´ì…˜ ì ìš©ê¸°&url=https://2021-pick-git.github.io//db-replication/" title="Share on Twitter" rel="nofollow" target="_blank">Twitter</a>
          <a href="https://facebook.com/sharer.php?u=https://2021-pick-git.github.io//db-replication/" title="Share on Facebook" rel="nofollow" target="_blank">Facebook</a>
          <a href="https://plus.google.com/share?url=https://2021-pick-git.github.io//db-replication/" title="Share on Google+" rel="nofollow" target="_blank">Google+</a>
        </div>
        <div class="page-tag">
          
            <a href="/tags#ë°±ì—”ë“œ" class="tag">&#35; ë°±ì—”ë“œ</a>
          
            <a href="/tags#Database" class="tag">&#35; Database</a>
          
        </div>
      </div>
      <section class="comment-area">
  <div class="comment-wrapper">
    
  </div>
</section> <!-- End Comment Area -->

    </div> <!-- End Wrap Content -->
  </div> <!-- End Page Content -->

  <script src="https://utteranc.es/client.js"
        repo="2021-pick-git/pick-git-comments"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
  </script>
</article> <!-- End Article Page -->

</div>

  </div>
  
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', '', 'auto');
  ga('send', 'pageview');
</script> <!-- End Analytics -->

</body>
</html>
